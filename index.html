<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mini POS ‚Äì Tea Neko</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
    padding: 10px;
    background: #f2f2f2;
  }
  .box {
    max-width: 480px;
    margin: 0 auto;
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  h2, h3 { margin: 8px 0; }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 8px;
  }
  .menu-btn {
    padding: 14px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    background: #f0f0ff;
    transition: transform 0.08s ease, box-shadow 0.08s ease, background-color 0.08s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.12);
  }
  .menu-btn:active {
    transform: translateY(2px) scale(0.97);
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    background-color: #e0e0ff;
  }
  .menu-btn span {
    display: block;
    font-size: 13px;
    opacity: 0.8;
  }

  button {
    padding: 12px;
    width: 100%;
    font-size: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  .undo-btn   { background: #8e8e93; color: #fff; }
  .remove-btn { background: #ff9500; color: #fff; }
  .reset-btn  { background: #ff3b30; color: #fff; }
  .save-btn   { background: #5856d6; color: #fff; }
  .print-btn  { background: #34c759; color: #fff; }
  .revenue-btn{ background: #ffcc00; color:#000; }

  .button-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .button-row button {
    flex: 1;
  }

  ul {
    margin-top: 8px;
    padding-left: 18px;
    font-size: 15px;
    max-height: 220px;
    overflow-y: auto;
  }
  .summary {
    margin-top: 8px;
    padding: 10px;
    border-radius: 10px;
    background: #f8f8f8;
    font-size: 16px;
  }

  .size-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }
  .size-btn {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    background: #f8f8f8;
    font-size: 15px;
    cursor: pointer;
  }
  .size-btn.active {
    border-color: #0a84ff;
    background: #e4f0ff;
    font-weight: 600;
  }

  label { font-size: 14px; display: block; margin-top: 8px; }
  input {
    width: 100%;
    padding: 10px;
    margin-top: 4px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    outline: none;
  }
  input:focus { border-color: #0a84ff; }

  .history-box {
    max-width: 480px;
    margin: 12px auto 0;
    background: #fff;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    font-size: 14px;
  }
  .history-list {
    max-height: 160px;
    overflow-y: auto;
    padding-left: 16px;
  }
  .history-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .small-btn {
    padding: 8px;
    font-size: 13px;
    border-radius: 8px;
  }
  .btn-outline-danger {
    background: #fff5f5;
    border: 1px solid #ff3b30;
    color: #ff3b30;
  }
  .btn-outline-secondary {
    background: #f7f7f7;
    border: 1px solid #ccc;
    color: #333;
  }

  .change-ok  { color: #34c759; font-weight: 600; }
  .change-bad { color: #ff3b30; font-weight: 600; }
</style>
</head>
<body>

<div class="box">
  <h2>Mini POS ‚Äì Tea Neko</h2>

  <!-- Size -->
  <h3>Size</h3>
  <div class="size-row">
    <button id="sizeM" class="size-btn active" onclick="setSize('M')">Size M</button>
    <button id="sizeL" class="size-btn" onclick="setSize('L')">Size L (+5.000)</button>
  </div>

  <!-- Menu -->
  <h3>Menu</h3>
  <div id="menuContainer"></div>

  <!-- N√∫t ch·ª©c nƒÉng ch√≠nh -->
  <div class="button-row">
    <button class="undo-btn"   onclick="undo()">‚Ü©Ô∏è Ho√†n t√°c</button>
    <button class="remove-btn" onclick="removeLast()">üóë X√≥a d√≤ng cu·ªëi</button>
  </div>
  <div class="button-row">
    <button class="reset-btn"  onclick="resetPOS()">‚ùå X√≥a ƒë∆°n hi·ªán t·∫°i</button>
    <button class="save-btn"   onclick="saveOrder()">üíæ L∆∞u ƒë∆°n</button>
  </div>
  <div class="button-row">
    <button class="print-btn"   onclick="printBill()">üñ® In Bill</button>
    <button class="revenue-btn" onclick="calcRevenue()">üí∞ T·ªïng doanh thu</button>
  </div>

  <!-- ƒê∆°n hi·ªán t·∫°i -->
  <h3>ƒê∆°n hi·ªán t·∫°i:</h3>
  <ul id="list"></ul>

  <div class="summary">
    <strong>T·ªïng:</strong> <span id="total">0</span> VND
  </div>

  <label>Kh√°ch ƒë∆∞a (VND)</label>
  <input
    type="number"
    id="cash"
    placeholder="Nh·∫≠p s·ªë, v√≠ d·ª• 25 = 25.000"
    oninput="updateChange()"
    onblur="autoScaleCash()"
  >

  <div class="summary">
    <div id="changeText">Ti·ªÅn th·ªëi l·∫°i: 0 VND</div>
  </div>
</div>

<!-- L·ªãch s·ª≠ ƒë∆°n -->
<div class="history-box">
  <h3>L·ªãch s·ª≠ ƒë∆°n</h3>
  <ul id="historyList" class="history-list"></ul>
  <div class="history-actions">
    <button class="small-btn btn-outline-danger" onclick="clearHistory()">üóë X√≥a l·ªãch s·ª≠</button>
    <button class="small-btn btn-outline-secondary" onclick="restoreLastDeleted()">‚Ü©Ô∏è Kh√¥i ph·ª•c 1 ƒë∆°n ƒë√£ x√≥a</button>
  </div>
</div>

<!-- Th√πng r√°c -->
<div class="history-box">
  <h3>L·ªãch s·ª≠ ƒë√£ x√≥a (Th√πng r√°c)</h3>
  <ul id="deletedHistoryList" class="history-list"></ul>
</div>

<script>
const MENU = [
  { name: "Matcha Latte",       price: 25000, category: "LATTE" },
  { name: "Coffee",             price: 25000, category: "COFFEE" },
  { name: "Tr√† s·ªØa tr√¢n ch√¢u",  price: 30000, category: "TR√Ä S·ªÆA" },
  { name: "H·ªìng tr√† s·ªØa",       price: 28000, category: "TR√Ä S·ªÆA" },
  { name: "Cacao ƒë√°",           price: 22000, category: "ƒê·ªí U·ªêNG" },
  { name: "B·∫°c x·ªâu",            price: 20000, category: "COFFEE" }
];

let items = [];             // ƒë∆°n hi·ªán t·∫°i: {name, price, size, qty}
let total = 0;
let stateStack = [];
let currentSize = 'M';

let nextOrderId = 1;
let historyOrders = [];     // {id, time: Date, items, total}
let deletedOrders = [];     // t∆∞∆°ng t·ª±, nh∆∞ng ƒë√£ x√≥a

function formatVND(n){ return Number(n).toLocaleString('vi-VN'); }

function clearCurrentOrder(){
  items = [];
  total = 0;
  stateStack = [];
  document.getElementById('list').innerHTML = '';
  document.getElementById('total').textContent = '0';
  document.getElementById('cash').value = '';
  document.getElementById('changeText').textContent = 'Ti·ªÅn th·ªëi l·∫°i: 0 VND';
}

function pushState(){
  stateStack.push({
    items: JSON.parse(JSON.stringify(items)),
    total: total
  });
  if(stateStack.length > 50) stateStack.shift();
}

function undo(){
  if(!stateStack.length) return;
  const prev = stateStack.pop();
  items = prev.items;
  total = prev.total;
  recalcAndRender();
}

function setSize(s){
  currentSize = s;
  document.getElementById('sizeM').classList.toggle('active', s==='M');
  document.getElementById('sizeL').classList.toggle('active', s==='L');
}

function renderMenu(){
  const box = document.getElementById('menuContainer');
  box.innerHTML = '';
  const groups = {};
  MENU.forEach(m=>{
    if(!groups[m.category]) groups[m.category]=[];
    groups[m.category].push(m);
  });

  Object.keys(groups).forEach(cat=>{
    const h=document.createElement('h3');
    h.textContent = cat;
    box.appendChild(h);

    const g=document.createElement('div');
    g.className='menu-grid';

    groups[cat].forEach(item=>{
      const btn=document.createElement('button');
      btn.className='menu-btn';
      btn.onclick=()=>addPreset(item.name,item.price);
      btn.innerHTML = `${item.name}<span>${formatVND(item.price)} VND (M)</span>`;
      g.appendChild(btn);
    });

    box.appendChild(g);
  });
}

function recalcAndRender(){
  const list = document.getElementById('list');
  list.innerHTML='';
  total=0;

  items.forEach(i=>{
    const line = i.price*i.qty;
    total+=line;
    const li=document.createElement('li');
    li.textContent=`${i.qty} x ${i.name} (${i.size}) - ${formatVND(line)} VND`;
    list.appendChild(li);
  });

  document.getElementById('total').textContent=formatVND(total);
  updateChange();
}

function addPreset(name, base){
  pushState();
  const price = base + (currentSize==='L'?5000:0);
  const idx = items.findIndex(i=>i.name===name && i.size===currentSize);

  if(idx>=0) items[idx].qty++;
  else items.push({name,price,size:currentSize,qty:1});

  recalcAndRender();
}

function removeLast(){
  if(!items.length) return;
  pushState();
  items.pop();
  recalcAndRender();
}

function resetPOS(){
  if(!items.length) return;
  if(!confirm("X√≥a to√†n b·ªô m√≥n trong ƒë∆°n hi·ªán t·∫°i?")) return;
  pushState();
  clearCurrentOrder();
}

function autoScaleCash(){
  const input = document.getElementById('cash');
  let v = Number(input.value || 0);
  if (v > 0 && v < 1000) {
    v = v * 1000;
    input.value = v;
  }
  updateChange();
}

function updateChange(){
  const input = document.getElementById('cash');
  let cash = Number(input.value || 0);
  let diff = cash-total;
  const out = document.getElementById('changeText');

  if(total===0){ out.textContent='Ti·ªÅn th·ªëi l·∫°i: 0 VND'; return; }
  if(cash === 0){ out.textContent='Ti·ªÅn th·ªëi l·∫°i: 0 VND'; return; }

  if(diff>=0) out.innerHTML=`<span class="change-ok">Th·ªëi l·∫°i: ${formatVND(diff)} VND</span>`;
  else out.innerHTML=`<span class="change-bad">Thi·∫øu: ${formatVND(-diff)} VND</span>`;
}

// ----- L·ªãch s·ª≠ & th√πng r√°c -----

function createOrderFromCurrent(){
  return {
    id: nextOrderId++,
    time: new Date(),
    items: JSON.parse(JSON.stringify(items)),
    total: total
  };
}

function renderHistoryLists(){
  // L·ªãch s·ª≠ ch√≠nh
  const historyList = document.getElementById('historyList');
  historyList.innerHTML = '';
  // hi·ªÉn th·ªã m·ªõi nh·∫•t l√™n tr√™n
  [...historyOrders].slice().reverse().forEach(order=>{
    const li = document.createElement('li');
    const timeStr = order.time.toLocaleTimeString('vi-VN',{hour12:false});
    const itemText = order.items.map(i=>`${i.qty}x ${i.name} (${i.size})`).join(", ");
    li.textContent =
      `ƒê∆°n #${order.id} ‚Äì ${timeStr} ‚Äì [${itemText}] ‚Äì T·ªïng: ${formatVND(order.total)} VND`;
    historyList.appendChild(li);
  });

  // Th√πng r√°c
  const deletedList = document.getElementById('deletedHistoryList');
  deletedList.innerHTML = '';
  [...deletedOrders].slice().reverse().forEach(order=>{
    const li = document.createElement('li');
    const timeStr = order.time.toLocaleTimeString('vi-VN',{hour12:false});
    const itemText = order.items.map(i=>`${i.qty}x ${i.name} (${i.size})`).join(", ");
    li.textContent =
      `ƒê∆°n #${order.id} ‚Äì ${timeStr} ‚Äì [${itemText}] ‚Äì T·ªïng: ${formatVND(order.total)} VND (ƒë√£ x√≥a)`;
    deletedList.appendChild(li);
  });
}

function saveOrder(showAlert = true){
  if(!items.length){
    if(showAlert) alert("Ch∆∞a c√≥ m√≥n trong ƒë∆°n hi·ªán t·∫°i.");
    return;
  }
  const order = createOrderFromCurrent();
  historyOrders.push(order);
  renderHistoryLists();
  if(showAlert) alert("ƒê√£ l∆∞u ƒë∆°n #" + order.id);
  clearCurrentOrder();
}

function clearHistory(){
  if(!historyOrders.length){
    alert("Kh√¥ng c√≥ ƒë∆°n n√†o trong l·ªãch s·ª≠ ƒë·ªÉ x√≥a.");
    return;
  }
  if(!confirm("Chuy·ªÉn to√†n b·ªô l·ªãch s·ª≠ ƒë∆°n v√†o Th√πng r√°c?")) return;
  // chuy·ªÉn t·∫•t c·∫£ sang th√πng r√°c
  deletedOrders = deletedOrders.concat(historyOrders);
  historyOrders = [];
  renderHistoryLists();
  alert("ƒê√£ chuy·ªÉn to√†n b·ªô l·ªãch s·ª≠ v√†o Th√πng r√°c.");
}

function restoreLastDeleted(){
  if(!deletedOrders.length){
    alert("Kh√¥ng c√≥ ƒë∆°n n√†o trong Th√πng r√°c.");
    return;
  }
  const order = deletedOrders.pop(); // ƒë∆°n x√≥a g·∫ßn nh·∫•t
  historyOrders.push(order);
  renderHistoryLists();
  alert("ƒê√£ kh√¥i ph·ª•c ƒë∆°n #" + order.id + " t·ª´ Th√πng r√°c.");
}

function calcRevenue(){
  const sum = historyOrders.reduce((acc,o)=>acc + o.total, 0);
  alert(`üí∞ T·ªïng doanh thu: ${formatVND(sum)} VND\nüßæ S·ªë ƒë∆°n: ${historyOrders.length}`);
}

// ----- In bill -----

function printBill(){
  if(!items.length){
    alert("Ch∆∞a c√≥ m√≥n trong ƒë∆°n ƒë·ªÉ in.");
    return;
  }

  // x·ª≠ l√Ω ti·ªÅn kh√°ch ƒë∆∞a: n·∫øu < 1000 th√¨ t·ª± *1000
  const cashInput = document.getElementById('cash');
  let rawCash = Number(cashInput.value || 0);
  if (rawCash > 0 && rawCash < 1000) {
    rawCash = rawCash * 1000;
    cashInput.value = rawCash;
  }
  let cash = rawCash;

  // snapshot + ƒë∆∞a v√†o l·ªãch s·ª≠
  const order = createOrderFromCurrent();
  historyOrders.push(order);
  renderHistoryLists();

  const snapshotItems = order.items;
  const snapshotTotal = order.total;
  const diff = cash - snapshotTotal;
  const timeFull = order.time.toLocaleString('vi-VN',{hour12:false});

  // reset ƒë∆°n hi·ªán t·∫°i
  clearCurrentOrder();

  // build d√≤ng m√≥n cho bill
  let rows = "";
  snapshotItems.forEach(i=>{
    const line = i.price * i.qty;
    rows += `
    <tr>
      <td>${i.name}</td>
      <td>${i.size}</td>
      <td style="text-align:right;">${i.qty}</td>
      <td style="text-align:right;">${formatVND(line)}</td>
    </tr>`;
  });

  const win = window.open("", "_blank", "width=380,height=700");
  win.document.write(`
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  body { font-family:-apple-system,Arial; font-size:12px; padding:4px; }
  h1 { text-align:center; margin:0; font-size:20px; }
  .meta { font-size:10px; text-align:right; margin-top:-2px; line-height:1.2; }
  table { width:100%; border-collapse:collapse; font-size:12px; }
  th,td { padding:3px 0; border-bottom:1px dashed #999; }
  hr { border:none; border-top:1px dashed #999; margin:4px 0; }
  .footer { text-align:center; margin-top:8px; }
</style>
</head>
<body>

<h1>Tea Neko</h1>
<div class="meta">
  ƒê/c: Hai B√† Tr∆∞ng, Ch∆∞ S√™, Gia Lai<br>
  SƒêT: 0123456789
</div>

<div>Th·ªùi gian: ${timeFull}</div>
<hr>

<table>
  <tr>
    <th>M√≥n</th>
    <th>Sz</th>
    <th style="text-align:right;">SL</th>
    <th style="text-align:right;">Ti·ªÅn</th>
  </tr>
  ${rows}
</table>

<hr>
<div><b>T·ªïng:</b> ${formatVND(snapshotTotal)} VND</div>
<div><b>Kh√°ch ƒë∆∞a:</b> ${formatVND(cash)} VND</div>
<div><b>K·∫øt qu·∫£:</b> ${
    diff>=0 ? "Th·ªëi l·∫°i: " + formatVND(diff) : "Thi·∫øu: " + formatVND(-diff)
}</div>

<div class="footer">C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko!</div>

</body>
</html>
  `);
  win.print();
}

renderMenu();
</script>

</body>
</html>
