<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Mini POS ‚Äì Tea Neko V6 (Realtime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: #111;
      color: #f5f5f5;
    }

    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 10px 12px 6px;
      text-align: center;
      background: #181818;
      box-shadow: 0 1px 3px rgba(0,0,0,0.6);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    header .sub {
      margin-top: 2px;
      font-size: 11px;
      color: #aaa;
    }

    /* TAB BAR */
    .tab-bar {
      display: flex;
      padding: 8px 8px 4px;
      gap: 8px;
      background: #181818;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .tab-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 12px;
      background: #232323;
      color: #ddd;
      font-size: 13px;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      border: 1px solid #2f2f2f;
      transition: transform 0.07s ease, box-shadow 0.08s ease, background 0.08s ease, color 0.08s ease, border-color 0.08s ease;
      user-select: none;
    }

    .tab-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 0 0 1px rgba(10,132,255,0.4);
    }

    .tab-btn.active {
      background: #0a84ff;
      color: #fff;
      border-color: #0a84ff;
      box-shadow: 0 0 0 1px rgba(10,132,255,0.6);
    }

    main {
      flex: 1;
      padding: 8px;
    }

    .page {
      display: none;
      padding-bottom: 24px;
    }

    .page.active {
      display: block;
    }

    .box {
      background: #181818;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      margin-bottom: 12px;
    }

    h2 {
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
    }

    .menu-section-title {
      margin-top: 2px;
      font-size: 13px;
      font-weight: 600;
      border-left: 3px solid #0a84ff;
      padding-left: 6px;
      color: #ddd;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .menu-item {
      border-radius: 12px;
      padding: 8px;
      background: #242424;
      cursor: pointer;
      border: 1px solid #333;
      font-size: 13px;
      transition: transform 0.06s ease, box-shadow 0.08s ease, background 0.08s ease, border-color 0.08s ease;
    }

    .menu-item:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 1px 3px rgba(0,0,0,0.6) inset;
      background: #2d3b4f;
      border-color: #0a84ff;
    }

    .menu-item-name {
      font-weight: 600;
      font-size: 13px;
    }

    .menu-item-price {
      font-size: 11px;
      color: #bbb;
      margin-top: 2px;
    }

    .size-row,
    .cash-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
      font-size: 13px;
    }

    .size-row span,
    .cash-row span {
      width: 80px;
      font-size: 12px;
      color: #ccc;
    }

    .size-row button {
      flex: 1;
      padding: 6px 0;
      border-radius: 999px;
      border: 1px solid #333;
      background: #232323;
      cursor: pointer;
      font-size: 13px;
      color: #ddd;
      transition: background 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease, color 0.08s ease;
    }

    .size-row button.active {
      background: #0a84ff;
      color: #fff;
      border-color: #0a84ff;
      box-shadow: 0 0 0 1px rgba(10,132,255,0.6);
    }

    .cash-row input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #111;
      color: #f5f5f5;
      font-size: 13px;
    }

    .btn-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      transition: opacity 0.08s ease, transform 0.06s ease, box-shadow 0.08s ease;
    }

    .btn:active {
      opacity: 0.9;
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0,0,0,0.7) inset;
    }

    .btn-undo { background: #636366; }
    .btn-clear { background: #ff453a; }
    .btn-save { background: #5856d6; }
    .btn-print { background: #32d74b; }
    .btn-small {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
    }

    .list-box-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    ul {
      margin: 4px 0 0;
      padding-left: 18px;
      max-height: 220px;
      overflow-y: auto;
      font-size: 12px;
    }

    .summary {
      margin-top: 6px;
      font-size: 13px;
    }

    .summary strong {
      font-size: 14px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .history-list {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 4px;
      font-size: 12px;
    }

    .history-item {
      border-bottom: 1px dashed #333;
      padding: 4px 0;
      display: flex;
      gap: 6px;
      align-items: flex-start;
    }

    .history-main {
      flex: 1;
    }

    .history-meta {
      font-size: 11px;
      color: #aaa;
      margin-bottom: 2px;
    }

    .history-delete-btn {
      border: none;
      background: #ff3b30;
      color: #fff;
      border-radius: 999px;
      width: 22px;
      height: 22px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-left: 4px;
      margin-top: 3px;
    }

    .history-total {
      margin-top: 4px;
      font-weight: 600;
      font-size: 13px;
    }

    .note {
      font-size: 11px;
      color: #aaa;
      margin-top: 4px;
    }

    .footer {
      text-align: center;
      font-size: 11px;
      color: #888;
      padding-bottom: 10px;
    }

    /* REVENUE CARDS */
    .revenue-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 6px;
    }

    .revenue-card {
      padding: 10px;
      border-radius: 12px;
      background: #232323;
      border: 1px solid #333;
      font-size: 13px;
    }

    .revenue-card-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .revenue-card-value {
      font-size: 16px;
      font-weight: 700;
      margin-top: 2px;
    }

    .revenue-note {
      font-size: 11px;
      margin-top: 2px;
      color: #aaa;
    }

    .search-row {
      margin: 6px 0 8px;
    }

    .search-row input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #111;
      color: #f5f5f5;
      font-size: 12px;
    }

    .deleted-title {
      margin-top: 12px;
      font-size: 13px;
      font-weight: 600;
      border-left: 3px solid #ff9f0a;
      padding-left: 6px;
      color: #ffcc80;
    }

    .deleted-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 4px;
      font-size: 12px;
    }
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
<div class="app-shell">
  <header>
    <h1>Mini POS ‚Äì Tea Neko</h1>
    <div class="sub">Realtime ¬∑ Supabase ¬∑ POS mini</div>
  </header>

  <!-- TAB BAR -->
  <div class="tab-bar">
    <div class="tab-btn active" data-page="page-pos">POS</div>
    <div class="tab-btn" data-page="page-revenue">Doanh thu</div>
    <div class="tab-btn" data-page="page-history">L·ªãch s·ª≠</div>
  </div>

  <main>
    <!-- PAGE 1 ‚Äì POS -->
    <section id="page-pos" class="page active">
      <div class="box">
        <h2>G·ªçi m√≥n</h2>
        <div class="menu-section-title">LATTE / COFFEE / TR√Ä S·ªÆA</div>
        <div class="menu-grid" id="menuMain"></div>

        <div class="menu-section-title" style="margin-top:10px;">T√πy ch·ªçn</div>
        <div class="size-row">
          <span>Size:</span>
          <button id="sizeM" class="active">Size M</button>
          <button id="sizeL">Size L (+5.000)</button>
        </div>

        <div class="cash-row">
          <span>Kh√°ch ƒë∆∞a (ngh√¨n):</span>
          <input id="cashInput" type="number" min="0" placeholder="VD: 50" />
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <button class="btn btn-undo" id="btnUndo">‚Ü© Ho√†n t√°c</button>
          <button class="btn btn-clear" id="btnClear">X√≥a t·∫•t c·∫£</button>
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn btn-save" id="btnSave">üíæ L∆∞u ƒë∆°n</button>
          <button class="btn btn-print" id="btnPrint">üßæ L∆∞u + In bill</button>
        </div>

        <div class="list-box" style="margin-top:10px;">
          <div class="list-box-title">ƒê∆°n hi·ªán t·∫°i</div>
          <ul id="currentList"></ul>
          <div class="summary" id="currentSummary">T·ªïng: 0 VND</div>
          <div class="summary" id="cashSummary"></div>
        </div>
      </div>

      <div class="box">
        <div class="history-header">
          <span><strong>L·ªãch s·ª≠ ƒë∆°n (Realtime)</strong></span>
          <button class="btn btn-undo btn-small" id="btnRefreshHistory">‚Üª T·∫£i l·∫°i</button>
        </div>
        <div class="history-list" id="historyList"></div>
        <div class="history-total" id="historyTotal">T·ªïng doanh thu: 0 VND</div>
        <div class="note">
          ‚Ä¢ Xo√° ƒë∆°n sai b·∫±ng n√∫t ƒë·ªè ‚ùå ‚Äì ƒë∆°n s·∫Ω chuy·ªÉn sang m·ª•c ‚Äúƒê∆°n ƒë√£ xo√°‚Äù trong tab L·ªãch s·ª≠.<br />
          ‚Ä¢ Khi 2 m√°y c√πng m·ªü, hu·ª∑/l∆∞u ƒë∆°n s·∫Ω ƒë·ªìng b·ªô realtime.
        </div>
      </div>

      <div class="footer">C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko üíú</div>
    </section>

    <!-- PAGE 2 ‚Äì REVENUE -->
    <section id="page-revenue" class="page">
      <div class="box">
        <h2>T·ªïng doanh thu</h2>
        <div class="revenue-grid">
          <div class="revenue-card">
            <div class="revenue-card-title">H√¥m nay</div>
            <div class="revenue-card-value" id="revDay">0 VND</div>
            <div class="revenue-note" id="revDayCount">0 ƒë∆°n</div>
          </div>
          <div class="revenue-card">
            <div class="revenue-card-title">7 ng√†y g·∫ßn nh·∫•t</div>
            <div class="revenue-card-value" id="revWeek">0 VND</div>
            <div class="revenue-note" id="revWeekCount">0 ƒë∆°n</div>
          </div>
          <div class="revenue-card">
            <div class="revenue-card-title">Th√°ng n√†y</div>
            <div class="revenue-card-value" id="revMonth">0 VND</div>
            <div class="revenue-note" id="revMonthCount">0 ƒë∆°n</div>
          </div>
        </div>
        <div class="note">
          * Doanh thu ch·ªâ t√≠nh c√°c ƒë∆°n c√≤n trong b·∫£ng <strong>orders</strong> (ƒë√£ xo√° th√¨ kh√¥ng t√≠nh).
        </div>
      </div>
    </section>

    <!-- PAGE 3 ‚Äì HISTORY -->
    <section id="page-history" class="page">
      <div class="box">
        <h2>L·ªãch s·ª≠ ƒë∆°n & ƒê∆°n ƒë√£ xo√°</h2>

        <div class="search-row">
          <input id="searchOrder" placeholder="T√¨m theo m√£ ƒë∆°n (#0001, #1234, ...)" />
        </div>

        <div class="history-list" id="fullHistoryList"></div>

        <div class="deleted-title">ƒê∆°n ƒë√£ xo√° (ch·ªâ xem, kh√¥ng xo√° ti·∫øp)</div>
        <div class="deleted-list" id="deletedList"></div>
      </div>
    </section>
  </main>
</div>

<script>
  // ==================== SUPABASE CONFIG ====================
  const SUPABASE_URL = "https://kcrchwedlrettpkucoct.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw";
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ==================== DATA & STATE ====================
  const MENU = [
    { name: "Matcha Latte",      price: 25000 },
    { name: "Coffee",            price: 25000 },
    { name: "Tr√† s·ªØa tr√¢n ch√¢u", price: 30000 },
    { name: "H·ªìng tr√† s·ªØa",      price: 28000 },
    { name: "Cacao ƒë√°",          price: 22000 },
    { name: "B·∫°c x·ªâu",           price: 20000 }
  ];

  let currentOrder = [];
  let currentSize = "M";
  let historyOrders = [];
  let deletedOrders = [];

  // ==================== DOM SHORTCUTS ====================
  const tabButtons = document.querySelectorAll(".tab-btn");
  const pages = document.querySelectorAll(".page");

  const menuMain = document.getElementById("menuMain");
  const sizeMBtn = document.getElementById("sizeM");
  const sizeLBtn = document.getElementById("sizeL");
  const cashInput = document.getElementById("cashInput");
  const currentList = document.getElementById("currentList");
  const currentSummary = document.getElementById("currentSummary");
  const cashSummary = document.getElementById("cashSummary");
  const btnUndo = document.getElementById("btnUndo");
  const btnClear = document.getElementById("btnClear");
  const btnSave = document.getElementById("btnSave");
  const btnPrint = document.getElementById("btnPrint");
  const btnRefreshHistory = document.getElementById("btnRefreshHistory");
  const historyList = document.getElementById("historyList");
  const historyTotal = document.getElementById("historyTotal");
  const fullHistoryList = document.getElementById("fullHistoryList");
  const deletedList = document.getElementById("deletedList");
  const searchOrderInput = document.getElementById("searchOrder");

  // Revenue DOM
  const revDayEl = document.getElementById("revDay");
  const revWeekEl = document.getElementById("revWeek");
  const revMonthEl = document.getElementById("revMonth");
  const revDayCountEl = document.getElementById("revDayCount");
  const revWeekCountEl = document.getElementById("revWeekCount");
  const revMonthCountEl = document.getElementById("revMonthCount");

  function formatVND(x) {
    return (x || 0).toLocaleString("vi-VN") + " VND";
  }

  function formatOrderCode(code) {
    if (!code) return "";
    return "#" + String(code).padStart(4, "0");
  }

  // ==================== TAB HANDLING ====================
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const pageId = btn.dataset.page;
      tabButtons.forEach(b => b.classList.toggle("active", b === btn));
      pages.forEach(p => p.classList.toggle("active", p.id === pageId));
    });
  });

  // ==================== MENU & CURRENT ORDER ====================
  function renderMenu() {
    MENU.forEach(item => {
      const div = document.createElement("div");
      div.className = "menu-item";
      div.innerHTML = `
        <div class="menu-item-name">${item.name}</div>
        <div class="menu-item-price">${item.price.toLocaleString("vi-VN")} VND (Size M)</div>
      `;
      div.addEventListener("click", () => addItem(item));
      menuMain.appendChild(div);
    });
  }

  function addItem(item) {
    const isL = currentSize === "L";
    const unitPrice = item.price + (isL ? 5000 : 0);

    // M·ªói l·∫ßn b·∫•m t·ª± +1 s·ªë l∆∞·ª£ng
    const existing = currentOrder.find(
      line => line.name === item.name && line.size === currentSize
    );

    if (existing) {
      existing.qty += 1;
      existing.lineTotal = existing.qty * existing.unitPrice;
    } else {
      currentOrder.push({
        name: item.name,
        size: currentSize,
        qty: 1,
        unitPrice,
        lineTotal: unitPrice
      });
    }

    renderCurrentOrder();
  }

  function renderCurrentOrder() {
    currentList.innerHTML = "";
    let total = 0;

    currentOrder.forEach(line => {
      total += line.lineTotal;
      const li = document.createElement("li");
      li.textContent = `${line.qty} x ${line.name} (Size ${line.size}) ‚Äì ${formatVND(line.lineTotal)}`;
      currentList.appendChild(li);
    });

    currentSummary.innerHTML = `<strong>T·ªïng:</strong> ${formatVND(total)}`;

    const cashThousand = parseInt(cashInput.value || "0", 10);
    const cash = cashThousand * 1000;
    if (cash > 0) {
      const diff = cash - total;
      cashSummary.textContent =
        `Kh√°ch ƒë∆∞a: ${formatVND(cash)} ‚Äì ` +
        `Ti·ªÅn tr·∫£ l·∫°i kh√°ch: ${formatVND(Math.max(diff, 0))}`;
    } else {
      cashSummary.textContent = "";
    }
  }

  function clearCurrentOrder() {
    currentOrder = [];
    cashInput.value = "";
    renderCurrentOrder();
  }

  // ==================== HISTORY (ORDERS) ====================
  async function loadHistory() {
    const { data, error } = await supa
      .from("orders")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(500);

    if (error) {
      console.error(error);
      alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ ƒë∆°n (orders).");
      return;
    }

    historyOrders = data || [];
    renderHistory();
    calcRevenue();
    renderFullHistory(); // tab L·ªãch s·ª≠
  }

  async function loadDeletedHistory() {
    const { data, error } = await supa
      .from("deleted_orders")
      .select("*")
      .order("deleted_at", { ascending: false })
      .limit(500);

    if (error) {
      console.error(error);
      return;
    }
    deletedOrders = data || [];
    renderDeletedHistory();
  }

  function renderHistory() {
    historyList.innerHTML = "";
    let revenue = 0;

    historyOrders.forEach(order => {
      revenue += order.total || 0;

      const div = document.createElement("div");
      div.className = "history-item";

      const metaTime = order.created_at
        ? new Date(order.created_at).toLocaleString("vi-VN")
        : "";

      const itemsText = (order.items || [])
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ");

      const main = document.createElement("div");
      main.className = "history-main";
      main.innerHTML = `
        <div class="history-meta">
          ${formatOrderCode(order.order_code)} ¬∑ ${metaTime}
        </div>
        <div>${itemsText}</div>
        <div><strong>${formatVND(order.total || 0)}</strong></div>
      `;

      const btn = document.createElement("button");
      btn.className = "history-delete-btn";
      btn.textContent = "‚úï";
      btn.title = "Xo√° ƒë∆°n kh·ªèi l·ªãch s·ª≠ (chuy·ªÉn sang ƒê∆°n ƒë√£ xo√°)";
      btn.addEventListener("click", () => handleDeleteOrder(order));

      div.appendChild(main);
      div.appendChild(btn);
      historyList.appendChild(div);
    });

    historyTotal.textContent = `T·ªïng doanh thu: ${formatVND(revenue)}`;
  }

  function renderFullHistory() {
    fullHistoryList.innerHTML = "";
    const keyword = searchOrderInput.value.trim().replace("#", "");

    (historyOrders || []).forEach(order => {
      if (keyword) {
        const codeStr = String(order.order_code || "").padStart(4, "0");
        if (!codeStr.includes(keyword)) return;
      }

      const div = document.createElement("div");
      div.className = "history-item";

      const metaTime = order.created_at
        ? new Date(order.created_at).toLocaleString("vi-VN")
        : "";

      const itemsText = (order.items || [])
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ");

      const main = document.createElement("div");
      main.className = "history-main";
      main.innerHTML = `
        <div class="history-meta">
          ${formatOrderCode(order.order_code)} ¬∑ ${metaTime}
        </div>
        <div>${itemsText}</div>
        <div><strong>${formatVND(order.total || 0)}</strong></div>
      `;

      const btn = document.createElement("button");
      btn.className = "history-delete-btn";
      btn.textContent = "‚úï";
      btn.title = "Xo√° ƒë∆°n (chuy·ªÉn sang ƒê∆°n ƒë√£ xo√°)";
      btn.addEventListener("click", () => handleDeleteOrder(order));

      div.appendChild(main);
      div.appendChild(btn);
      fullHistoryList.appendChild(div);
    });
  }

  function renderDeletedHistory() {
    deletedList.innerHTML = "";

    (deletedOrders || []).forEach(order => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px dashed #333";
      div.style.padding = "4px 0";

      const timeStr = order.deleted_at
        ? new Date(order.deleted_at).toLocaleString("vi-VN")
        : "";

      const itemsText = (order.items || [])
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ");

      div.innerHTML = `
        <div class="history-meta">
          ${formatOrderCode(order.order_code)} ¬∑ xo√° l√∫c ${timeStr}
        </div>
        <div>${itemsText}</div>
        <div><strong>${formatVND(order.total || 0)}</strong></div>
      `;

      deletedList.appendChild(div);
    });
  }

  // ==================== SAVE & DELETE ORDERS ====================
  async function getNextOrderCode() {
    const { data, error } = await supa
      .from("orders")
      .select("order_code")
      .order("created_at", { ascending: false })
      .limit(1);

    if (error) {
      console.error(error);
      return 1;
    }

    const last = data && data[0];
    if (!last || !last.order_code) return 1;

    const lastNum = parseInt(String(last.order_code).replace(/\D/g, ""), 10);
    if (Number.isNaN(lastNum)) return 1;
    return lastNum + 1;
  }

  async function saveOrder(printAfter) {
    if (!currentOrder.length) {
      alert("ƒê∆°n hi·ªán t·∫°i ƒëang tr·ªëng.");
      return;
    }

    const total = currentOrder.reduce((s, l) => s + l.lineTotal, 0);
    const cashThousand = parseInt(cashInput.value || "0", 10);
    const cash = cashThousand * 1000;
    const change = cash > 0 ? cash - total : null;

    const nextCode = await getNextOrderCode();

    const payload = {
      order_code: nextCode,
      items: currentOrder,
      total,
      cash_given: cash || null,
      change
    };

    const { data, error } = await supa
      .from("orders")
      .insert([payload])
      .select()
      .single();

    if (error) {
      console.error(error);
      alert("L∆∞u ƒë∆°n l√™n Supabase th·∫•t b·∫°i.");
      return;
    }

    // C·∫≠p nh·∫≠t local ngay cho m∆∞·ª£t (realtime v·∫´n s·∫Ω b·∫Øn DELETE/INSERT sau)
    historyOrders.unshift(data);
    renderHistory();
    renderFullHistory();
    calcRevenue();

    if (printAfter) {
      printBill(data);
    }

    clearCurrentOrder();
  }

  async function handleDeleteOrder(order) {
    if (!order || !order.id) return;

    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ƒë∆°n ${formatOrderCode(order.order_code)}?\nƒê∆°n s·∫Ω chuy·ªÉn sang m·ª•c "ƒê∆°n ƒë√£ xo√°".`)) {
      return;
    }

    // 1) ch√©p sang b·∫£ng deleted_orders
    const deletedPayload = {
      original_id: order.id,
      order_code: order.order_code,
      items: order.items,
      total: order.total,
      cash_given: order.cash_given,
      change: order.change
    };

    const { error: insertErr } = await supa
      .from("deleted_orders")
      .insert([deletedPayload]);

    if (insertErr) {
      console.error(insertErr);
      alert("Kh√¥ng th·ªÉ ch√©p sang b·∫£ng deleted_orders.");
      return;
    }

    // 2) xo√° kh·ªèi b·∫£ng orders
    const { error: delErr } = await supa
      .from("orders")
      .delete()
      .eq("id", order.id);

    if (delErr) {
      console.error(delErr);
      alert("Xo√° ƒë∆°n trong b·∫£ng orders th·∫•t b·∫°i.");
      return;
    }

    // 3) c·∫≠p nh·∫≠t local ngay (realtime DELETE v·∫´n b·∫Øn th√™m, nh∆∞ng kh√¥ng sao)
    historyOrders = historyOrders.filter(o => o.id !== order.id);
    renderHistory();
    renderFullHistory();

    // 4) t·∫£i l·∫°i deleted_orders
    loadDeletedHistory();
  }

  // ==================== REALTIME ====================
  function initRealtime() {
    const channel = supa
      .channel("orders-realtime")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "orders" },
        payload => {
          const newOrder = payload.new;
          historyOrders.unshift(newOrder);
          renderHistory();
          renderFullHistory();
          calcRevenue();
        }
      )
      .on(
        "postgres_changes",
        { event: "DELETE", schema: "public", table: "orders" },
        payload => {
          const old = payload.old;
          if (!old || !old.id) return;
          historyOrders = historyOrders.filter(o => o.id !== old.id);
          renderHistory();
          renderFullHistory();
          calcRevenue();
        }
      )
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "deleted_orders" },
        payload => {
          const newDeleted = payload.new;
          deletedOrders.unshift(newDeleted);
          renderDeletedHistory();
        }
      )
      .subscribe(status => {
        console.log("Realtime status:", status);
      });
  }

  // ==================== REVENUE CALC ====================
  function calcRevenue() {
    const now = new Date();
    const startOfDay = new Date(now);
    startOfDay.setHours(0, 0, 0, 0);

    const startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() - 6);
    startOfWeek.setHours(0, 0, 0, 0);

    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

    let sumDay = 0, cDay = 0;
    let sumWeek = 0, cWeek = 0;
    let sumMonth = 0, cMonth = 0;

    (historyOrders || []).forEach(o => {
      if (!o.created_at) return;
      const t = new Date(o.created_at);

      if (t >= startOfDay) {
        sumDay += o.total || 0;
        cDay++;
      }
      if (t >= startOfWeek) {
        sumWeek += o.total || 0;
        cWeek++;
      }
      if (t >= startOfMonth) {
        sumMonth += o.total || 0;
        cMonth++;
      }
    });

    revDayEl.textContent = formatVND(sumDay);
    revWeekEl.textContent = formatVND(sumWeek);
    revMonthEl.textContent = formatVND(sumMonth);

    revDayCountEl.textContent = `${cDay} ƒë∆°n`;
    revWeekCountEl.textContent = `${cWeek} ƒë∆°n`;
    revMonthCountEl.textContent = `${cMonth} ƒë∆°n`;
  }

  // ==================== PRINT BILL ====================
  function printBill(order) {
    const now = order.created_at ? new Date(order.created_at) : new Date();
    const timeStr = now.toLocaleString("vi-VN");

    let rows = "";
    (order.items || []).forEach(it => {
      rows += `
        <tr>
          <td>${it.name}</td>
          <td style="text-align:center;">${it.size}</td>
          <td style="text-align:center;">${it.qty}</td>
          <td style="text-align:right;">${formatVND(it.lineTotal)}</td>
        </tr>`;
    });

    const cashStr = order.cash_given ? formatVND(order.cash_given) : "0 VND";
    const changeStr = order.change != null ? formatVND(order.change) : "0 VND";

    const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ho√° ƒë∆°n Tea Neko</title>
<style>
  body { font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif; margin:0; padding:8px; }
  .bill { width:320px; font-size:12px; }
  h2 { text-align:center; margin:4px 0 2px; font-size:16px; }
  .shop-info { text-align:right; font-size:10px; margin-bottom:6px; }
  table { width:100%; border-collapse:collapse; font-size:11px; }
  th,td { padding:2px 0; }
  th { border-bottom:1px solid #000; }
  .total-row td { border-top:1px dashed #000; padding-top:4px; }
</style>
</head>
<body>
<div class="bill">
  <h2>Tea Neko</h2>
  <div class="shop-info">
    ƒê/c: Hai B√† Tr∆∞ng, Ch∆∞ S√™, Gia Lai<br>
    SƒêT: 0123456789
  </div>
  <div style="font-size:11px;margin-bottom:4px;">
    Th·ªùi gian: ${timeStr}<br>
    M√£ ƒë∆°n: ${formatOrderCode(order.order_code)}
  </div>
  <table>
    <thead>
      <tr>
        <th>M√≥n</th>
        <th style="text-align:center;">Size</th>
        <th style="text-align:center;">SL</th>
        <th style="text-align:right;">Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody>
      ${rows}
    </tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="3"><strong>T·ªïng:</strong></td>
        <td style="text-align:right;"><strong>${formatVND(order.total || 0)}</strong></td>
      </tr>
      <tr>
        <td colspan="3">Kh√°ch ƒë∆∞a:</td>
        <td style="text-align:right;">${cashStr}</td>
      </tr>
      <tr>
        <td colspan="3">Ti·ªÅn tr·∫£ l·∫°i kh√°ch:</td>
        <td style="text-align:right;">${changeStr}</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center;margin-top:6px;font-size:11px;">
    C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko üíú
  </div>
</div>
</body>
</html>`;

    const win = window.open("", "_blank", "width=400,height=600");
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  }

  // ==================== EVENT BINDINGS ====================
  sizeMBtn.addEventListener("click", () => {
    currentSize = "M";
    sizeMBtn.classList.add("active");
    sizeLBtn.classList.remove("active");
  });

  sizeLBtn.addEventListener("click", () => {
    currentSize = "L";
    sizeLBtn.classList.add("active");
    sizeMBtn.classList.remove("active");
  });

  cashInput.addEventListener("input", renderCurrentOrder);
  btnUndo.addEventListener("click", () => {
    currentOrder.pop();
    renderCurrentOrder();
  });

  btnClear.addEventListener("click", () => {
    if (!currentOrder.length) return;
    if (!confirm("Xo√° to√†n b·ªô m√≥n trong ƒë∆°n hi·ªán t·∫°i?")) return;
    clearCurrentOrder();
  });

  btnSave.addEventListener("click", () => saveOrder(false));
  btnPrint.addEventListener("click", () => saveOrder(true));
  btnRefreshHistory.addEventListener("click", () => {
    loadHistory();
    loadDeletedHistory();
  });

  searchOrderInput.addEventListener("input", () => {
    renderFullHistory();
  });

  // ==================== INIT ====================
  renderMenu();
  renderCurrentOrder();
  loadHistory();
  loadDeletedHistory();
  initRealtime();
</script>
</body>
</html>
