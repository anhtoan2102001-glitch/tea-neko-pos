<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tea Neko POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{
    font-family:-apple-system,BlinkMacSystemFont,Arial;
    background:#f5f5f7;
    padding:14px;
}

/* Khung t·ªïng */
.container{
    max-width:480px;
    margin:0 auto;
    background:#fff;
    border-radius:16px;
    padding:14px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

/* Tabs */
.tabs{
    display:flex;
    gap:8px;
    margin-bottom:14px;
}

.tab{
    flex:1;
    padding:10px 0;
    text-align:center;
    border-radius:12px;
    background:#eee;
    font-weight:600;
    cursor:pointer;
    transition:0.15s;
}

.tab.active{
    background:#a78bfa;
    color:white;
    box-shadow:0 0 0 2px rgba(167,139,250,0.35);
}

/* M√≥n */
.menu-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:10px;
    margin-top:10px;
}

.menu-item{
    background:#fafafa;
    border-radius:14px;
    padding:10px;
    cursor:pointer;
    border:1px solid #eee;
    transition:0.12s;
}

.menu-item:active{
    transform:scale(0.97);
    background:#e5deff;
}

.menu-name{font-weight:600;font-size:15px;}
.menu-price{font-size:13px;color:#666;margin-top:2px;}

/* Danh s√°ch ƒë∆°n */
.box{
    background:#fafafa;
    border-radius:14px;
    padding:12px;
    margin-top:14px;
}

ul{margin-top:6px;padding-left:18px;font-size:14px;}
.summary{font-weight:600;margin-top:6px;}

/* N√∫t */
.btn{
    width:100%;
    border:none;
    padding:12px 0;
    border-radius:14px;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    margin-top:10px;
    color:#fff;
}

.btn-save{background:#6366f1;}
.btn-print{background:#10b981;}
.btn-clear{background:#ef4444;}
.btn-undo{background:#6b7280;}
.btn-delete{background:#f43f5e;}

/* L·ªãch s·ª≠ */
.history{
    background:#fff;
    border-radius:14px;
    padding:12px;
    margin-top:14px;
    border:1px solid #e5e7eb;
}
.history-item{
    border-bottom:1px dashed #ccc;
    padding:6px 0;
    font-size:14px;
}
.history-item.deleted{
    color:#999;
    text-decoration:line-through;
}
.delete-btn{
    float:right;
    font-size:12px;
    background:#fee2e2;
    border:1px solid #fca5a5;
    border-radius:6px;
    padding:2px 6px;
    cursor:pointer;
}

/* Tabs khu POS */
#tab-pos,#tab-history,#tab-deleted{display:none;}
#tab-pos.active,#tab-history.active,#tab-deleted.active{display:block;}

</style>
</head>

<body>

<div class="container">

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="openTab('pos')">POS</div>
        <div class="tab" onclick="openTab('history')">L·ªãch s·ª≠</div>
        <div class="tab" onclick="openTab('deleted')">ƒê√£ xo√°</div>
    </div>

    <!-- POS -->
    <div id="tab-pos" class="active">

        <h2 style="text-align:center;">Mini POS ‚Äì Tea Neko</h2>

        <div class="menu-grid" id="menuList"></div>

        <div class="box">
            <strong>ƒê∆°n hi·ªán t·∫°i:</strong>
            <ul id="orderList"></ul>
            <div class="summary" id="orderTotal">T·ªïng: 0ƒë</div>
            <div class="summary" id="orderCash"></div>
        </div>

        <input id="cashInput" type="number" placeholder="Kh√°ch ƒë∆∞a (ngh√¨n)" style="
            width:100%;margin-top:10px;padding:10px;border-radius:12px;border:1px solid #ddd;">

        <button class="btn btn-undo" onclick="undoItem()">‚Ü© Ho√†n t√°c</button>
        <button class="btn btn-clear" onclick="clearOrder()">Xo√° t·∫•t c·∫£</button>
        <button class="btn btn-save" onclick="saveOrder(false)">üíæ L∆∞u ƒë∆°n</button>
        <button class="btn btn-print" onclick="saveOrder(true)">üßæ L∆∞u + In</button>

    </div>

    <!-- L·ªãch s·ª≠ -->
    <div id="tab-history">
        <h3>L·ªãch s·ª≠ ƒë∆°n</h3>
        <div id="historyBox" class="history"></div>
    </div>

    <!-- L·ªãch s·ª≠ ƒë√£ xo√° -->
    <div id="tab-deleted">
        <h3>L·ªãch s·ª≠ xo√°</h3>
        <div id="deletedBox" class="history"></div>
    </div>

</div>

<!-- JS -->
<script type="module">
import { supabase } from "./js/supabase.js";

let currentOrder = [];
let menu = [];

/* TAB */
window.openTab = function(tab){
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll("#tab-pos,#tab-history,#tab-deleted").forEach(t=>t.classList.remove("active"));

    document.querySelector(`.tab[onclick="openTab('${tab}')"]`).classList.add("active");
    document.querySelector(`#tab-${tab}`).classList.add("active");
};

/* LOAD MENU */
async function loadMenu(){
    let { data } = await supabase.from("menu").select("*").order("name");
    menu = data || [];
    
    let html = "";
    menu.forEach(m=>{
        html += `
        <div class="menu-item" onclick="addItem('${m.id}')">
            <div class="menu-name">${m.name}</div>
            <div class="menu-price">${m.price.toLocaleString()}ƒë</div>
        </div>`;
    });
    document.getElementById("menuList").innerHTML = html;
}
window.addItem = function(id){
    let item = menu.find(x=>x.id==id);
    if(!item) return;
    
    let found = currentOrder.find(x=>x.id==id);
    if(found) found.qty++;
    else currentOrder.push({ ...item, qty:1 });

    renderOrder();
};

/* RENDER ORDER */
function renderOrder(){
    let list = document.getElementById("orderList");
    list.innerHTML = "";

    let total = 0;
    currentOrder.forEach(it=>{
        total += it.price * it.qty;
        list.innerHTML += `<li>${it.qty}x ${it.name} ‚Äì ${(it.price*it.qty).toLocaleString()}ƒë</li>`;
    });

    document.getElementById("orderTotal").innerText = `T·ªïng: ${total.toLocaleString()}ƒë`;

    let cash = parseInt(document.getElementById("cashInput").value||0)*1000;
    if(cash>0){
        document.getElementById("orderCash").innerText =
            `Kh√°ch ƒë∆∞a: ${cash.toLocaleString()}ƒë ‚Äì Tr·∫£ l·∫°i kh√°ch: ${(cash-total).toLocaleString()}ƒë`;
    }else document.getElementById("orderCash").innerText = "";
}
document.getElementById("cashInput").addEventListener("input",renderOrder);

/* HO√ÄN T√ÅC */
window.undoItem = function(){
    currentOrder.pop();
    renderOrder();
};

/* XO√Å T·∫§T C·∫¢ */
window.clearOrder = function(){
    if(confirm("Xo√° to√†n b·ªô ƒë∆°n hi·ªán t·∫°i?")){
        currentOrder = [];
        renderOrder();
    }
};

/* L∆ØU ƒê∆†N */
window.saveOrder = async function(print){
    if(currentOrder.length===0) return alert("Ch∆∞a c√≥ m√≥n.");

    let total = currentOrder.reduce((s,i)=>s+i.price*i.qty,0);
    let cash = parseInt(document.getElementById("cashInput").value||0)*1000;

    let payload = {
        items: currentOrder,
        total,
        cash_given: cash,
        change: cash-total,
        deleted:false
    };

    await supabase.from("orders").insert([payload]);

    if(print) printBill(payload);

    currentOrder=[];
    document.getElementById("cashInput").value="";
    renderOrder();
};

/* IN BILL */
function printBill(order){
    let win = window.open("", "_blank");
    win.document.write(`<pre>${JSON.stringify(order,null,2)}</pre>`);
    win.print();
}

/* L·ªäCH S·ª¨ */
async function loadHistory(){
    let { data } = await supabase.from("orders").select("*").order("id",{ascending:false});
    
    let htmlH="", htmlD="";
    data.forEach(o=>{
        let txt = `${o.id}. ${o.total.toLocaleString()}ƒë (${o.items.length} m√≥n)`;
        if(o.deleted){
            htmlD += `<div class="history-item deleted">${txt}</div>`;
        }else{
            htmlH += `<div class="history-item">${txt}
                <span class="delete-btn" onclick="deleteOrder(${o.id})">Xo√°</span></div>`;
        }
    });

    document.getElementById("historyBox").innerHTML = htmlH;
    document.getElementById("deletedBox").innerHTML = htmlD;
}
window.deleteOrder = async function(id){
    await supabase.from("orders").update({deleted:true}).eq("id",id);
    loadHistory();
};

/* INIT */
loadMenu();
loadHistory();
setInterval(loadHistory, 2000); // realtime ƒë∆°n gi·∫£n

</script>

</body>
</html>
