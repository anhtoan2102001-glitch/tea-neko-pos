<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mini POS ‚Äì Tea Neko</title>

    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial;
            background: radial-gradient(circle at top, #152238, #0a0f24);
            color: #fff;
        }

        /* ===== FIX NAVBAR KH√îNG B·∫§M ƒê∆Ø·ª¢C ===== */
        nav {
            position: relative;
            z-index: 9999 !important;
        }
        .blocker, .overlay, .fullscreen, .page-cover {
            pointer-events: none !important;
            z-index: 1 !important;
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        h2 {
            margin-top: 0;
        }

        /* TAB MENU */
        #tabBar {
            display: flex;
            justify-content: center;
            gap: 12px;
            background: transparent;
            margin-bottom: 20px;
            padding-top: 10px;
        }
        .tab-btn {
            padding: 10px 22px;
            border-radius: 50px;
            cursor: pointer;
            background: #1a2540;
            color: #fff;
            border: 1px solid #3b4a70;
            transition: 0.25s;
            user-select: none;
        }
        .tab-btn.active {
            background: #1f6bff;
            border-color: #1f6bff;
        }

        /* H·ªôp n·ªôi dung */
        .box {
            background: #0f1629;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        /* N√∫t */
        .btn {
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            transition: 0.2s;
        }

        .btn-blue {
            background: #144dff;
            color: #fff;
        }
        .btn-blue:hover {
            background: #2962ff;
        }

        .btn-red {
            background: #ff1744;
            color: #fff;
        }
        .btn-red:hover {
            background: #ff4569;
        }

        .btn-grey {
            background: #9ea7b8;
            color: #000;
        }

        .menu-btn {
            display: inline-block;
            background: #1f2a44;
            border: 1px solid #3c4a6b;
            padding: 12px 18px;
            border-radius: 12px;
            margin: 6px;
            cursor: pointer;
            transition: 0.25s;
        }
        .menu-btn:hover {
            background: #233153;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        /* Input */
        input, textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: none;
            margin-top: 8px;
            background: #131e33;
            color: #fff;
            font-size: 15px;
        }

        textarea {
            resize: vertical;
        }

        /* L·ªãch s·ª≠ */
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #24304a;
        }

        .del-btn {
            color: #ff3b5c;
            cursor: pointer;
            float: right;
            font-weight: bold;
        }

        .price {
            font-weight: bold;
            color: #6cf0ff;
        }
    </style>
</head>

<body>
<div class="app">

    <nav id="tabBar">
        <div class="tab-btn active" data-page="page-pos">POS</div>
        <div class="tab-btn" data-page="page-qr">QR Order</div>
        <div class="tab-btn" data-page="page-menu">Menu</div>
        <div class="tab-btn" data-page="page-inventory">T·ªìn kho</div>
        <div class="tab-btn" data-page="page-history">L·ªãch s·ª≠</div>
        <div class="tab-btn" data-page="page-deleted">ƒê√£ xo√°</div>
    </nav>

    <!-- PAGE POS -->
    <div id="page-pos" class="page box" style="display:block;">
        <h2>Menu ƒë·ªì u·ªëng</h2>

        <div id="menuArea">
            <!-- menu s·∫Ω load t·ª± ƒë·ªông b·∫±ng JS -->
        </div>

        <h2>ƒê∆°n hi·ªán t·∫°i:</h2>
        <div id="orderList" class="box">
            Ch∆∞a c√≥ m√≥n n√†o.
        </div>

        <div class="box">
            <h3>T·ªïng: <span id="totalPrice">0</span> VND</h3>

            <label>Kh√°ch ƒë∆∞a (ngh√¨n):</label>
            <input id="cashInput" placeholder="Nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a..." />

            <h3>Tr·∫£ l·∫°i kh√°ch: <span id="changeBack">0</span> VND</h3>

            <label>Ghi ch√∫ ƒë∆°n (t√πy ch·ªçn):</label>
            <textarea id="orderNote" placeholder="V√≠ d·ª•: √≠t ƒë√°, √≠t ng·ªçt,..."></textarea>

            <button class="btn btn-grey" id="btnUndo">‚Ü© Ho√†n t√°c</button>
            <button class="btn btn-red" id="btnClear">Xo√° ƒë∆°n hi·ªán t·∫°i</button>
            <button class="btn btn-blue" id="btnSave">üíæ L∆∞u ƒë∆°n</button>
        </div>
    </div>

    <!-- PAGE QR -->
    <div id="page-qr" class="page box" style="display:none;">
        <h2>QR Order</h2>
        <p>Danh s√°ch ƒë∆°n t·ª´ QR s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y‚Ä¶</p>
        <div id="qrOrders"></div>
    </div>

    <!-- PAGE MENU -->
    <div id="page-menu" class="page box" style="display:none;">
        <h2>Menu Tea Neko</h2>

        <table id="menuTable" border="0" width="100%" cellspacing="0" cellpadding="8">
            <thead>
                <tr>
                    <th>Nh√≥m</th>
                    <th>T√™n</th>
                    <th>Size</th>
                    <th>Gi√°</th>
                    <th>TT</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <hr/>
        <h3>Th√™m m√≥n m·ªõi</h3>
        <div class="menu-grid">
            <input id="newCat" placeholder="Nh√≥m (Latte, Tr√† s·ªØa...)" />
            <input id="newName" placeholder="T√™n m√≥n" />
            <input id="newSize" placeholder="Size (M / L)" />
            <input id="newPrice" placeholder="Gi√° (VND)" />
            <button class="btn btn-blue" id="btnAddMenu">Th√™m m√≥n</button>
        </div>
    </div>
        <!-- PAGE T·ªíN KHO -->
    <div id="page-inventory" class="page box" style="display:none;">
        <h2>T·ªìn kho nguy√™n li·ªáu</h2>

        <table id="invTable" width="100%" cellpadding="8">
            <thead>
                <tr>
                    <th>T√™n NL</th>
                    <th>ƒê∆°n v·ªã</th>
                    <th>SL hi·ªán t·∫°i</th>
                    <th>Ghi ch√∫</th>
                    <th>C·∫≠p nh·∫≠t</th>
                </tr>
            </thead>
            <tbody id="invBody"></tbody>
        </table>

        <hr/>
        <h3>Th√™m nguy√™n li·ªáu m·ªõi</h3>
        <div class="menu-grid">
            <input id="invName" placeholder="T√™n nguy√™n li·ªáu" />
            <input id="invUnit" placeholder="ƒê∆°n v·ªã (g, ml, c√°i‚Ä¶)" />
            <input id="invQty" placeholder="S·ªë l∆∞·ª£ng ban ƒë·∫ßu" />
            <button class="btn btn-blue" id="btnAddInv">Th√™m</button>
        </div>
    </div>

    <!-- PAGE L·ªäCH S·ª¨ -->
    <div id="page-history" class="page box" style="display:none;">
        <h2>L·ªãch s·ª≠ ƒë∆°n</h2>
        <div id="historyList"></div>
    </div>

    <!-- PAGE ƒê√É XO√Å -->
    <div id="page-deleted" class="page box" style="display:none;">
        <h2>ƒê∆°n ƒë√£ xo√°</h2>
        <div id="deletedList"></div>
    </div>

</div> <!-- end .app -->

<!-- ========== LOGIC ========== -->
<script type="module">
import { supabase } from "./js/supabase.js";

/* ===================== MENU M·∫∂C ƒê·ªäNH (T·ª´ MENU B·∫†N G·ª¨I) ===================== */
const DEFAULT_MENU = [
    // Espresso
    { category: "Espresso", name: "Phin ƒëen", size: "M", price: 20000 },
    { category: "Espresso", name: "Phin s·ªØa", size: "M", price: 22000 },
    { category: "Espresso", name: "Americano", size: "M", price: 25000 },

    // Latte
    { category: "Latte", name: "Matcha Latte", size: "M", price: 30000 },
    { category: "Latte", name: "Cacao Latte", size: "M", price: 28000 },

    // Tr√† s·ªØa
    { category: "Tr√† s·ªØa", name: "H·ªìng tr√† s·ªØa", size: "M", price: 28000 },
    { category: "Tr√† s·ªØa", name: "Tr√† s·ªØa tr√¢n ch√¢u", size: "M", price: 30000 },

    // Tr√† tr√°i c√¢y
    { category: "Tr√† tr√°i c√¢y", name: "Tr√† ƒë√†o", size: "M", price: 25000 },
    { category: "Tr√† tr√°i c√¢y", name: "Tr√† t·∫Øc", size: "M", price: 22000 }
];

/* =======================================================
   LOAD MENU V√ÄO POS
======================================================= */
function renderPOSMenu() {
    const area = document.getElementById("menuArea");
    area.innerHTML = "";

    let groups = {};
    DEFAULT_MENU.forEach(item => {
        if (!groups[item.category]) groups[item.category] = [];
        groups[item.category].push(item);
    });

    for (let cat in groups) {
        const title = document.createElement("h3");
        title.textContent = cat;
        area.appendChild(title);

        const grid = document.createElement("div");
        grid.className = "menu-grid";

        groups[cat].forEach(m => {
            const btn = document.createElement("div");
            btn.className = "menu-btn";
            btn.innerHTML = `${m.name}<br><span class="price">${m.price.toLocaleString()}ƒë</span>`;
            btn.onclick = () => addToOrder(m);
            grid.appendChild(btn);
        });

        area.appendChild(grid);
    }
}
renderPOSMenu();

/* =======================================================
   QU·∫¢N L√ù ƒê∆†N HI·ªÜN T·∫†I
======================================================= */
let currentOrder = [];

function updateOrderUI() {
    const list = document.getElementById("orderList");
    if (currentOrder.length === 0) {
        list.textContent = "Ch∆∞a c√≥ m√≥n n√†o.";
    } else {
        list.innerHTML = currentOrder
            .map((item, i) => `
                <div class="history-item">
                    ${item.name} (${item.size}) ‚Äî ${item.price.toLocaleString()}ƒë
                    <span class="del-btn" onclick="removeItem(${i})">X</span>
                </div>
            `)
            .join("");
    }

    const total = currentOrder.reduce((s, v) => s + v.price, 0);
    document.getElementById("totalPrice").textContent = total.toLocaleString();

    const cash = Number(document.getElementById("cashInput").value || 0) * 1000;
    document.getElementById("changeBack").textContent = (cash - total).toLocaleString();
}

window.removeItem = function(i) {
    currentOrder.splice(i, 1);
    updateOrderUI();
};

function addToOrder(item) {
    currentOrder.push(item);
    updateOrderUI();
}

document.getElementById("btnClear").onclick = () => {
    currentOrder = [];
    updateOrderUI();
};

document.getElementById("btnUndo").onclick = () => {
    currentOrder.pop();
    updateOrderUI();
};

document.getElementById("cashInput").oninput = updateOrderUI;

/* =======================================================
   L∆ØU ƒê∆†N V√ÄO SUPABASE
======================================================= */
document.getElementById("btnSave").onclick = async () => {
    if (currentOrder.length === 0) {
        alert("Ch∆∞a c√≥ m√≥n n√†o ƒë·ªÉ l∆∞u!");
        return;
    }

    const payload = {
        items: currentOrder,
        total: currentOrder.reduce((s, v) => s + v.price, 0),
        note: document.getElementById("orderNote").value,
        created_at: new Date().toISOString()
    };

    const { error } = await supabase.from("orders").insert(payload);
    if (error) {
        alert("L∆∞u ƒë∆°n th·∫•t b·∫°i!");
        console.error(error);
    } else {
        alert("ƒê√£ l∆∞u ƒë∆°n!");
        currentOrder = [];
        document.getElementById("orderNote").value = "";
        updateOrderUI();
    }
};

/* =======================================================
   CHUY·ªÇN TAB
======================================================= */
const tabs = document.querySelectorAll(".tab-btn");
const pages = document.querySelectorAll(".page");

tabs.forEach(btn => {
    btn.onclick = () => {
        tabs.forEach(t => t.classList.remove("active"));
        btn.classList.add("active");

        pages.forEach(p => p.style.display = "none");
        document.getElementById(btn.dataset.page).style.display = "block";
    };
});

</script>

</body>
</html>
