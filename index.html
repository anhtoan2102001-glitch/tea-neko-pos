<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini POS â€“ Tea Neko</title>

<style>
body{
  margin:0;background:#0b1220;color:#fff;font-family:system-ui,sans-serif;
}
.tabs{
  display:flex;gap:10px;padding:10px;background:#101a30;overflow-x:auto;
}
.tab{
  padding:10px 16px;background:#1a2440;border-radius:10px;cursor:pointer;
  white-space:nowrap;font-weight:600;
}
.tab.active{background:#3b5bff;}
.page{display:none;}
.page.active{display:block;}

.box{
  background:#111a30;margin:20px;padding:16px;border-radius:14px;
  box-shadow:0 0 6px #0008;
}
.btn{
  margin-top:10px;padding:12px;border-radius:10px;text-align:center;
  font-weight:700;cursor:pointer;user-select:none;
}
.btn-red{background:#d63636;}
.btn-blue{background:#0044ff;}
.btn-green{background:#00ff90;color:#002a15;}
.btn-gray{background:#666;}

.order-item{
  margin-bottom:10px;padding-bottom:10px;border-bottom:1px dashed #555;
}
.del-btn{
  background:#d63636;padding:4px 10px;border-radius:6px;margin-left:8px;cursor:pointer;
}

/* QR tab */
.qr-table-box{
  padding:12px;background:#111a30;border-radius:12px;margin:10px;
}
.qr-btn{
  padding:10px;background:#1a2440;border-radius:10px;margin:6px 0;cursor:pointer;
}

/* Menu tab */
.menu-item{
  background:#1a2440;padding:14px;margin:10px;border-radius:12px;
  display:flex;gap:10px;align-items:center;
}
.menu-item img{width:60px;height:60px;border-radius:10px;object-fit:cover;}
.menu-actions button{
  padding:6px 10px;border-radius:6px;margin-top:6px;
}

/* Inventory tab */
.inventory-item{
  background:#1a2440;padding:14px;margin:10px;border-radius:12px;
}
.inv-row{
  display:flex;gap:10px;
}
.inv-row input{
  flex:1;padding:6px;border-radius:6px;border:none;background:#222;color:#fff;
}
</style>
</head>

<body>

<!-- ==================== TABS ==================== -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('pos')">POS</div>
  <div class="tab" onclick="switchTab('qr')">QR Order</div>
  <div class="tab" onclick="switchTab('menu')">Menu</div>
  <div class="tab" onclick="switchTab('inventory')">Tá»“n kho</div>
  <div class="tab" onclick="switchTab('history')">Lá»‹ch sá»­</div>
  <div class="tab" onclick="switchTab('deleted')">ÄÃ£ xoÃ¡</div>
</div>

<!-- ==================== POS ==================== -->
<div id="pos" class="page active">
  <div class="box">
    <h2>POS â€“ Tea Neko</h2>

    <div id="current-list">ChÆ°a cÃ³ mÃ³n nÃ o.</div>

    <div style="margin-top:10px;font-size:20px;font-weight:700;">
      Tá»•ng: <span id="current-total">0Ä‘</span>
    </div>

    <input id="cash" type="number" placeholder="KhÃ¡ch Ä‘Æ°a (nghÃ¬n)" style="width:100%;padding:10px;border-radius:8px;margin-top:10px;">

    <textarea id="note" placeholder="Ghi chÃº..." style="width:100%;padding:10px;border-radius:8px;margin-top:10px;"></textarea>

    <div class="btn btn-gray" onclick="undo()">â†© HoÃ n tÃ¡c</div>
    <div class="btn btn-red" onclick="clearAll()">XoÃ¡ táº¥t cáº£</div>
    <div class="btn btn-blue" onclick="saveOrder()">ğŸ’¾ LÆ°u Ä‘Æ¡n</div>
    <div class="btn btn-green" onclick="saveAndPrint()">ğŸ–¨ LÆ°u + In bill</div>
  </div>
</div>

<!-- ==================== QR ORDER ==================== -->
<div id="qr" class="page">
  <div class="box">
    <h2>QR Order (20 bÃ n)</h2>
    <div id="qr-list"></div>
  </div>
</div>

<!-- ==================== MENU ==================== -->
<div id="menu" class="page">
  <div class="box">
    <h2>Quáº£n lÃ½ Menu</h2>

    <div id="menu-list"></div>

    <div class="btn btn-blue" onclick="openAddMenu()">â• ThÃªm mÃ³n má»›i</div>

    <div id="menu-form" style="display:none;margin-top:20px;">
      <h3 id="menu-form-title"></h3>
      <input id="mf-name" placeholder="TÃªn mÃ³n" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;">
      <input id="mf-price" type="number" placeholder="GiÃ¡" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;">
      <input id="mf-img" placeholder="Link áº£nh" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;">
      <input id="mf-cat" placeholder="Danh má»¥c" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;">
      <div class="btn btn-green" onclick="saveMenuForm()">ğŸ’¾ LÆ°u</div>
      <div class="btn btn-gray" onclick="closeMenuForm()">ÄÃ³ng</div>
    </div>
  </div>
</div>

<!-- ==================== INVENTORY ==================== -->
<div id="inventory" class="page">
  <div class="box">
    <h2>Tá»“n kho nguyÃªn liá»‡u</h2>

    <div id="inv-list"></div>

    <div class="btn btn-blue" onclick="openAddInv()">â• ThÃªm nguyÃªn liá»‡u</div>

    <div id="inv-form" style="display:none;margin-top:20px;">
      <h3 id="inv-form-title"></h3>
      <input id="inv-name" placeholder="TÃªn nguyÃªn liá»‡u" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;">
      <input id="inv-qty" type="number" placeholder="Sá»‘ lÆ°á»£ng" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;">
      <input id="inv-unit" placeholder="ÄÆ¡n vá»‹ (g/ml/cÃ¡iâ€¦)" style="width:100%;padding:8px;margin-bottom:6px;border-radius:8px;">
      <div class="btn btn-green" onclick="saveInvForm()">ğŸ’¾ LÆ°u</div>
      <div class="btn btn-gray" onclick="closeInvForm()">ÄÃ³ng</div>
    </div>
  </div>
</div>

<!-- ==================== HISTORY ==================== -->
<div id="history" class="page">
  <div class="box">
    <h2>Lá»‹ch sá»­ Ä‘Æ¡n</h2>
    <div id="history-list">Äang táº£i...</div>
    <div class="btn btn-gray" onclick="loadHistory()">â†» Táº£i láº¡i</div>
  </div>
</div>

<!-- ==================== DELETED ==================== -->
<div id="deleted" class="page">
  <div class="box">
    <h2>ÄÆ¡n Ä‘Ã£ xoÃ¡</h2>
    <div id="deleted-list">Äang táº£i...</div>
    <div class="btn btn-gray" onclick="loadDeleted()">â†» Táº£i láº¡i</div>
  </div>
</div>

<!-- ==================== SCRIPT ==================== -->
<script type="module">
import { supabase } from "./js/supabase.js";

/* ========== SWITCH TAB ========== */
function switchTab(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  event.target.classList.add("active");

  if(id==="history") loadHistory();
  if(id==="deleted") loadDeleted();
  if(id==="menu") loadMenu();
  if(id==="inventory") loadInventory();
  if(id==="qr") loadQR();
}

/* ========== POS ========== */
let current=[];

function renderCurrent(){
  let box=document.getElementById("current-list");
  if(current.length===0){box.innerHTML="ChÆ°a cÃ³ mÃ³n nÃ o.";document.getElementById("current-total").innerText="0Ä‘";return;}

  let html="",total=0;
  current.forEach((i,idx)=>{
    html+=`
      <div class="order-item">
        ${i.qty}x ${i.name} â€” ${(i.qty*i.price).toLocaleString()}Ä‘
        <span class="del-btn" onclick="removeItem(${idx})">X</span>
      </div>
    `;
    total+=i.qty*i.price;
  });
  box.innerHTML=html;
  document.getElementById("current-total").innerText=total.toLocaleString()+"Ä‘";
}

window.removeItem=i=>{current.splice(i,1);renderCurrent();}
window.undo=()=>{current.pop();renderCurrent();}
window.clearAll=()=>{if(confirm("XoÃ¡ táº¥t cáº£?")){current=[];renderCurrent();}}

async function saveOrder(){
  if(current.length===0) return alert("ChÆ°a cÃ³ mÃ³n!");

  const total=current.reduce((s,i)=>s+i.qty*i.price,0);
  const note=document.getElementById("note").value;

  await supabase.from("orders").insert([{items:current,total,note}]);
  alert("ÄÃ£ lÆ°u!");

  current=[];renderCurrent();
}

async function saveAndPrint(){
  await saveOrder();
  print();
}

/* ========== QR ORDER ========== */
async function loadQR(){
  let html="";
  for(let i=1;i<=20;i++){
    html+=`<div class="qr-btn" onclick="openQR(${i})">BÃ n ${i}</div>`;
  }
  document.getElementById("qr-list").innerHTML=html;
}

window.openQR=async(table)=>{
  const {data}=await supabase.from("web_orders").select("*").eq("table_id",table).eq("status","pending");
  if(!data.length) return alert("BÃ n nÃ y chÆ°a cÃ³ order.");

  if(confirm("Chuyá»ƒn order bÃ n "+table+" vÃ o POS?")){
    data[0].items.forEach(i=>current.push({name:i.name,qty:i.qty,price:i.priceM||i.priceL||i.price}));
    await supabase.from("web_orders").update({status:"done"}).eq("id",data[0].id);
    renderCurrent();
  }
};

/* ========== MENU ========== */
let editingMenu=null;

async function loadMenu(){
  const {data}=await supabase.from("menu_items").select("*").order("category");
  let html="";
  data.forEach(m=>{
    html+=`
      <div class="menu-item">
        <img src="${m.img}">
        <div>
          <div><b>${m.name}</b></div>
          <div>${m.price.toLocaleString()}Ä‘</div>
          <div style="font-size:12px;color:#aaa">${m.category}</div>
          <div class="menu-actions">
            <button onclick="editMenu(${m.id})">Sá»­a</button>
            <button onclick="deleteMenu(${m.id})">XoÃ¡</button>
          </div>
        </div>
      </div>
    `;
  });
  document.getElementById("menu-list").innerHTML=html;
}

/* Form menu */
window.openAddMenu=()=>{
  editingMenu=null;
  document.getElementById("menu-form-title").innerText="ThÃªm mÃ³n má»›i";
  document.getElementById("menu-form").style.display="block";
};
window.closeMenuForm=()=>document.getElementById("menu-form").style.display="none";

window.editMenu=async(id)=>{
  editingMenu=id;
  const {data}=await supabase.from("menu_items").select("*").eq("id",id).single();

  document.getElementById("menu-form-title").innerText="Sá»­a mÃ³n";
  document.getElementById("mf-name").value=data.name;
  document.getElementById("mf-price").value=data.price;
  document.getElementById("mf-img").value=data.img;
  document.getElementById("mf-cat").value=data.category;

  document.getElementById("menu-form").style.display="block";
};

window.saveMenuForm=async()=>{
  let name=document.getElementById("mf-name").value;
  let price=+document.getElementById("mf-price").value;
  let img=document.getElementById("mf-img").value;
  let category=document.getElementById("mf-cat").value;

  if(editingMenu){
    await supabase.from("menu_items").update({name,price,img,category}).eq("id",editingMenu);
  }else{
    await supabase.from("menu_items").insert([{name,price,img,category}]);
  }

  closeMenuForm();loadMenu();
};

window.deleteMenu=async(id)=>{
  if(confirm("XoÃ¡ mÃ³n nÃ y?")){
    await supabase.from("menu_items").delete().eq("id",id);
    loadMenu();
  }
};

/* ========== INVENTORY ========== */
let editingInv=null;

async function loadInventory(){
  const {data}=await supabase.from("inventory").select("*");
  let html="";
  data.forEach(i=>{
    html+=`
      <div class="inventory-item">
        <b>${i.name}</b>
        <div class="inv-row">
          <input value="${i.qty}">
          <input value="${i.unit}">
        </div>
        <div style="margin-top:6px;">
          <button onclick="editInv(${i.id})">Sá»­a</button>
          <button onclick="deleteInv(${i.id})">XoÃ¡</button>
        </div>
      </div>
    `;
  });
  document.getElementById("inv-list").innerHTML=html;
}

window.openAddInv=()=>{editingInv=null;document.getElementById("inv-form-title").innerText="ThÃªm nguyÃªn liá»‡u";document.getElementById("inv-form").style.display="block";}
window.closeInvForm=()=>document.getElementById("inv-form").style.display="none";

window.editInv=async(id)=>{
  editingInv=id;
  const {data}=await supabase.from("inventory").select("*").eq("id",id).single();
  document.getElementById("inv-form-title").innerText="Sá»­a nguyÃªn liá»‡u";
  document.getElementById("inv-name").value=data.name;
  document.getElementById("inv-qty").value=data.qty;
  document.getElementById("inv-unit").value=data.unit;
  document.getElementById("inv-form").style.display="block";
};

window.saveInvForm=async()=>{
  let name=document.getElementById("inv-name").value;
  let qty=+document.getElementById("inv-qty").value;
  let unit=document.getElementById("inv-unit").value;

  if(editingInv){
    await supabase.from("inventory").update({name,qty,unit}).eq("id",editingInv);
  }else{
    await supabase.from("inventory").insert([{name,qty,unit}]);
  }

  closeInvForm();loadInventory();
};

window.deleteInv=async(id)=>{
  if(confirm("XoÃ¡ nguyÃªn liá»‡u?")){
    await supabase.from("inventory").delete().eq("id",id);
    loadInventory();
  }
};

/* ========== HISTORY ========== */
async function loadHistory(){
  const {data}=await supabase.from("orders").select("*").order("created_at",{ascending:false});
  let html="";
  data.forEach(o=>{
    html+=`
      <div class="order-item">
        <b>#${o.id}</b> â€” ${new Date(o.created_at).toLocaleString()}
        <br>${o.items.map(i=>`${i.qty}x ${i.name}`).join(", ")}
        <br><b>${o.total.toLocaleString()}Ä‘</b>
        <span class="del-btn" onclick="deleteOrder(${o.id})">X</span>
      </div>
    `;
  });
  document.getElementById("history-list").innerHTML=html||"ChÆ°a cÃ³ Ä‘Æ¡n.";
}

window.deleteOrder=async(id)=>{
  if(confirm("XoÃ¡ Ä‘Æ¡n?")){
    const {data}=await supabase.from("orders").select("*").eq("id",id).single();
    await supabase.from("deleted_orders").insert([data]);
    await supabase.from("orders").delete().eq("id",id);
    loadHistory();
    loadDeleted();
  }
};

/* ========== DELETED ========== */
async function loadDeleted(){
  const {data}=await supabase.from("deleted_orders").select("*").order("deleted_at",{ascending:false});
  let html="";
  data.forEach(o=>{
    html+=`
      <div class="order-item">
        <b>#${o.id}</b> â€” ÄÃ£ xoÃ¡
        <br>${o.items.map(i=>`${i.qty}x ${i.name}`).join(", ")}
        <br><b>${o.total.toLocaleString()}Ä‘</b>
      </div>
    `;
  });
  document.getElementById("deleted-list").innerHTML=html||"ChÆ°a cÃ³ Ä‘Æ¡n xoÃ¡.";
}

</script>
</body>
</html>
