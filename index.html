<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Mini POS ‚Äì Tea Neko</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: #111827;
      color: #f9fafb;
    }

    a { color: inherit; }

    /* ====== COMMON LAYOUT ====== */
    .container {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding-bottom: 40px;
    }

    h2 {
      margin: 0 0 8px;
      font-size: 18px;
      text-align: center;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      border: 1px solid #1e293b;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #9ca3af;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    button {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      transition: transform .06s ease, box-shadow .1s ease, opacity .06s ease;
    }

    .btn:active {
      transform: translateY(1px);
      opacity: .85;
      box-shadow: 0 0 0 1px rgba(0,0,0,.4) inset;
    }

    .btn-gray { background: #4b5563; }
    .btn-red { background: #ef4444; }
    .btn-blue { background: #2563eb; }
    .btn-green { background: #22c55e; }

    input {
      font-family: inherit;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 6px 10px;
      background: #020617;
      color: #f9fafb;
      outline: none;
    }

    input::placeholder {
      color: #6b7280;
    }

    /* ====== TAB BAR ====== */
    .tab-bar-wrapper {
      position: sticky;
      top: 0;
      z-index: 999;
      background: #020617;
      border-bottom: 1px solid #1f2937;
    }

    .tab-bar {
      display: flex;
      max-width: 520px;
      margin: 0 auto;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: #9ca3af;
      position: relative;
      user-select: none;
    }

    .tab-btn:hover {
      background: #0b1120;
    }

    .tab-btn.active {
      color: #f9fafb;
    }

    .tab-underline {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 2px;
      width: 33.3333%;
      background: #22c55e;
      transform: translateX(0%);
      transition: transform .2s ease;
    }

    /* ====== POS PAGE ====== */
    .page {
      display: none;
      padding: 14px 12px 24px;
    }

    .page.active {
      display: block;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .menu-item {
      background: #020617;
      border-radius: 14px;
      padding: 10px 10px 8px;
      border: 1px solid #1e293b;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .12s ease, border-color .08s ease, background .08s ease;
    }

    .menu-item:hover {
      border-color: #4b5563;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    }

    .menu-item:active {
      transform: translateY(1px) scale(.98);
      background: #020817;
    }

    .menu-name {
      font-size: 14px;
      font-weight: 600;
    }

    .menu-price {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .size-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .size-btn {
      flex: 1;
      padding: 7px 0;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: background .08s ease, border-color .08s ease, box-shadow .08s ease;
    }

    .size-btn.active {
      background: #2563eb;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,.6);
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .row label {
      font-size: 13px;
      color: #d1d5db;
      white-space: nowrap;
    }

    .row input {
      flex: 1;
    }

    .btn-row {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
      margin-top: 8px;
    }

    ul {
      margin: 4px 0 0;
      padding-left: 18px;
      max-height: 180px;
      overflow-y: auto;
      font-size: 13px;
    }

    .summary {
      margin-top: 6px;
      font-size: 13px;
    }

    .summary strong {
      font-size: 14px;
    }

    /* ====== HISTORY ====== */
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .history-list {
      max-height: 220px;
      overflow-y: auto;
      font-size: 12px;
    }

    .history-item {
      border-bottom: 1px dashed #1f2937;
      padding: 4px 0;
      display: flex;
      gap: 6px;
    }

    .history-main {
      flex: 1;
    }

    .badge-deleted {
      display: inline-block;
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #b91c1c;
      color: #fee2e2;
      margin-left: 4px;
    }

    .tag-muted {
      color: #9ca3af;
      font-size: 11px;
    }

    .btn-mini {
      border-radius: 999px;
      border: none;
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
      color: #fff;
      background: #ef4444;
      align-self: center;
      white-space: nowrap;
    }

    .btn-mini:active {
      opacity: .85;
      transform: translateY(1px);
    }

    .revenue-cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }

    .rev-card {
      background: #020617;
      border-radius: 14px;
      padding: 10px;
      border: 1px solid #1f2937;
      font-size: 13px;
    }

    .rev-title {
      font-size: 12px;
      color: #9ca3af;
    }

    .rev-value {
      margin-top: 4px;
      font-size: 15px;
      font-weight: 600;
    }

    .small-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }
  </style>

  <!-- Supabase v2 UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
  <!-- TAB BAR -->
  <div class="tab-bar-wrapper">
    <div class="tab-bar">
      <div class="tab-btn active" data-page="page-pos">POS</div>
      <div class="tab-btn" data-page="page-revenue">Doanh thu</div>
      <div class="tab-btn" data-page="page-history">L·ªãch s·ª≠</div>
      <div class="tab-underline" id="tabUnderline"></div>
    </div>
  </div>

  <div class="container">
    <!-- PAGE 1 ‚Äì POS -->
    <div id="page-pos" class="page active">
      <div class="card">
        <h2>Mini POS ‚Äì Tea Neko</h2>

        <div class="section-title">Latte / Coffee / Tr√† s·ªØa</div>
        <div class="menu-grid" id="menuMain"></div>

        <div class="section-title" style="margin-top:8px;">T√πy ch·ªçn size</div>
        <div class="size-row">
          <button id="sizeM" class="size-btn active">Size M</button>
          <button id="sizeL" class="size-btn">Size L (+5.000)</button>
        </div>

        <div class="row">
          <label for="cashInput">Kh√°ch ƒë∆∞a (ngh√¨n):</label>
          <input id="cashInput" type="number" min="0" placeholder="VD: 50" />
        </div>

        <div class="btn-row">
          <button id="btnUndo" class="btn btn-gray">‚Ü© Ho√†n t√°c</button>
          <button id="btnClear" class="btn btn-red">X√≥a t·∫•t c·∫£</button>
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button id="btnSave" class="btn btn-blue">üíæ L∆∞u ƒë∆°n</button>
          <button id="btnPrint" class="btn btn-green">üßæ L∆∞u + In bill</button>
        </div>

        <div style="margin-top:10px;">
          <div class="section-title" style="margin-bottom:2px;">ƒê∆°n hi·ªán t·∫°i</div>
          <ul id="currentList"></ul>
          <div id="currentSummary" class="summary">T·ªïng: 0 VND</div>
          <div id="cashSummary" class="summary"></div>
        </div>

        <div style="margin-top:12px;">
          <div class="history-header">
            <span class="section-title" style="margin:0;">L·ªãch s·ª≠ ƒë∆°n (Realtime)</span>
            <button id="btnRefreshHistory" class="btn-mini" style="background:#4b5563;">‚Üª T·∫£i l·∫°i</button>
          </div>
          <div id="historyList" class="history-list"></div>
          <div id="historyTotal" class="summary" style="margin-top:4px;">T·ªïng doanh thu: 0 VND</div>
        </div>
      </div>
    </div>

    <!-- PAGE 2 ‚Äì DOANH THU -->
    <div id="page-revenue" class="page">
      <div class="card">
        <h2>Doanh thu</h2>
        <div class="revenue-cards" style="margin-top:8px;">
          <div class="rev-card">
            <div class="rev-title">H√¥m nay</div>
            <div id="revToday" class="rev-value">0 VND</div>
          </div>
          <div class="rev-card">
            <div class="rev-title">Tu·∫ßn n√†y</div>
            <div id="revWeek" class="rev-value">0 VND</div>
          </div>
          <div class="rev-card">
            <div class="rev-title">Th√°ng n√†y</div>
            <div id="revMonth" class="rev-value">0 VND</div>
          </div>
          <div class="rev-card">
            <div class="rev-title">T·ªïng t·∫•t c·∫£</div>
            <div id="revTotal" class="rev-value">0 VND</div>
          </div>
        </div>
        <div class="small-text">
          * Doanh thu ch·ªâ t√≠nh c√°c ƒë∆°n <strong>ch∆∞a b·ªã xo√°</strong> (trong b·∫£ng <code>orders</code>).<br />
          * Xem l·ªãch s·ª≠ xo√° ·ªü tab <strong>L·ªãch s·ª≠</strong>.
        </div>
      </div>
    </div>

    <!-- PAGE 3 ‚Äì L·ªäCH S·ª¨ -->
    <div id="page-history" class="page">
      <div class="card">
        <h2>L·ªãch s·ª≠ & L·ªãch s·ª≠ xo√°</h2>

        <div style="margin-top:6px;">
          <div class="section-title">ƒê∆°n ƒëang ho·∫°t ƒë·ªông (orders)</div>
          <div id="historyFullList" class="history-list"></div>
        </div>

        <div style="margin-top:12px;">
          <div class="section-title">ƒê∆°n ƒë√£ xo√° (deleted_orders)</div>
          <div id="deletedList" class="history-list"></div>
        </div>

        <div class="small-text">
          * ·ªû ƒë√¢y ch·ªâ xem l·ªãch s·ª≠ xo√°, kh√¥ng xo√° th√™m n·ªØa ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu.<br />
          * N·∫øu c·∫ßn kh√¥i ph·ª•c ƒë∆°n ƒë√£ xo√° c√≥ th·ªÉ l√†m th√™m sau (copy l·∫°i t·ª´ <code>deleted_orders</code>).
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ SUPABASE CONFIG ============
    const SUPABASE_URL = "https://kcrchwedlrettpkucoct.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw";

    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ============ MENU & STATE ============
    const MENU = [
      { name: "Matcha Latte",      price: 25000 },
      { name: "Coffee",            price: 25000 },
      { name: "Tr√† s·ªØa tr√¢n ch√¢u", price: 30000 },
      { name: "H·ªìng tr√† s·ªØa",      price: 28000 },
      { name: "Cacao ƒë√°",          price: 22000 },
      { name: "B·∫°c x·ªâu",           price: 20000 }
    ];

    let currentOrder = [];
    let currentSize = "M";

    let orders = [];         // ƒë∆°n ƒëang ho·∫°t ƒë·ªông (b·∫£ng orders)
    let deletedOrders = [];  // ƒë∆°n ƒë√£ xo√° (b·∫£ng deleted_orders)

    // ============ DOM ============
    const menuMain = document.getElementById("menuMain");
    const sizeMBtn = document.getElementById("sizeM");
    const sizeLBtn = document.getElementById("sizeL");
    const cashInput = document.getElementById("cashInput");
    const currentList = document.getElementById("currentList");
    const currentSummary = document.getElementById("currentSummary");
    const cashSummary = document.getElementById("cashSummary");
    const btnUndo = document.getElementById("btnUndo");
    const btnClear = document.getElementById("btnClear");
    const btnSave = document.getElementById("btnSave");
    const btnPrint = document.getElementById("btnPrint");
    const btnRefreshHistory = document.getElementById("btnRefreshHistory");
    const historyList = document.getElementById("historyList");
    const historyTotal = document.getElementById("historyTotal");

    const revToday = document.getElementById("revToday");
    const revWeek  = document.getElementById("revWeek");
    const revMonth = document.getElementById("revMonth");
    const revTotal = document.getElementById("revTotal");

    const historyFullList = document.getElementById("historyFullList");
    const deletedList = document.getElementById("deletedList");

    // Tabs
    const tabButtons = document.querySelectorAll(".tab-btn");
    const pages = document.querySelectorAll(".page");
    const tabUnderline = document.getElementById("tabUnderline");

    // ============ HELPERS ============
    function formatVND(x) {
      return (x || 0).toLocaleString("vi-VN") + " VND";
    }

    function formatTime(str) {
      if (!str) return "";
      return new Date(str).toLocaleString("vi-VN");
    }

    function formatItems(items) {
      if (!items || !items.length) return "";
      return items
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ");
    }

    function getNextOrderCode() {
      const nums = [];
      [...orders, ...deletedOrders].forEach(o => {
        if (!o.order_code) return;
        const n = parseInt(String(o.order_code).replace("#",""), 10);
        if (!isNaN(n)) nums.push(n);
      });
      const max = nums.length ? Math.max(...nums) : 0;
      const next = max + 1;
      return "#" + String(next).padStart(4,"0");
    }

    // ============ MENU UI ============
    function renderMenu() {
      menuMain.innerHTML = "";
      MENU.forEach(item => {
        const div = document.createElement("div");
        div.className = "menu-item";
        div.innerHTML = `
          <div class="menu-name">${item.name}</div>
          <div class="menu-price">${item.price.toLocaleString("vi-VN")} VND (Size M)</div>
        `;
        div.addEventListener("click", () => addItem(item));
        menuMain.appendChild(div);
      });
    }

    function addItem(item) {
      const isL = currentSize === "L";
      const unitPrice = item.price + (isL ? 5000 : 0);

      // N·∫øu m√≥n cu·ªëi c√πng gi·ªëng nhau th√¨ c·ªông s·ªë l∆∞·ª£ng
      const last = currentOrder[currentOrder.length - 1];
      if (last && last.name === item.name && last.size === currentSize) {
        last.qty += 1;
        last.lineTotal += unitPrice;
      } else {
        currentOrder.push({
          name: item.name,
          size: currentSize,
          qty: 1,
          unitPrice,
          lineTotal: unitPrice
        });
      }
      renderCurrentOrder();
    }

    // ============ CURRENT ORDER ============
    function renderCurrentOrder() {
      currentList.innerHTML = "";
      let total = 0;
      currentOrder.forEach(line => {
        total += line.lineTotal;
        const li = document.createElement("li");
        li.textContent = `${line.qty} x ${line.name} (Size ${line.size}) ‚Äì ${formatVND(line.lineTotal)}`;
        currentList.appendChild(li);
      });
      currentSummary.innerHTML = `<strong>T·ªïng:</strong> ${formatVND(total)}`;

      const cashThousand = parseInt(cashInput.value || "0", 10);
      const cash = cashThousand * 1000;

      if (cash > 0 && total > 0) {
        const diff = cash - total;
        if (diff >= 0) {
          cashSummary.textContent =
            `Kh√°ch ƒë∆∞a: ${formatVND(cash)} ‚Äì ` +
            `Ti·ªÅn tr·∫£ l·∫°i kh√°ch: ${formatVND(diff)}`;
        } else {
          cashSummary.textContent =
            `Kh√°ch ƒë∆∞a: ${formatVND(cash)} ‚Äì ` +
            `C√≤n thi·∫øu: ${formatVND(Math.abs(diff))}`;
        }
      } else {
        cashSummary.textContent = "";
      }
    }

    function clearCurrentOrder() {
      currentOrder = [];
      renderCurrentOrder();
    }

    // ============ LOAD DATA ============
    async function loadOrders() {
      const { data, error } = await supa
        .from("orders")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(200);

      if (error) {
        console.error(error);
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ƒë∆°n (orders)");
        return;
      }
      orders = data || [];
      renderOrdersHistory();
      renderRevenue();
    }

    async function loadDeletedOrders() {
      const { data, error } = await supa
        .from("deleted_orders")
        .select("*")
        .order("deleted_at", { ascending: false })
        .limit(200);

      if (error) {
        console.error(error);
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch deleted_orders");
        return;
      }
      deletedOrders = data || [];
      renderDeletedHistory();
    }

    // ============ HISTORY RENDER ============
    function renderOrdersHistory() {
      // POS ‚Äì l·ªãch s·ª≠ ng·∫Øn + doanh thu t·ªïng
      historyList.innerHTML = "";
      let revenue = 0;
      orders.forEach(order => {
        revenue += order.total || 0;

        const wrapper = document.createElement("div");
        wrapper.className = "history-item";

        const main = document.createElement("div");
        main.className = "history-main";

        const code = order.order_code || "";
        const line1 = document.createElement("div");
        line1.innerHTML =
          `<span style="color:#f97316;">${code}</span> ` +
          `<span class="tag-muted">[${formatTime(order.created_at)}]</span>`;
        main.appendChild(line1);

        const line2 = document.createElement("div");
        line2.textContent = formatItems(order.items);
        main.appendChild(line2);

        const line3 = document.createElement("div");
        line3.style.fontSize = "12px";
        line3.style.color = "#9ca3af";
        line3.textContent = formatVND(order.total || 0);
        main.appendChild(line3);

        wrapper.appendChild(main);

        const btn = document.createElement("button");
        btn.className = "btn-mini";
        btn.textContent = "Xo√° ƒë∆°n";
        btn.addEventListener("click", () => handleDeleteOrder(order));
        wrapper.appendChild(btn);

        historyList.appendChild(wrapper);
      });

      historyTotal.textContent = `T·ªïng doanh thu: ${formatVND(revenue)}`;

      // HISTORY PAGE ‚Äì danh s√°ch ƒë·∫ßy ƒë·ªß orders
      historyFullList.innerHTML = "";
      orders.forEach(order => {
        const wrapper = document.createElement("div");
        wrapper.className = "history-item";

        const main = document.createElement("div");
        main.className = "history-main";
        main.innerHTML = `
          <div><strong>${order.order_code || ""}</strong>
            <span class="tag-muted">[${formatTime(order.created_at)}]</span>
          </div>
          <div>${formatItems(order.items)}</div>
          <div class="tag-muted">${formatVND(order.total || 0)}</div>
        `;
        wrapper.appendChild(main);

        const btn = document.createElement("button");
        btn.className = "btn-mini";
        btn.textContent = "Xo√° ƒë∆°n";
        btn.addEventListener("click", () => handleDeleteOrder(order));
        wrapper.appendChild(btn);

        historyFullList.appendChild(wrapper);
      });
    }

    function renderDeletedHistory() {
      deletedList.innerHTML = "";
      deletedOrders.forEach(order => {
        const wrapper = document.createElement("div");
        wrapper.className = "history-item";

        const main = document.createElement("div");
        main.className = "history-main";
        main.innerHTML = `
          <div>
            <strong>${order.order_code || ""}</strong>
            <span class="badge-deleted">ƒê√£ xo√°</span>
          </div>
          <div class="tag-muted">
            Xo√° l√∫c: ${formatTime(order.deleted_at)} ‚Äì T·ªïng: ${formatVND(order.total || 0)}
          </div>
          <div>${formatItems(order.items)}</div>
        `;
        wrapper.appendChild(main);

        deletedList.appendChild(wrapper);
      });
    }

    // ============ DOANH THU ============
    function renderRevenue() {
      let total = 0, today = 0, week = 0, month = 0;
      const now = new Date();
      const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const dayOfWeek = startOfToday.getDay() || 7; // CN=0 -> 7
      const startOfWeek = new Date(startOfToday);
      startOfWeek.setDate(startOfToday.getDate() - (dayOfWeek - 1));
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

      orders.forEach(o => {
        const t = o.total || 0;
        total += t;
        const created = o.created_at ? new Date(o.created_at) : null;
        if (!created) return;

        if (created >= startOfToday) today += t;
        if (created >= startOfWeek) week += t;
        if (created >= startOfMonth) month += t;
      });

      revToday.textContent = formatVND(today);
      revWeek.textContent = formatVND(week);
      revMonth.textContent = formatVND(month);
      revTotal.textContent = formatVND(total);
    }

    // ============ SAVE / DELETE ============
    async function saveOrder(printAfter) {
      if (!currentOrder.length) {
        alert("ƒê∆°n hi·ªán t·∫°i ƒëang tr·ªëng.");
        return;
      }

      const total = currentOrder.reduce((s,l) => s + l.lineTotal, 0);
      const cashThousand = parseInt(cashInput.value || "0", 10);
      const cash = cashThousand * 1000;
      const change = cash > 0 ? cash - total : null;
      const orderCode = getNextOrderCode();

      const payload = {
        order_code: orderCode,
        device: null,
        items: currentOrder,
        total,
        cash_given: cash || null,
        change
      };

      const { data, error } = await supa
        .from("orders")
        .insert([payload])
        .select()
        .single();

      if (error) {
        console.error(error);
        alert("L∆∞u ƒë∆°n th·∫•t b·∫°i.");
        return;
      }

      // c·∫≠p nh·∫≠t local ngay
      orders.unshift(data);
      renderOrdersHistory();
      renderRevenue();

      if (printAfter) {
        printBill(data);
      }

      clearCurrentOrder();
      cashInput.value = "";
      cashSummary.textContent = "";
    }

    async function handleDeleteOrder(order) {
      if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° ƒë∆°n n√†y?\nƒê∆°n s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o l·ªãch s·ª≠ xo√°.")) {
        return;
      }

      // 1) Insert v√†o deleted_orders
      const deletedPayload = {
        original_order_id: order.id,
        order_code: order.order_code,
        device: order.device,
        items: order.items,
        total: order.total,
        cash_given: order.cash_given,
        change: order.change
      };

      const { error: insErr } = await supa
        .from("deleted_orders")
        .insert([deletedPayload]);

      if (insErr) {
        console.error(insErr);
        alert("Kh√¥ng th·ªÉ ch√©p sang b·∫£ng deleted_orders.");
        return;
      }

      // 2) Xo√° kh·ªèi orders
      const { error: delErr } = await supa
        .from("orders")
        .delete()
        .eq("id", order.id);

      if (delErr) {
        console.error(delErr);
        alert("Xo√° ƒë∆°n trong b·∫£ng orders th·∫•t b·∫°i.");
        return;
      }

      // 3) C·∫≠p nh·∫≠t local
      orders = orders.filter(o => o.id !== order.id);
      renderOrdersHistory();

      // t·∫£i l·∫°i deleted_orders ƒë·ªÉ xem l·ªãch s·ª≠ xo√°
      await loadDeletedOrders();
      renderRevenue();
    }

    // ============ PRINT BILL ============
    function printBill(order) {
      const now = order.created_at ? new Date(order.created_at) : new Date();
      const timeStr = now.toLocaleString("vi-VN");

      let rows = "";
      (order.items || []).forEach(it => {
        rows += `
          <tr>
            <td>${it.name}</td>
            <td style="text-align:center;">${it.size}</td>
            <td style="text-align:center;">${it.qty}</td>
            <td style="text-align:right;">${formatVND(it.lineTotal)}</td>
          </tr>`;
      });

      const cashStr = order.cash_given ? formatVND(order.cash_given) : "0 VND";
      const changeStr =
        order.change != null ? formatVND(order.change) : "0 VND";

      const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Ho√° ƒë∆°n Tea Neko</title>
<style>
  body { font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif; margin:0; padding:8px; }
  .bill { width:320px; font-size:12px; }
  h2 { text-align:center; margin:4px 0 2px; font-size:16px; }
  .shop-info { text-align:right; font-size:10px; margin-bottom:6px; }
  table { width:100%; border-collapse:collapse; font-size:11px; }
  th,td { padding:2px 0; }
  th { border-bottom:1px solid #000; }
  .total-row td { border-top:1px dashed #000; padding-top:4px; }
</style>
</head>
<body>
<div class="bill">
  <h2>Tea Neko</h2>
  <div class="shop-info">
    ƒê/c: Hai B√† Tr∆∞ng, Ch∆∞ S√™, Gia Lai<br/>
    SƒêT: 0123456789
  </div>
  <div style="font-size:11px;margin-bottom:4px;">
    Th·ªùi gian: ${timeStr}<br/>
    M√£ ƒë∆°n: ${order.order_code || ""}
  </div>
  <table>
    <thead>
      <tr>
        <th>M√≥n</th>
        <th style="text-align:center;">Size</th>
        <th style="text-align:center;">SL</th>
        <th style="text-align:right;">Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody>
      ${rows}
    </tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="3"><strong>T·ªïng:</strong></td>
        <td style="text-align:right;"><strong>${formatVND(order.total || 0)}</strong></td>
      </tr>
      <tr>
        <td colspan="3">Kh√°ch ƒë∆∞a:</td>
        <td style="text-align:right;">${cashStr}</td>
      </tr>
      <tr>
        <td colspan="3">Ti·ªÅn tr·∫£ l·∫°i kh√°ch:</td>
        <td style="text-align:right;">${changeStr}</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center;margin-top:6px;font-size:11px;">
    C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko üíú
  </div>
</div>
</body>
</html>`;

      const win = window.open("", "_blank", "width=400,height=600");
      win.document.write(html);
      win.document.close();
      win.focus();
      win.print();
    }

    // ============ REALTIME (INSERT) ============
    function initRealtime() {
      supa
        .channel("orders-realtime")
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "orders" },
          payload => {
            const newOrder = payload.new;
            if (!orders.find(o => o.id === newOrder.id)) {
              orders.unshift(newOrder);
              renderOrdersHistory();
              renderRevenue();
            }
          }
        )
        .subscribe();
    }

    // ============ TAB HANDLING ============
    function activateTab(index) {
      tabButtons.forEach((btn, i) => {
        btn.classList.toggle("active", i === index);
      });
      pages.forEach((page, i) => {
        page.classList.toggle("active", i === index);
      });
      tabUnderline.style.transform = `translateX(${index * 100}%)`;
    }

    tabButtons.forEach((btn, index) => {
      btn.addEventListener("click", () => activateTab(index));
    });

    // ============ EVENT BINDINGS ============
    sizeMBtn.addEventListener("click", () => {
      currentSize = "M";
      sizeMBtn.classList.add("active");
      sizeLBtn.classList.remove("active");
    });

    sizeLBtn.addEventListener("click", () => {
      currentSize = "L";
      sizeLBtn.classList.add("active");
      sizeMBtn.classList.remove("active");
    });

    cashInput.addEventListener("input", () => {
      renderCurrentOrder();
    });

    btnUndo.addEventListener("click", () => {
      currentOrder.pop();
      renderCurrentOrder();
    });

    btnClear.addEventListener("click", () => {
      if (!currentOrder.length) return;
      if (!confirm("Xo√° to√†n b·ªô m√≥n trong ƒë∆°n hi·ªán t·∫°i?")) return;
      clearCurrentOrder();
      cashInput.value = "";
      cashSummary.textContent = "";
    });

    btnSave.addEventListener("click", () => saveOrder(false));
    btnPrint.addEventListener("click", () => saveOrder(true));
    btnRefreshHistory.addEventListener("click", () => loadOrders());

    // ============ INIT ============
    async function init() {
      renderMenu();
      renderCurrentOrder();
      await loadOrders();
      await loadDeletedOrders();
      initRealtime();
    }

    init();
  </script>
</body>
</html>
