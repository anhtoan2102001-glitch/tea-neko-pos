<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini POS ‚Äì Tea Neko</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: radial-gradient(circle at top, #152238 0%, #050818 50%, #02030a 100%);
      color: #fff;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 10px 40px;
    }
    h1 {
      margin: 12px 0 16px;
      text-align: center;
      font-size: 26px;
      letter-spacing: 0.04em;
    }

    /* TAB BAR */
    .tab-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab-btn {
      flex: 0 0 auto;
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #2d3c66;
      background: #11172b;
      color: #cfd4ff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .tab-btn.active {
      background: #2555ff;
      border-color: #4f7dff;
      box-shadow: 0 0 0 2px rgba(80, 150, 255, 0.35);
      color: #fff;
    }
    .tab-btn:hover {
      background: #1a2240;
    }

    .page {
      display: none;
      border-radius: 16px;
      background: rgba(5, 10, 32, 0.92);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(96, 110, 170, 0.65);
      padding: 16px 16px 20px;
    }
    .page.active {
      display: block;
    }

    .section-title {
      font-weight: 600;
      margin: 4px 0 6px;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #b5c4ff;
    }

    /* POS MENU GRID */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .menu-item-btn {
      width: 100%;
      text-align: left;
      padding: 8px 10px 6px;
      border-radius: 10px;
      border: 1px solid #2c3a63;
      background: #141b33;
      cursor: pointer;
      font-size: 13px;
      color: #f5f7ff;
      line-height: 1.35;
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.1s ease, transform 0.06s ease, background 0.12s ease;
    }
    .menu-item-btn:hover {
      background: #1a2345;
      box-shadow: 0 0 0 2px rgba(90, 140, 255, 0.4);
    }
    .menu-item-btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 2px rgba(140, 190, 255, 0.55);
    }
    .menu-item-name {
      font-weight: 500;
    }
    .menu-item-price {
      font-size: 12px;
      opacity: 0.85;
    }

    /* POS CURRENT ORDER */
    .pos-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.2fr);
      gap: 14px;
      margin-top: 10px;
    }
    @media (max-width: 880px) {
      .pos-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      border-radius: 12px;
      background: #0b1122;
      border: 1px solid #232f52;
      padding: 10px 12px 12px;
    }
    .card + .card {
      margin-top: 6px;
    }
    .order-lines {
      font-size: 13px;
      min-height: 60px;
      white-space: pre-line;
    }
    .order-summary {
      margin-top: 8px;
      font-size: 13px;
    }

    input, select, textarea {
      font-family: inherit;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #303d63;
      background: #050915;
      color: #fff;
      padding: 6px 8px;
      width: 100%;
    }
    textarea {
      resize: vertical;
      min-height: 40px;
      max-height: 100px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .btn {
      flex: 1 1 120px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      color: #fff;
      transition: transform 0.05s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-grey {
      background: #4a5568;
    }
    .btn-red {
      background: #e53e3e;
    }
    .btn-blue {
      background: #2563eb;
    }
    .btn-green {
      background: #16a34a;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      background: #1e293b;
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }

    /* TABLE STYLE (history, deleted, inventory, menu) */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }
    th, td {
      border-bottom: 1px solid #283555;
      padding: 6px 4px;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }
    tr:hover td {
      background: rgba(25, 40, 80, 0.6);
    }
    .table-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .btn-xs {
      border-radius: 999px;
      border: none;
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
      color: #fff;
    }
    .btn-xs-grey {
      background: #4b5563;
    }
    .btn-xs-red {
      background: #ef4444;
    }
    .btn-xs-blue {
      background: #3b82f6;
    }
    .btn-xs-green {
      background: #22c55e;
    }

    .small-input {
      width: 70px;
    }
    .very-small-input {
      width: 56px;
    }

    .danger-text {
      color: #fecaca;
      font-size: 12px;
    }
    .muted {
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Mini POS ‚Äì Tea Neko</h1>

    <!-- TAB BAR -->
    <div class="tab-bar">
      <button class="tab-btn active" data-page="pos">POS</button>
      <button class="tab-btn" data-page="qr">QR Order</button>
      <button class="tab-btn" data-page="menu">Menu</button>
      <button class="tab-btn" data-page="inventory">T·ªìn kho</button>
      <button class="tab-btn" data-page="history">L·ªãch s·ª≠</button>
      <button class="tab-btn" data-page="deleted">ƒê√£ xo√°</button>
    </div>

    <!-- PAGE: POS -->
    <div id="page-pos" class="page active">
      <div class="section-title">Menu nhanh (b·∫•m ƒë·ªÉ th√™m m√≥n)</div>

      <div id="posMenuContainer"></div>

      <div class="pos-layout">
        <!-- Left: current order -->
        <div class="card">
          <div class="section-title">ƒê∆°n hi·ªán t·∫°i</div>
          <div id="currentOrderLines" class="order-lines">Ch∆∞a c√≥ m√≥n n√†o.</div>
          <div id="currentOrderSummary" class="order-summary"></div>

          <div style="margin-top:10px;">
            <div class="section-title" style="margin-bottom:4px;">Kh√°ch ƒë∆∞a (ngh√¨n)</div>
            <input id="cashGivenInput" type="number" min="0" step="1" placeholder="VD: 50" />
            <div id="changeDisplay" style="margin-top:4px;font-size:13px;">Ti·ªÅn tr·∫£ l·∫°i kh√°ch: 0ƒë</div>
          </div>

          <div style="margin-top:8px;">
            <div class="section-title" style="margin-bottom:4px;">Ghi ch√∫ ƒë∆°n (tu·ª≥ ch·ªçn)</div>
            <textarea id="orderNote" placeholder="V√≠ d·ª•: √≠t ƒë√°, √≠t ng·ªçt, mang v·ªÅ..."></textarea>
          </div>

          <div class="btn-row">
            <button id="btnUndo" class="btn btn-grey">‚Ü© Ho√†n t√°c</button>
            <button id="btnClear" class="btn btn-red">Xo√° t·∫•t c·∫£</button>
            <button id="btnSave" class="btn btn-blue">üíæ L∆∞u ƒë∆°n</button>
            <button id="btnSavePrint" class="btn btn-green">üßæ L∆∞u + In bill</button>
          </div>
        </div>

        <!-- Right: QR order info (t√≥m t·∫Øt ƒë∆°n b√†n ƒëang k√©o sang POS) -->
        <div class="card">
          <div class="section-title">ƒê∆°n t·ª´ QR (n·∫øu c√≥)</div>
          <div id="qrOrderPreview" class="order-lines muted">
            Ch·ªçn b√†n b√™n tab ‚ÄúQR Order‚Äù ƒë·ªÉ k√©o ƒë∆°n sang POS.
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE: QR ORDER -->
    <div id="page-qr" class="page">
      <div class="section-title">QR Order ‚Äì ƒê∆°n kh√°ch g·ª≠i t·ª´ order.html</div>
      <p class="muted" style="margin-bottom:6px;">
        M·ªü <span class="tag">order.html?table=1..20</span> cho kh√°ch qu√©t QR.  
        Ch·ªçn b√†n ƒë·ªÉ xem ƒë∆°n m·ªõi & ƒë·∫©y v√†o POS.
      </p>

      <div style="margin-bottom:10px;display:flex;flex-wrap:wrap;gap:6px;">
        <span class="section-title" style="margin-right:10px;margin-bottom:0;">Ch·ªçn b√†n</span>
        <div id="qrTableButtons" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
        <button id="btnReloadQR" class="btn-xs btn-xs-blue" style="margin-left:6px;">‚Üª T·∫£i ƒë∆°n m·ªõi</button>
      </div>

      <div class="card">
        <div class="section-title">ƒê∆°n QR c·ªßa b√†n ƒëang ch·ªçn</div>
        <div id="qrOrderList" class="order-lines">Ch∆∞a ch·ªçn b√†n.</div>
      </div>
    </div>

    <!-- PAGE: MENU MANAGER -->
    <div id="page-menu" class="page">
      <div class="section-title">Menu Tea Neko</div>
      <p class="muted">
        Menu ƒë∆∞·ª£c d√πng cho POS & QR order. B·∫°n c√≥ th·ªÉ th√™m m√≥n m·ªõi, ch·ªânh gi√°‚Ä¶  
        (C√°c m√≥n m·∫∑c ƒë·ªãnh theo h√¨nh menu b·∫°n g·ª≠i).
      </p>

      <table id="menuTable">
        <thead>
          <tr>
            <th>Nh√≥m</th>
            <th>T√™n m√≥n</th>
            <th>Size</th>
            <th>Gi√° (ƒë)</th>
            <th>TT</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="card" style="margin-top:10px;">
        <div class="section-title">Th√™m m√≥n m·ªõi</div>
        <div style="display:grid;grid-template-columns:1.1fr 1.6fr 0.6fr 0.8fr;gap:8px;align-items:flex-end;">
          <div>
            <label class="muted">Nh√≥m</label>
            <input id="newMenuCategory" placeholder="VD: Latte / Tr√† s·ªØa / Cacao..." />
          </div>
          <div>
            <label class="muted">T√™n m√≥n</label>
            <input id="newMenuName" placeholder="VD: Matcha Latte" />
          </div>
          <div>
            <label class="muted">Size</label>
            <input id="newMenuSize" placeholder="M / L" />
          </div>
          <div>
            <label class="muted">Gi√° (ƒë)</label>
            <input id="newMenuPrice" type="number" min="0" step="1000" placeholder="25000" />
          </div>
        </div>
        <button id="btnAddMenuItem" class="btn btn-green" style="margin-top:10px;max-width:200px;">
          + Th√™m m√≥n
        </button>
        <div id="menuMessage" class="muted" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- PAGE: INVENTORY -->
    <div id="page-inventory" class="page">
      <div class="section-title">T·ªìn kho nguy√™n li·ªáu</div>
      <p class="muted">SL hi·ªán t·∫°i nh·∫≠p cu·ªëi ca (kh√¥ng t·ª± tr·ª´). C√≥ th·ªÉ th√™m nguy√™n li·ªáu m·ªõi, c·∫≠p nh·∫≠t nhanh.</p>

      <table id="inventoryTable">
        <thead>
          <tr>
            <th>T√™n nguy√™n li·ªáu</th>
            <th>ƒê∆°n v·ªã</th>
            <th>SL hi·ªán t·∫°i</th>
            <th>Ghi ch√∫</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="card" style="margin-top:10px;">
        <div class="section-title">Th√™m nguy√™n li·ªáu</div>
        <div style="display:grid;grid-template-columns:1.6fr 0.7fr 0.7fr 1.5fr;gap:8px;align-items:flex-end;">
          <div>
            <label class="muted">T√™n nguy√™n li·ªáu</label>
            <input id="newMatName" placeholder="VD: B·ªôt matcha" />
          </div>
          <div>
            <label class="muted">ƒê∆°n v·ªã</label>
            <input id="newMatUnit" placeholder="kg / g√≥i / chai..." />
          </div>
          <div>
            <label class="muted">SL hi·ªán t·∫°i</label>
            <input id="newMatQty" type="number" step="0.1" class="small-input" />
          </div>
          <div>
            <label class="muted">Ghi ch√∫</label>
            <input id="newMatNote" placeholder="tu·ª≥ ch·ªçn" />
          </div>
        </div>
        <button id="btnAddMaterial" class="btn btn-green" style="margin-top:10px;max-width:220px;">
          + Th√™m nguy√™n li·ªáu
        </button>
        <div id="inventoryMessage" class="muted" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- PAGE: HISTORY -->
    <div id="page-history" class="page">
      <div class="section-title">L·ªãch s·ª≠ ƒë∆°n</div>
      <p class="muted">Xem c√°c ƒë∆°n ƒë√£ l∆∞u. C√≥ th·ªÉ in bill ho·∫∑c xo√° (chuy·ªÉn sang m·ª•c ƒê√£ xo√°).</p>

      <table id="historyTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Th·ªùi gian</th>
            <th>N·ªôi dung</th>
            <th>T·ªïng (ƒë)</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- PAGE: DELETED -->
    <div id="page-deleted" class="page">
      <div class="section-title">ƒê∆°n ƒë√£ xo√°</div>
      <p class="muted">
        L·ªãch s·ª≠ xo√° ƒë∆°n (kh√¥ng xo√° ti·∫øp, ch·ªâ xem). D√πng ƒë·ªÉ ƒë·ªëi so√°t doanh thu.
      </p>

      <table id="deletedTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Xo√° l√∫c</th>
            <th>N·ªôi dung</th>
            <th>T·ªïng (ƒë)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- LOGIC -->
  <script type="module">
    import { supabase } from "./js/supabase.js";

    // ====== MENU M·∫∂C ƒê·ªäNH (theo h√¨nh b·∫°n g·ª≠i, r√∫t g·ªçn) ======
    const DEFAULT_MENU = [
      // Espresso
      { category: "Espresso", name: "Phin ƒëen",       size: "M", price: 20000 },
      { category: "Espresso", name: "Phin s·ªØa",       size: "M", price: 22000 },
      { category: "Espresso", name: "Americano",      size: "M", price: 25000 },

      // Latte
      { category: "Latte",    name: "Matcha Latte",   size: "M", price: 25000 },
      { category: "Latte",    name: "Cacao Latte",    size: "M", price: 28000 },

      // Tr√† s·ªØa
      { category: "Tr√† s·ªØa",  name: "H·ªìng tr√† s·ªØa",   size: "M", price: 28000 },
      { category: "Tr√† s·ªØa",  name: "Tr√† s·ªØa tr√¢n ch√¢u", size: "M", price: 30000 }
    ];

    // ====== STATE ======
    let menuItems = [];
    let currentOrder = { items: [], note: "", cashGiven: 0 };
    let currentQRTable = null;

    // ===== TAB HANDLING =====
    const tabButtons = document.querySelectorAll(".tab-btn");
    const pages = document.querySelectorAll(".page");

    function showPage(pageId) {
      pages.forEach(p => p.classList.toggle("active", p.id === "page-" + pageId));
      tabButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.page === pageId);
      });
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const page = btn.dataset.page;
        showPage(page);
        if (page === "history") loadHistory();
        if (page === "deleted") loadDeleted();
        if (page === "inventory") loadInventory();
        if (page === "menu") loadMenuFromDB(); // ƒë·∫£m b·∫£o menu m·ªõi nh·∫•t
        if (page === "qr") loadQROrders();
      });
    });

    // ===== POS ‚Äì MENU RENDERING =====
    function groupMenuItemsByCategory(items) {
      const groups = {};
      for (const item of items) {
        const cat = item.category || "Kh√°c";
        if (!groups[cat]) groups[cat] = [];
        groups[cat].push(item);
      }
      return groups;
    }

    function renderPosMenu() {
      const container = document.getElementById("posMenuContainer");
      container.innerHTML = "";
      if (!menuItems.length) {
        container.innerHTML = '<div class="danger-text">Ch∆∞a c√≥ m√≥n trong Menu.</div>';
        return;
      }
      const groups = groupMenuItemsByCategory(menuItems);
      for (const cat of Object.keys(groups)) {
        const title = document.createElement("div");
        title.className = "section-title";
        title.textContent = cat;
        container.appendChild(title);

        const grid = document.createElement("div");
        grid.className = "menu-grid";
        groups[cat].forEach(item => {
          const btn = document.createElement("button");
          btn.className = "menu-item-btn";
          btn.innerHTML =
            '<div class="menu-item-name">' + item.name + '</div>' +
            '<div class="menu-item-price">' +
            new Intl.NumberFormat("vi-VN").format(item.price) +
            "ƒë (Size " + (item.size || "M") + ")</div>";
          btn.addEventListener("click", () => addItemToCurrentOrder(item));
          grid.appendChild(btn);
        });
        container.appendChild(grid);
      }
    }

    function addItemToCurrentOrder(menuItem) {
      const key = menuItem.id || (menuItem.category + "|" + menuItem.name + "|" + (menuItem.size || ""));
      let line = currentOrder.items.find(l => l.key === key);
      if (!line) {
        line = {
          key,
          name: menuItem.name,
          category: menuItem.category,
          size: menuItem.size || "",
          price: menuItem.price,
          qty: 0
        };
        currentOrder.items.push(line);
      }
      line.qty += 1;
      renderCurrentOrder();
    }

    function renderCurrentOrder() {
      const linesDiv = document.getElementById("currentOrderLines");
      const summaryDiv = document.getElementById("currentOrderSummary");
      if (!currentOrder.items.length) {
        linesDiv.textContent = "Ch∆∞a c√≥ m√≥n n√†o.";
        summaryDiv.textContent = "";
        updateChangeDisplay();
        return;
      }

      let text = "";
      let total = 0;
      for (const line of currentOrder.items) {
        const lineTotal = line.price * line.qty;
        total += lineTotal;
        text += `‚Ä¢ ${line.qty}x ${line.name}${line.size ? " (Size " + line.size + ")" : ""} ‚Äì ${lineTotal.toLocaleString("vi-VN")}ƒë\n`;
      }
      linesDiv.textContent = text.trim();
      summaryDiv.textContent = "T·ªïng: " + total.toLocaleString("vi-VN") + "ƒë";
      currentOrder.total = total;
      updateChangeDisplay();
    }

    function updateChangeDisplay() {
      const div = document.getElementById("changeDisplay");
      const cash = Number(currentOrder.cashGiven || 0) * 1000;
      const total = Number(currentOrder.total || 0);
      const change = Math.max(cash - total, 0);
      div.textContent = "Ti·ªÅn tr·∫£ l·∫°i kh√°ch: " + change.toLocaleString("vi-VN") + "ƒë";
    }

    // ----- POS buttons -----
    document.getElementById("cashGivenInput").addEventListener("input", (e) => {
      currentOrder.cashGiven = e.target.value;
      updateChangeDisplay();
    });

    document.getElementById("btnUndo").addEventListener("click", () => {
      if (!currentOrder.items.length) return;
      const last = currentOrder.items[currentOrder.items.length - 1];
      last.qty -= 1;
      if (last.qty <= 0) currentOrder.items.pop();
      renderCurrentOrder();
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      if (!currentOrder.items.length) return;
      if (!confirm("Xo√° to√†n b·ªô m√≥n hi·ªán t·∫°i?")) return;
      currentOrder.items = [];
      renderCurrentOrder();
    });

    document.getElementById("btnSave").addEventListener("click", () => saveCurrentOrder(false));
    document.getElementById("btnSavePrint").addEventListener("click", () => saveCurrentOrder(true));

    async function saveCurrentOrder(shouldPrint) {
      if (!currentOrder.items.length) {
        alert("Ch∆∞a c√≥ m√≥n n√†o trong ƒë∆°n.");
        return;
      }
      const note = document.getElementById("orderNote").value.trim();
      currentOrder.note = note;
      const cash = Number(currentOrder.cashGiven || 0) * 1000;
      const total = Number(currentOrder.total || 0);
      const change = Math.max(cash - total, 0);

      const orderCode = "#" + Date.now().toString().slice(-4);

      const payload = {
        order_code: orderCode,
        items: currentOrder.items,
        total: total,
        cash_given: cash,
        change: change,
        note: note
      };

      const { data, error } = await supabase.from("orders").insert(payload).select().single();
      if (error) {
        console.error(error);
        alert("L∆∞u ƒë∆°n th·∫•t b·∫°i.");
        return;
      }

      if (shouldPrint) {
        printOrder(data);
      }

      // reset
      currentOrder = { items: [], note: "", cashGiven: 0, total: 0 };
      document.getElementById("orderNote").value = "";
      document.getElementById("cashGivenInput").value = "";
      renderCurrentOrder();

      alert("ƒê√£ l∆∞u ƒë∆°n " + orderCode);
      loadHistory(); // c·∫≠p nh·∫≠t tab l·ªãch s·ª≠ (n·∫øu ƒëang m·ªü)
    }

    function printOrder(order) {
      const w = window.open("", "_blank");
      if (!w) {
        alert("Tr√¨nh duy·ªát ch·∫∑n c·ª≠a s·ªï in bill.");
        return;
      }
      let html = "<html><head><title>Ho√° ƒë∆°n Tea Neko</title></head><body style='font-family:system-ui,Arial,sans-serif;padding:16px;'>";
      html += "<h2 style='margin:0 0 8px;'>Tea Neko ‚Äì Ho√° ƒë∆°n</h2>";
      html += "<div>M√£ ƒë∆°n: " + (order.order_code || "") + "</div>";
      html += "<div>Th·ªùi gian: " + new Date(order.created_at || Date.now()).toLocaleString("vi-VN") + "</div>";
      html += "<hr/>";
      html += "<pre style='font-size:13px;'>";
      let total = 0;
      (order.items || []).forEach(l => {
        const lineTotal = l.price * l.qty;
        total += lineTotal;
        html += `${l.qty}x ${l.name}${l.size ? " (" + l.size + ")" : ""} ‚Äì ${lineTotal.toLocaleString("vi-VN")}ƒë\n`;
      });
      html += "</pre>";
      html += "<div><strong>T·ªïng: " + total.toLocaleString("vi-VN") + "ƒë</strong></div>";
      html += "<div>Kh√°ch ƒë∆∞a: " + (order.cash_given || 0).toLocaleString("vi-VN") + "ƒë</div>";
      html += "<div>Tr·∫£ l·∫°i kh√°ch: " + (order.change || 0).toLocaleString("vi-VN") + "ƒë</div>";
      if (order.note) {
        html += "<div>Ghi ch√∫: " + order.note + "</div>";
      }
      html += "<hr/><div style='margin-top:8px;font-size:12px;'>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko üíú</div>";
      html += "</body></html>";
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    // ===== HISTORY =====
    async function loadHistory() {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "<tr><td colspan='5' class='muted'>ƒêang t·∫£i...</td></tr>";

      const { data, error } = await supabase
        .from("orders")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(200);

      if (error) {
        console.error(error);
        tbody.innerHTML = "<tr><td colspan='5' class='danger-text'>L·ªói t·∫£i l·ªãch s·ª≠.</td></tr>";
        return;
      }

      if (!data.length) {
        tbody.innerHTML = "<tr><td colspan='5' class='muted'>Ch∆∞a c√≥ ƒë∆°n n√†o.</td></tr>";
        return;
      }

      tbody.innerHTML = "";
      data.forEach((order, idx) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;

        const tdTime = document.createElement("td");
        tdTime.textContent = new Date(order.created_at).toLocaleString("vi-VN");

        const tdContent = document.createElement("td");
        let text = "";
        (order.items || []).forEach(l => {
          const lt = l.price * l.qty;
          text += `${l.qty}x ${l.name}${l.size ? " (" + l.size + ")" : ""} ‚Äì ${lt.toLocaleString("vi-VN")}ƒë\n`;
        });
        if (order.note) {
          text += "Ghi ch√∫: " + order.note;
        }
        tdContent.innerHTML = "<pre style='margin:0;font-family:inherit;font-size:12px;white-space:pre-line;'>" +
          text + "</pre>";

        const tdTotal = document.createElement("td");
        tdTotal.textContent = (order.total || 0).toLocaleString("vi-VN") + "ƒë";

        const tdActions = document.createElement("td");
        tdActions.className = "table-actions";
        const btnPrint = document.createElement("button");
        btnPrint.className = "btn-xs btn-xs-blue";
        btnPrint.textContent = "üßæ In";
        btnPrint.onclick = () => printOrder(order);

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-xs btn-xs-red";
        btnDelete.textContent = "Xo√° ƒë∆°n";
        btnDelete.onclick = () => moveOrderToDeleted(order);

        tdActions.appendChild(btnPrint);
        tdActions.appendChild(btnDelete);

        tr.appendChild(tdIndex);
        tr.appendChild(tdTime);
        tr.appendChild(tdContent);
        tr.appendChild(tdTotal);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    async function moveOrderToDeleted(order) {
      if (!confirm("Chuy·ªÉn ƒë∆°n n√†y sang m·ª•c ƒê√£ xo√° v√† tr·ª´ doanh thu?")) return;

      const payload = {
        original_order_id: order.id,
        order_code: order.order_code,
        items: order.items,
        total: order.total,
        deleted_at: new Date().toISOString(),
        note: order.note
      };

      const { error: insertErr } = await supabase.from("deleted_orders").insert(payload);
      if (insertErr) {
        console.error(insertErr);
        alert("L∆∞u l·ªãch s·ª≠ xo√° th·∫•t b·∫°i.");
        return;
      }

      const { error: delErr } = await supabase.from("orders").delete().eq("id", order.id);
      if (delErr) {
        console.error(delErr);
        alert("Xo√° ƒë∆°n th·∫•t b·∫°i.");
        return;
      }

      await loadHistory();
      await loadDeleted();
      alert("ƒê√£ chuy·ªÉn ƒë∆°n sang m·ª•c ƒê√£ xo√°.");
    }

    async function loadDeleted() {
      const tbody = document.querySelector("#deletedTable tbody");
      tbody.innerHTML = "<tr><td colspan='4' class='muted'>ƒêang t·∫£i...</td></tr>";

      const { data, error } = await supabase
        .from("deleted_orders")
        .select("*")
        .order("deleted_at", { ascending: false })
        .limit(200);

      if (error) {
        console.error(error);
        tbody.innerHTML = "<tr><td colspan='4' class='danger-text'>L·ªói t·∫£i l·ªãch s·ª≠ xo√°.</td></tr>";
        return;
      }

      if (!data.length) {
        tbody.innerHTML = "<tr><td colspan='4' class='muted'>Ch∆∞a c√≥ ƒë∆°n n√†o.</td></tr>";
        return;
      }

      tbody.innerHTML = "";
      data.forEach((order, idx) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;

        const tdTime = document.createElement("td");
        tdTime.textContent = new Date(order.deleted_at || order.created_at).toLocaleString("vi-VN");

        const tdContent = document.createElement("td");
        let text = "";
        (order.items || []).forEach(l => {
          const lt = l.price * l.qty;
          text += `${l.qty}x ${l.name}${l.size ? " (" + l.size + ")" : ""} ‚Äì ${lt.toLocaleString("vi-VN")}ƒë\n`;
        });
        if (order.note) text += "Ghi ch√∫: " + order.note;
        tdContent.innerHTML = "<pre style='margin:0;font-family:inherit;font-size:12px;white-space:pre-line;'>" +
          text + "</pre>";

        const tdTotal = document.createElement("td");
        tdTotal.textContent = (order.total || 0).toLocaleString("vi-VN") + "ƒë";

        tr.appendChild(tdIndex);
        tr.appendChild(tdTime);
        tr.appendChild(tdContent);
        tr.appendChild(tdTotal);
        tbody.appendChild(tr);
      });
    }

    // ===== MENU MANAGER =====
    async function loadMenuFromDB() {
      const { data, error } = await supabase
        .from("menu_items")
        .select("*")
        .order("category", { ascending: true })
        .order("sort_order", { ascending: true });

      if (error) {
        console.error(error);
        document.querySelector("#menuMessage").textContent = "L·ªói t·∫£i menu DB, d√πng menu m·∫∑c ƒë·ªãnh.";
        menuItems = DEFAULT_MENU.slice();
      } else if (!data.length) {
        // seed ban ƒë·∫ßu
        const seedPayload = DEFAULT_MENU.map((m, idx) => ({
          category: m.category,
          name: m.name,
          size: m.size,
          price: m.price,
          is_active: true,
          sort_order: idx + 1
        }));
        await supabase.from("menu_items").insert(seedPayload);
        menuItems = seedPayload;
      } else {
        menuItems = data.filter(m => m.is_active !== false);
      }

      renderPosMenu();
      renderMenuTable();
    }

    function renderMenuTable() {
      const tbody = document.querySelector("#menuTable tbody");
      tbody.innerHTML = "";
      if (!menuItems.length) {
        tbody.innerHTML = "<tr><td colspan='6' class='muted'>Ch∆∞a c√≥ m√≥n trong Menu.</td></tr>";
        return;
      }
      menuItems.forEach((item, idx) => {
        const tr = document.createElement("tr");

        const tdCat = document.createElement("td");
        tdCat.textContent = item.category || "";

        const tdName = document.createElement("td");
        tdName.textContent = item.name;

        const tdSize = document.createElement("td");
        tdSize.textContent = item.size || "";

        const tdPrice = document.createElement("td");
        tdPrice.textContent = (item.price || 0).toLocaleString("vi-VN");

        const tdStatus = document.createElement("td");
        tdStatus.textContent = item.is_active === false ? "·∫®n" : "ƒêang b√°n";

        const tdActions = document.createElement("td");
        tdActions.className = "table-actions";
        const btnHide = document.createElement("button");
        btnHide.className = "btn-xs btn-xs-grey";
        btnHide.textContent = item.is_active === false ? "Hi·ªán" : "·∫®n";
        btnHide.onclick = () => toggleMenuItemActive(item);

        tdActions.appendChild(btnHide);

        tr.appendChild(tdCat);
        tr.appendChild(tdName);
        tr.appendChild(tdSize);
        tr.appendChild(tdPrice);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }

    async function toggleMenuItemActive(item) {
      if (!item.id) {
        alert("M√≥n n√†y ch∆∞a c√≥ id (menu m·∫∑c ƒë·ªãnh). B·∫°n s·ª≠a trong DB th·ªß c√¥ng n·∫øu c·∫ßn.");
        return;
      }
      const newVal = !item.is_active;
      const { error } = await supabase
        .from("menu_items")
        .update({ is_active: newVal })
        .eq("id", item.id);
      if (error) {
        console.error(error);
        alert("C·∫≠p nh·∫≠t tr·∫°ng th√°i m√≥n th·∫•t b·∫°i.");
        return;
      }
      document.querySelector("#menuMessage").textContent = "ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i m√≥n.";
      await loadMenuFromDB();
    }

    document.getElementById("btnAddMenuItem").addEventListener("click", async () => {
      const cat = document.getElementById("newMenuCategory").value.trim();
      const name = document.getElementById("newMenuName").value.trim();
      const size = document.getElementById("newMenuSize").value.trim() || "M";
      const price = Number(document.getElementById("newMenuPrice").value || 0);

      if (!cat || !name || !price) {
        alert("Nh·∫≠p ƒë·ªß Nh√≥m, T√™n m√≥n, Gi√°.");
        return;
      }

      const payload = {
        category: cat,
        name,
        size,
        price,
        is_active: true,
        sort_order: menuItems.length + 1
      };

      const { data, error } = await supabase.from("menu_items").insert(payload).select().single();
      if (error) {
        console.error(error);
        document.querySelector("#menuMessage").textContent = "Th√™m m√≥n th·∫•t b·∫°i.";
        return;
      }

      document.querySelector("#menuMessage").textContent = "ƒê√£ th√™m m√≥n.";
      document.getElementById("newMenuCategory").value = "";
      document.getElementById("newMenuName").value = "";
      document.getElementById("newMenuSize").value = "";
      document.getElementById("newMenuPrice").value = "";

      menuItems.push(data);
      renderPosMenu();
      renderMenuTable();
    });

    // ===== INVENTORY =====
    async function loadInventory() {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "<tr><td colspan='5' class='muted'>ƒêang t·∫£i...</td></tr>";

      const { data, error } = await supabase
        .from("raw_materials")
        .select("*")
        .order("name", { ascending: true });

      if (error) {
        console.error(error);
        tbody.innerHTML = "<tr><td colspan='5' class='danger-text'>L·ªói t·∫£i t·ªìn kho.</td></tr>";
        return;
      }

      if (!data.length) {
        tbody.innerHTML = "<tr><td colspan='5' class='muted'>Ch∆∞a c√≥ nguy√™n li·ªáu n√†o.</td></tr>";
        return;
      }

      tbody.innerHTML = "";
      data.forEach(mat => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = mat.name;

        const tdUnit = document.createElement("td");
        const unitInput = document.createElement("input");
        unitInput.value = mat.unit || "";
        unitInput.className = "very-small-input";
        tdUnit.appendChild(unitInput);

        const tdQty = document.createElement("td");
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.step = "0.1";
        qtyInput.value = mat.current_qty ?? 0;
        qtyInput.className = "very-small-input";
        tdQty.appendChild(qtyInput);

        const tdNote = document.createElement("td");
        const noteInput = document.createElement("input");
        noteInput.value = mat.note || "";
        tdNote.appendChild(noteInput);

        const tdActions = document.createElement("td");
        const btnSave = document.createElement("button");
        btnSave.className = "btn-xs btn-xs-green";
        btnSave.textContent = "L∆∞u";
        btnSave.onclick = async () => {
          const payload = {
            unit: unitInput.value.trim(),
            current_qty: Number(qtyInput.value || 0),
            note: noteInput.value.trim()
          };
          const { error } = await supabase
            .from("raw_materials")
            .update(payload)
            .eq("id", mat.id);
          if (error) {
            console.error(error);
            document.querySelector("#inventoryMessage
                                       // ===== INVENTORY =====
    async function loadInventory() {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "<tr><td colspan='5' class='muted'>ƒêang t·∫£i...</td></tr>";

      const { data, error } = await supabase
        .from("raw_materials")
        .select("*")
        .order("name", { ascending: true });

      if (error) {
        console.error(error);
        tbody.innerHTML = "<tr><td colspan='5' class='danger-text'>L·ªói t·∫£i t·ªìn kho.</td></tr>";
        return;
      }

      if (!data.length) {
        tbody.innerHTML = "<tr><td colspan='5' class='muted'>Ch∆∞a c√≥ nguy√™n li·ªáu n√†o.</td></tr>";
        return;
      }

      tbody.innerHTML = "";
      data.forEach(mat => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = mat.name;

        const tdUnit = document.createElement("td");
        const unitInput = document.createElement("input");
        unitInput.value = mat.unit || "";
        unitInput.className = "very-small-input";
        tdUnit.appendChild(unitInput);

        const tdQty = document.createElement("td");
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.step = "0.1";
        qtyInput.value = mat.current_qty ?? 0;
        qtyInput.className = "very-small-input";
        tdQty.appendChild(qtyInput);

        const tdNote = document.createElement("td");
        const noteInput = document.createElement("input");
        noteInput.value = mat.note || "";
        tdNote.appendChild(noteInput);

        const tdActions = document.createElement("td");
        const btnSave = document.createElement("button");
        btnSave.className = "btn-xs btn-xs-green";
        btnSave.textContent = "L∆∞u";
        btnSave.onclick = async () => {
          const payload = {
            unit: unitInput.value.trim(),
            current_qty: Number(qtyInput.value || 0),
            note: noteInput.value.trim()
          };
          const { error } = await supabase
            .from("raw_materials")
            .update(payload)
            .eq("id", mat.id);
          if (error) {
            console.error(error);
            document.querySelector("#inventoryMessage").textContent = "L∆∞u t·ªìn kho th·∫•t b·∫°i.";
          } else {
            document.querySelector("#inventoryMessage").textContent = "ƒê√£ l∆∞u t·ªìn kho.";
          }
        };
        tdActions.appendChild(btnSave);

        tr.appendChild(tdName);
        tr.appendChild(tdUnit);
        tr.appendChild(tdQty);
        tr.appendChild(tdNote);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    document.getElementById("btnAddMaterial").addEventListener("click", async () => {
      const name = document.getElementById("newMatName").value.trim();
      const unit = document.getElementById("newMatUnit").value.trim();
      const qty = Number(document.getElementById("newMatQty").value || 0);
      const note = document.getElementById("newMatNote").value.trim();

      if (!name) {
        alert("Nh·∫≠p t√™n nguy√™n li·ªáu.");
        return;
      }

      const payload = {
        name,
        unit,
        current_qty: qty,
        note
      };

      const { error } = await supabase.from("raw_materials").insert(payload);
      if (error) {
        console.error(error);
        document.querySelector("#inventoryMessage").textContent = "Th√™m nguy√™n li·ªáu th·∫•t b·∫°i.";
        return;
      }

      document.querySelector("#inventoryMessage").textContent = "ƒê√£ th√™m nguy√™n li·ªáu.";
      document.getElementById("newMatName").value = "";
      document.getElementById("newMatUnit").value = "";
      document.getElementById("newMatQty").value = "";
      document.getElementById("newMatNote").value = "";
      loadInventory();
    });

    // ===== QR ORDERS =====
    function renderQRTableButtons() {
      const wrap = document.getElementById("qrTableButtons");
      wrap.innerHTML = "";
      for (let i = 1; i <= 20; i++) {
        const btn = document.createElement("button");
        btn.className = "btn-xs btn-xs-blue";
        btn.textContent = "B√†n " + i;
        btn.style.background = currentQRTable === i ? "#16a34a" : "#3b82f6";
        btn.onclick = () => {
          currentQRTable = i;
          renderQRTableButtons();
          loadQROrders();
        };
        wrap.appendChild(btn);
      }
    }

    renderQRTableButtons();
    document.getElementById("btnReloadQR").addEventListener("click", loadQROrders);

    async function loadQROrders() {
      const listDiv = document.getElementById("qrOrderList");
      if (!currentQRTable) {
        listDiv.textContent = "Ch∆∞a ch·ªçn b√†n.";
        return;
      }
      listDiv.textContent = "ƒêang t·∫£i ƒë∆°n QR c·ªßa b√†n " + currentQRTable + "...";

      const { data, error } = await supabase
        .from("web_orders")
        .select("*")
        .eq("table_no", currentQRTable)
        .order("created_at", { ascending: false })
        .limit(5);

      if (error) {
        console.error(error);
        listDiv.textContent = "L·ªói t·∫£i ƒë∆°n QR.";
        return;
      }
      if (!data.length) {
        listDiv.textContent = "Ch∆∞a c√≥ ƒë∆°n n√†o t·ª´ QR cho b√†n n√†y.";
        return;
      }

      let html = "";
      data.forEach(order => {
        html += `[#${order.id.slice(0, 6)}] ${new Date(order.created_at).toLocaleTimeString("vi-VN")} ‚Äì `;
        html += (order.status || "NEW");
        html += "\n";
        (order.items || []).forEach(l => {
          const t = l.price * l.qty;
          html += `  ‚Ä¢ ${l.qty}x ${l.name}${l.size ? " (" + l.size + ")" : ""} ‚Äì ${t.toLocaleString("vi-VN")}ƒë\n`;
        });
        if (order.note) html += "  Ghi ch√∫: " + order.note + "\n";
        html += "  [ƒê∆∞a v√†o POS]  [H·ªßy]\n\n";
      });

      listDiv.textContent = html.trim();

      // L·∫•y ƒë∆°n m·ªõi nh·∫•t ƒë·ªÉ ƒë·∫©y sang POS
      const latest = data[0];
      const previewDiv = document.getElementById("qrOrderPreview");
      let prevText = "";
      (latest.items || []).forEach(l => {
        const t = l.price * l.qty;
        prevText += `‚Ä¢ ${l.qty}x ${l.name}${l.size ? " (" + l.size + ")" : ""} ‚Äì ${t.toLocaleString("vi-VN")}ƒë\n`;
      });
      previewDiv.textContent =
        `B√†n ${currentQRTable} ‚Äì ƒë∆°n m·ªõi nh·∫•t:\n` +
        prevText.trim() +
        "\n\nB·∫•m v√πng n√†y ƒë·ªÉ k√©o ƒë∆°n n√†y v√†o POS.";

      previewDiv.dataset.orderId = latest.id;
      previewDiv.onclick = async () => {
        if (!confirm("K√©o ƒë∆°n QR m·ªõi nh·∫•t c·ªßa b√†n " + currentQRTable + " v√†o POS?")) return;
        currentOrder.items = (latest.items || []).map(l => ({
          key: l.name + "|" + (l.size || ""),
          name: l.name,
          category: l.category,
          size: l.size,
          price: l.price,
          qty: l.qty
        }));
        renderCurrentOrder();
        showPage("pos");
      };
    }

    // INIT
    async function init() {
      renderCurrentOrder();
      await loadMenuFromDB();
    }
    init();
  </script>
</body>
</html>
