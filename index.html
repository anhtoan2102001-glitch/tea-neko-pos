<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mini POS ‚Äì Tea Neko</title>

<style>
    body {
        margin: 0;
        background: #0b1220;
        font-family: system-ui, sans-serif;
        color: #fff;
    }

    .tabs {
        display: flex;
        justify-content: center;
        background: #101a30;
        padding: 10px;
        gap: 20px;
    }

    .tab {
        padding: 10px 20px;
        border-radius: 10px;
        background: #222d46;
        cursor: pointer;
        font-weight: 700;
    }

    .tab.active {
        background: #3b5bff;
    }

    .box {
        background: #111a30;
        margin: 20px;
        padding: 18px;
        border-radius: 14px;
        box-shadow: 0 0 6px #0008;
    }

    h2 { margin-top: 0; }
    .btn {
        margin-top: 10px;
        padding: 12px;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
    }

    .btn-red { background: #d63636; }
    .btn-blue { background: #0044ff; }
    .btn-green { background: #00ff90; color: #002a15; }
    .btn-gray { background: #555; }

    .order-item {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #444;
    }

    .del-btn {
        padding: 6px 12px;
        background: #d63636;
        border-radius: 6px;
        margin-left: 10px;
        cursor: pointer;
    }
</style>
</head>

<body>

<!-- ======================= MENU TAB ======================= -->
<div class="tabs">
    <div class="tab active" onclick="showTab('pos')">POS</div>
    <div class="tab" onclick="showTab('history')">L·ªãch s·ª≠</div>
    <div class="tab" onclick="showTab('deleted')">ƒê√£ xo√°</div>
</div>

<!-- ======================= POS ======================= -->
<div id="pos" class="tab-page">

    <h2>Mini POS ‚Äì Tea Neko</h2>

    <div class="box">
        <div id="current-list">Ch∆∞a c√≥ m√≥n n√†o.</div>
        <div style="margin-top:6px; font-size:18px; font-weight:700;">
            T·ªïng: <span id="current-total">0ƒë</span>
        </div>

        <input id="cash" type="number" placeholder="Kh√°ch ƒë∆∞a (ngh√¨n)" style="width:100%; padding:10px; margin-top:10px; border-radius:8px;" />

        <textarea id="note" placeholder="Ghi ch√∫ ƒë∆°n..." style="width:100%; padding:10px; border-radius:8px; margin-top:10px;"></textarea>

        <div class="btn btn-gray" onclick="undo()">‚Ü© Ho√†n t√°c</div>
        <div class="btn btn-red" onclick="clearAll()">Xo√° t·∫•t c·∫£</div>
        <div class="btn btn-blue" onclick="saveOrder()">üíæ L∆∞u ƒë∆°n</div>
        <div class="btn btn-green" onclick="saveAndPrint()">üñ® L∆∞u + In bill</div>
    </div>

</div>

<!-- ======================= HISTORY ======================= -->
<div id="history" class="tab-page" style="display:none;">
    <h2>L·ªãch s·ª≠ ƒë∆°n</h2>

    <div class="box">
        <div id="history-list">ƒêang t·∫£i...</div>
        <div class="btn btn-gray" onclick="loadHistory()">‚Üª T·∫£i l·∫°i</div>
    </div>
</div>

<!-- ======================= DELETED ======================= -->
<div id="deleted" class="tab-page" style="display:none;">
    <h2>ƒê∆°n ƒë√£ xo√°</h2>

    <div class="box">
        <div id="deleted-list">ƒêang t·∫£i...</div>
        <div class="btn btn-gray" onclick="loadDeleted()">‚Üª T·∫£i l·∫°i</div>
    </div>
</div>

<!-- ======================= SCRIPT ======================= -->
<script type="module">

// =============== SUPABASE ===============
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
    "https://kcrchwedlrettpkucoct.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw"
);

// ================= TAB ==================
function showTab(tab) {
    document.querySelectorAll(".tab-page").forEach(e => e.style.display = "none");
    document.getElementById(tab).style.display = "block";

    document.querySelectorAll(".tab").forEach(e => e.classList.remove("active"));
    event.target.classList.add("active");

    if (tab === "history") loadHistory();
    if (tab === "deleted") loadDeleted();
}

// ================= POS ==================
let current = [];

function renderCurrent() {
    if (current.length === 0) {
        document.getElementById("current-list").innerHTML = "Ch∆∞a c√≥ m√≥n n√†o.";
        document.getElementById("current-total").innerText = "0ƒë";
        return;
    }

    let html = "";
    let total = 0;

    current.forEach((item, i) => {
        html += `
            <div class="order-item">
                ${item.qty}x ${item.name} ‚Äî ${(item.qty * item.price).toLocaleString()}ƒë
                <span class="del-btn" onclick="removeItem(${i})">X</span>
            </div>
        `;
        total += item.qty * item.price;
    });

    document.getElementById("current-list").innerHTML = html;
    document.getElementById("current-total").innerText = total.toLocaleString() + "ƒë";
}

window.removeItem = (i) => {
    current.splice(i, 1);
    renderCurrent();
};

window.undo = () => {
    current.pop();
    renderCurrent();
};

window.clearAll = () => {
    if (confirm("Xo√° to√†n b·ªô ƒë∆°n hi·ªán t·∫°i?")) {
        current = [];
        renderCurrent();
    }
};

async function saveOrder() {
    if (current.length === 0) return alert("Ch∆∞a c√≥ m√≥n ƒë·ªÉ l∆∞u!");

    const note = document.getElementById("note").value;

    await supabase.from("orders").insert([
        {
            items: current,
            total: current.reduce((t, i) => t + i.qty * i.price, 0),
            note
        }
    ]);

    alert("ƒê√£ l∆∞u ƒë∆°n!");
    current = [];
    renderCurrent();
}

async function saveAndPrint() {
    await saveOrder();
    print();
}

// =================== HISTORY ====================
async function loadHistory() {
    const { data } = await supabase.from("orders").select("*").order("created_at", { ascending:false });

    let html = "";

    data.forEach(order => {
        html += `
            <div class="order-item">
                <b>#${order.id}</b> ‚Äî ${new Date(order.created_at).toLocaleString()}
                <br>
                ${order.items.map(i => `${i.qty}x ${i.name}`).join(", ")}
                <br>
                <b>${order.total.toLocaleString()}ƒë</b>
                <span class="del-btn" onclick="deleteOrder(${order.id})">Xo√°</span>
            </div>
        `;
    });

    document.getElementById("history-list").innerHTML = html || "Ch∆∞a c√≥ ƒë∆°n.";
}

async function deleteOrder(id) {
    if (!confirm("Xo√° ƒë∆°n n√†y?")) return;

    // copy sang deleted_orders
    const { data } = await supabase.from("orders").select("*").eq("id", id).single();
    await supabase.from("deleted_orders").insert([data]);

    // xo√° kh·ªèi orders
    await supabase.from("orders").delete().eq("id", id);

    loadHistory();
    loadDeleted();
}

// =================== DELETED ====================
async function loadDeleted() {
    const { data } = await supabase.from("deleted_orders").select("*").order("deleted_at", { ascending:false });

    let html = "";

    data.forEach(order => {
        html += `
            <div class="order-item">
                <b>#${order.id}</b> ‚Äî ƒê√£ xo√° l√∫c ${new Date(order.deleted_at).toLocaleString()}
                <br>
                ${order.items.map(i => `${i.qty}x ${i.name}`).join(", ")}
                <br>
                <b>${order.total.toLocaleString()}ƒë</b>
            </div>
        `;
    });

    document.getElementById("deleted-list").innerHTML = html || "Ch∆∞a c√≥ ƒë∆°n xo√°.";
}

</script>

</body>
</html>
