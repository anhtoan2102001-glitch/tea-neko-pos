<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini POS – Tea Neko</title>

<style>
body {
  margin: 0; padding: 0;
  font-family: Arial, sans-serif;
  background: #0b1122;
  color: white;
}
.container {
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
.box {
  background: #111a33;
  padding: 16px;
  border-radius: 14px;
  margin-bottom: 20px;
  border: 1px solid #334155;
}
h2 { margin-top: 0; color: #38bdf8; }
button {
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}
.blue { background: #2563eb; color: white; }
.green { background: #16a34a; color: white; }
.red { background: #dc2626; color: white; }
</style>
</head>

<body>
<div class="container">

<h1>Mini POS – Tea Neko</h1>

<!-- ==============================
      MỤC 1 – MENU CHỌN MÓN
================================ -->
<div class="box">
  <h2>Menu</h2>

  <button class="blue" onclick="setSize('M')">Size M</button>
  <button class="blue" onclick="setSize('L')">Size L (+5,000)</button>

  <div id="menuList"></div>
</div>

<!-- ==============================
      MỤC 2 – ĐƠN HIỆN TẠI
================================ -->
<div class="box">
  <h2>Đơn hiện tại</h2>

  <div id="currentOrder">Chưa có món nào.</div>
  <div><b>Tổng:</b> <span id="totalPrice">0</span> VND</div>

  <label>Khách đưa (VND):</label><br>
  <input id="cashGiven" type="number" style="width:100%;margin-top:6px;">

  <div style="margin-top:10px;">
    <b>Tiền trả lại khách:</b> <span id="change">0</span> VND
  </div>

  <label style="margin-top:10px;">Ghi chú đơn:</label>
  <input id="note" type="text" style="width:100%;margin-top:6px;">

  <br><br>
  <button class="red" onclick="clearOrder()">Xóa tất cả</button>
  <button class="blue" onclick="saveOrder()">Lưu đơn</button>
  <button class="green" onclick="saveAndPrint()">Lưu + In bill</button>
</div>

<!-- ==============================
      MỤC 3 – LỊCH SỬ ĐƠN
================================ -->
<div class="box">
  <h2>Lịch sử đơn</h2>
  <div id="history"></div>
  <div style="margin-top:10px;">
    <b>Tổng doanh thu:</b> <span id="revenue">0</span> VND
  </div>
</div>

<!-- ==============================
      MỤC 4 – LỊCH SỬ ĐÃ XOÁ (TRẢ LẠI)
================================ -->
<div class="box">
  <h2>Lịch sử đã xoá</h2>
  <div id="deletedHistory">Chưa có đơn xoá.</div>
</div>

</div>


<!-- ==============================
      SCRIPT SUPABASE (GỐC)
================================ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const SUPABASE_URL = "https://kcrchwedlrettpkucoct.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ------------------------------
   POS LOGIC GỐC – GIỮ NGUYÊN
-------------------------------- */
let size = "M";
const menu = [
  {name:"Matcha Latte", price:25000},
  {name:"Coffee", price:25000},
  {name:"Trà sữa trân châu", price:30000},
  {name:"Hồng trà sữa", price:28000},
  {name:"Cacao đá", price:22000},
  {name:"Bạc xỉu", price:20000},
];

let order = [];

function setSize(s){ size=s; }

function renderMenu(){
  let h="";
  menu.forEach((m,i)=>{
    h += `<button class="blue" style="margin:6px;" onclick="addItem(${i})">${m.name}<br>${m.price.toLocaleString()}đ</button>`;
  });
  document.getElementById("menuList").innerHTML = h;
}

function addItem(i){
  const item = menu[i];
  let price = item.price + (size==="L" ? 5000 : 0);
  order.push({name:item.name, size, price});
  renderOrder();
}

function renderOrder(){
  if(order.length===0){
    document.getElementById("currentOrder").innerHTML="Chưa có món nào.";
    document.getElementById("totalPrice").innerHTML=0;
    return;
  }
  let h="";
  let sum=0;
  order.forEach(o=>{
    h += `${o.name} (Size ${o.size}) — ${o.price.toLocaleString()}đ<br>`;
    sum += o.price;
  });
  document.getElementById("currentOrder").innerHTML=h;
  document.getElementById("totalPrice").innerHTML=sum.toLocaleString();
}

function clearOrder(){
  order=[];
  renderOrder();
}

async function saveOrder(){
  if(order.length===0){ alert("Chưa có món."); return; }
  const total = order.reduce((a,b)=>a+b.price,0);

  const {data, error} = await db.from("orders").insert({
    items: order,
    total: total,
    cash_given: Number(document.getElementById("cashGiven").value),
    change: Number(document.getElementById("cashGiven").value) - total,
    note: document.getElementById("note").value
  });

  if(error) alert("Lỗi lưu đơn");

  loadHistory();
  clearOrder();
}

function saveAndPrint(){
  saveOrder();
  setTimeout(()=>window.print(),500);
}

async function loadHistory(){
  const {data} = await db.from("orders").select("*").order("created_at",{ascending:false});
  let h="", rev=0;
  data.forEach(d=>{
    rev += d.total;
    h += `${d.created_at.slice(0,19)} — ${d.total.toLocaleString()}đ<br>`;
  });
  document.getElementById("history").innerHTML=h;
  document.getElementById("revenue").innerHTML=rev.toLocaleString();
}

async function loadDeleted(){
  const {data} = await db.from("deleted_orders").select("*").order("created_at",{ascending:false});
  let h="";
  data.forEach(d=>{
    h += `${d.created_at.slice(0,19)} — ĐÃ XOÁ<br>`;
  });
  document.getElementById("deletedHistory").innerHTML=h||"Chưa có đơn xoá.";
}

renderMenu();
loadHistory();
loadDeleted();

</script>

</body>
</html>
