<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini POS – Tea Neko</title>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: #0b1220;
      color: #fff;
    }

    /* =============================
         FIX NAVBAR KHÔNG CLICK ĐƯỢC
       ============================= */
    nav, .tabs, .tab-bar {
      position: relative;
      z-index: 99999 !important;
    }

    .page, .content-wrapper {
      position: relative;
      z-index: 1 !important;
    }

    .blocker,
    .overlay,
    .fullscreen,
    .page-cover {
      pointer-events: none !important;
      z-index: 0 !important;
    }

    /* ====== NAVIGATION ====== */
    .tabs {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #0f1a33;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 0;
    }
    .tabs button {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      background: #1d2a4d;
      color: white;
      cursor: pointer;
    }
    .tabs button.active {
      background: #2f5aff;
    }

    .page {
      display: none;
      padding: 12px;
    }
    .page.active {
      display: block;
    }

    /* ====== CARD ====== */
    .card {
      background: rgba(255,255,255,0.08);
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 12px;
    }

    /* ===== MENU GRID ===== */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 10px;
    }
    .menu-item {
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border: 1px solid transparent;
      transition: 0.1s;
    }
    .menu-item:hover {
      background: rgba(255,255,255,0.17);
    }

    .order-list li {
      margin: 5px 0;
    }

    /* ===== HISTORY ===== */
    .history-item {
      border-bottom: 1px dashed rgba(255,255,255,0.2);
      padding: 6px 0;
    }
    .history-delete {
      color: #ff4d4d;
      cursor: pointer;
      float: right;
    }

    /* ===== INVENTORY ===== */
    .inv-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .inv-row input {
      flex: 1;
      padding: 6px;
      border-radius: 8px;
      border: none;
    }
  </style>
</head>
<body>

<!-- ===== NAVIGATION ===== -->
<nav class="tabs">
  <button class="tab-btn active" data-tab="pos">POS</button>
  <button class="tab-btn" data-tab="qr">QR Order</button>
  <button class="tab-btn" data-tab="menu">Menu</button>
  <button class="tab-btn" data-tab="inventory">Tồn kho</button>
  <button class="tab-btn" data-tab="history">Lịch sử</button>
  <button class="tab-btn" data-tab="deleted">Đã xoá</button>
</nav>
<!-- =========================
      PAGE: POS
========================= -->
<div id="pos" class="page active">

  <div class="card">
    <h2>Menu đồ uống</h2>

    <div class="menu-grid" id="posMenuGrid"></div>
  </div>

  <div class="card">
    <h2>Đơn hiện tại</h2>
    <ul id="currentOrderList" class="order-list"></ul>

    <p><strong>Tổng:</strong> <span id="currentTotal">0</span> VND</p>
    <p>
      Khách đưa:
      <input type="number" id="cashGiven" placeholder="Nhập số tiền khách đưa" style="padding:6px;border-radius:6px;border:none;width:140px;">
    </p>
    <p><strong>Trả lại khách:</strong> <span id="customerChange">0</span> VND</p>

    <button id="btnClearOrder" style="padding:10px;border:none;border-radius:6px;background:#ff3b3b;color:#fff;width:100%;margin-top:10px;">
      Xoá đơn hiện tại
    </button>

    <button id="btnSaveOrder" style="padding:10px;border:none;border-radius:6px;background:#2f5aff;color:#fff;width:100%;margin-top:10px;">
      Lưu đơn
    </button>
  </div>

</div>
<!-- =========================
      PAGE: QR ORDER
========================= -->
<div id="qr" class="page">

  <div class="card">
    <h2>QR đặt món cho khách</h2>

    <p>Chọn bàn để xem QR hoặc nhận order:</p>

    <div id="qrTableList" style="
        display:grid;
        grid-template-columns: repeat(4,1fr);
        gap:10px;
        margin-top:10px;">
    </div>
  </div>

  <div class="card">
    <h2>Order từ khách</h2>

    <div id="qrOrderList"></div>

    <button id="btnQrClear" style="width:100%;padding:10px;border:none;border-radius:6px;background:#ff4d4d;color:#fff;">
      Xoá order khách
    </button>
  </div>

</div>
<!-- =========================
      PAGE: MENU MANAGER
========================= -->
<div id="menu" class="page">

  <div class="card">
    <h2>Quản lý menu</h2>

    <div id="menuManagerList"></div>

    <button id="btnAddMenuItem"
      style="width:100%;padding:10px;border:none;border-radius:6px;background:#2ecc71;color:#fff;margin-top:10px;">
      + Thêm món mới
    </button>
  </div>

  <div class="card">
    <h2>Thêm / sửa món</h2>

    <div class="inv-row">
      <input id="menuName" placeholder="Tên món" />
      <input id="menuPrice" type="number" placeholder="Giá (VND)" />
    </div>

    <button id="btnSaveMenu"
      style="width:100%;padding:10px;border:none;border-radius:6px;background:#3498db;color:#fff;">
      Lưu món
    </button>
  </div>

</div>
<!-- =========================
      PAGE: TỒN KHO
========================= -->
<div id="inventory" class="page">

  <div class="card">
    <h2>Tồn kho nguyên liệu</h2>

    <div id="inventoryList"></div>

    <button id="btnAddIngredient"
      style="width:100%;padding:10px;border:none;border-radius:6px;background:#27ae60;color:#fff;margin-top:10px;">
      + Thêm nguyên liệu
    </button>
  </div>

  <div class="card">
    <h2>Thêm / Sửa nguyên liệu</h2>

    <div class="inv-row">
      <input id="invName" placeholder="Tên nguyên liệu" />
      <input id="invUnit" placeholder="Đơn vị (g/ml/...)" style="max-width: 90px;" />
      <input id="invQty" type="number" placeholder="SL hiện tại" style="max-width:110px;" />
    </div>

    <button id="btnSaveInventory"
      style="width:100%;padding:10px;border:none;border-radius:6px;background:#2980b9;color:#fff;">
      Lưu nguyên liệu
    </button>
  </div>

</div>
<!-- =========================
      PAGE: LỊCH SỬ ĐƠN
========================= -->
<div id="history" class="page">

  <div class="card">
    <h2>Lịch sử đơn</h2>

    <div id="historyList"></div>

    <button id="btnRefreshHistory"
      style="width:100%;padding:10px;border:none;border-radius:6px;background:#8e44ad;color:#fff;margin-top:10px;">
      Tải lại lịch sử
    </button>
  </div>

</div>
<!-- =========================
      PAGE: ĐÃ XOÁ ĐƠN
========================= -->
<div id="deleted" class="page">

  <div class="card">
    <h2>Đơn đã xoá</h2>

    <div id="deletedList"></div>

    <button id="btnRefreshDeleted"
      style="width:100%;padding:10px;border:none;border-radius:6px;background:#c0392b;color:#fff;margin-top:10px;">
      Tải lại danh sách đã xoá
    </button>
  </div>

</div>
<script type="module">
import { supabase } from "./js/supabase.js";

/* ===========================
      BIẾN DÙNG CHUNG
=========================== */
let posMenu = [];
let currentOrder = [];
let editingMenuId = null;
let editingIngredientId = null;
let selectedTable = null;

/* ===========================
      HÀM HỖ TRỢ
=========================== */
function formatVND(x) {
  return x.toLocaleString("vi-VN");
}

function $(id) {
  return document.getElementById(id);
}

/* ===========================
      CHUYỂN TAB
=========================== */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    let tab = btn.dataset.tab;
    document.querySelectorAll(".page").forEach(pg => pg.classList.remove("active"));
    $(tab).classList.add("active");
  });
});
  /* ===========================
      LOAD MENU POS
=========================== */
async function loadMenu() {
  const { data, error } = await supabase.from("menu").select("*").order("id");
  if (!error && data) {
    posMenu = data;
  }

  let html = "";
  posMenu.forEach(item => {
    html += `
      <div class="menu-item" data-id="${item.id}">
        <div><strong>${item.name}</strong></div>
        <div>${formatVND(item.price)} VND</div>
      </div>
    `;
  });

  $("posMenuGrid").innerHTML = html;

  document.querySelectorAll(".menu-item").forEach(el => {
    el.addEventListener("click", () => {
      const id = parseInt(el.dataset.id);
      addPosItem(id);
    });
  });
}

/* ===========================
      THÊM MÓN VÀO ĐƠN
=========================== */
function addPosItem(id) {
  const item = posMenu.find(m => m.id === id);
  if (!item) return;

  const old = currentOrder.find(x => x.id === id);
  if (old) old.qty++;
  else currentOrder.push({ ...item, qty: 1 });

  renderPosOrder();
}

/* ===========================
      RENDER ĐƠN POS
=========================== */
function renderPosOrder() {
  let html = "";
  let total = 0;

  currentOrder.forEach(i => {
    total += i.price * i.qty;
    html += `
      <li>${i.qty}x ${i.name} — ${formatVND(i.price * i.qty)} VND</li>
    `;
  });

  $("currentOrderList").innerHTML = html;
  $("currentTotal").textContent = formatVND(total);

  const cash = parseInt($("cashGiven").value || 0);
  $("customerChange").textContent = formatVND(cash - total > 0 ? cash - total : 0);
}

/* ===========================
      XOÁ ĐƠN HIỆN TẠI
=========================== */
$("btnClearOrder").addEventListener("click", () => {
  if (!confirm("Bạn có chắc muốn xoá đơn hiện tại?")) return;
  currentOrder = [];
  renderPosOrder();
});

/* ===========================
      LƯU ĐƠN
=========================== */
$("btnSaveOrder").addEventListener("click", async () => {
  if (currentOrder.length === 0) return alert("Đơn trống");

  const total = currentOrder.reduce((s,i) => s + i.qty * i.price, 0);
  const cash = parseInt($("cashGiven").value || 0);
  const change = cash - total;

  const payload = {
    items: currentOrder,
    total,
    cash,
    change,
    created_at: new Date()
  };

  const { error } = await supabase.from("orders").insert([payload]);
  if (error) return alert("Lỗi lưu đơn!");

  alert("Đã lưu đơn!");
  currentOrder = [];
  $("cashGiven").value = "";
  renderPosOrder();
});
  /* ===========================
      MENU MANAGER
=========================== */
async function loadMenuManager() {
  const { data, error } = await supabase.from("menu").select("*").order("id");
  if (error) return;

  let html = "";
  data.forEach(i => {
    html += `
      <div class="history-item">
        <strong>${i.name}</strong> — ${formatVND(i.price)} VND
        <span class="history-delete" data-id="${i.id}">X</span>
      </div>
    `;
  });
  $("menuManagerList").innerHTML = html;

  document.querySelectorAll("#menuManagerList .history-delete").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = parseInt(btn.dataset.id);
      if (!confirm("Xoá món này?")) return;
      await supabase.from("menu").delete().eq("id", id);
      loadMenuManager();
      loadMenu();
    });
  });
}

$("btnAddMenuItem").addEventListener("click", () => {
  editingMenuId = null;
  $("menuName").value = "";
  $("menuPrice").value = "";
});

$("btnSaveMenu").addEventListener("click", async () => {
  const name = $("menuName").value.trim();
  const price = parseInt($("menuPrice").value || 0);

  if (!name || !price) return alert("Nhập đủ thông tin!");

  if (editingMenuId) {
    await supabase.from("menu").update({ name, price }).eq("id", editingMenuId);
  } else {
    await supabase.from("menu").insert([{ name, price }]);
  }

  loadMenuManager();
  loadMenu();
  alert("Đã lưu!");
});


/* ===========================
      INVENTORY
=========================== */
async function loadInventory() {
  const { data, error } = await supabase.from("inventory").select("*").order("id");
  if (error) return;

  let html = "";
  data.forEach(i => {
    html += `
      <div class="history-item">
        <strong>${i.name}</strong> — ${i.qty} ${i.unit}
        <span class="history-delete" data-id="${i.id}" style="color:#ff4d4d;">X</span>
      </div>
    `;
  });

  $("inventoryList").innerHTML = html;

  document.querySelectorAll("#inventoryList .history-delete").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = parseInt(btn.dataset.id);
      if (!confirm("Xoá nguyên liệu này?")) return;
      await supabase.from("inventory").delete().eq("id", id);
      loadInventory();
    });
  });
}

$("btnAddIngredient").addEventListener("click", () => {
  editingIngredientId = null;
  $("invName").value = "";
  $("invUnit").value = "";
  $("invQty").value = "";
});

$("btnSaveInventory").addEventListener("click", async () => {
  const name = $("invName").value.trim();
  const unit = $("invUnit").value.trim();
  const qty = parseInt($("invQty").value || 0);

  if (!name || !unit) return alert("Nhập đủ thông tin!");

  if (editingIngredientId) {
    await supabase.from("inventory").update({ name, unit, qty }).eq("id", editingIngredientId);
  } else {
    await supabase.from("inventory").insert([{ name, unit, qty }]);
  }

  loadInventory();
  alert("Đã lưu!");
});


/* ===========================
      HISTORY
=========================== */
async function loadHistory() {
  const { data, error } = await supabase
    .from("orders")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) return;

  let html = "";
  data.forEach(o => {
    html += `
      <div class="history-item">
        <div><strong>Món:</strong> ${
          o.items.map(i => `${i.qty}x ${i.name}`).join(", ")
        }</div>
        <div><strong>Tổng:</strong> ${formatVND(o.total)} VND</div>
        <div><strong>Ngày:</strong> ${new Date(o.created_at).toLocaleString()}</div>
        <span class="history-delete" data-id="${o.id}">X</span>
      </div>
    `;
  });

  $("historyList").innerHTML = html;

  document.querySelectorAll("#historyList .history-delete").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = parseInt(btn.dataset.id);
      if (!confirm("Xoá đơn này?")) return;

      const order = data.find(o => o.id === id);
      await supabase.from("deleted_orders").insert([order]);
      await supabase.from("orders").delete().eq("id", id);

      loadHistory();
      loadDeleted();
    });
  });
}

$("btnRefreshHistory").addEventListener("click", loadHistory);


/* ===========================
      DELETED ORDERS
=========================== */
async function loadDeleted() {
  const { data, error } = await supabase
    .from("deleted_orders")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) return;

  let html = "";
  data.forEach(o => {
    html += `
      <div class="history-item">
        <div><strong>Đơn xoá:</strong> ${
          o.items.map(i => `${i.qty}x ${i.name}`).join(", ")
        }</div>
        <div><strong>Tổng:</strong> ${formatVND(o.total)} VND</div>
        <div><strong>Ngày:</strong> ${new Date(o.created_at).toLocaleString()}</div>
      </div>
    `;
  });

  $("deletedList").innerHTML = html;
}

$("btnRefreshDeleted").addEventListener("click", loadDeleted);


/* ===========================
      KHỞI ĐỘNG HỆ THỐNG
=========================== */
loadMenu();
loadMenuManager();
loadInventory();
loadHistory();
loadDeleted();

</script>
</body>
</html>
