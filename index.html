<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Mini POS ‚Äì Tea Neko (Realtime + QR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root {
      --bg: #05060a;
      --card: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.12);
      --accent-weak: #4ade80;
      --danger: #ef4444;
      --danger-soft: rgba(239,68,68,0.15);
      --text: #e5e7eb;
      --text-sub: #9ca3af;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: var(--text);
      padding: 12px;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 20px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    header .subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 3px;
    }

    .tab-bar {
      display: flex;
      gap: 8px;
      margin: 10px 0 12px;
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 0;
      font-size: 13px;
      cursor: pointer;
      background: rgba(15,23,42,0.9);
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.12s, color 0.12s, box-shadow 0.12s, transform 0.05s;
    }

    .tab-btn span.icon {
      font-size: 15px;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #020617;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.55), 0 12px 30px rgba(34,197,94,0.25);
      transform: translateY(-1px);
    }

    .tab-btn:active {
      transform: translateY(1px);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.6);
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .grid-pos {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
    }

    @media (max-width: 750px) {
      .grid-pos {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(34,197,94,0.12), #020617 60%);
      border-radius: 16px;
      padding: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    .card-plain {
      background: rgba(15,23,42,0.95);
      border-radius: 16px;
      padding: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .menu-item {
      border-radius: 12px;
      padding: 8px;
      border: 1px solid rgba(148,163,184,0.2);
      background: linear-gradient(145deg, rgba(15,23,42,0.95), rgba(15,23,42,0.9));
      cursor: pointer;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.65);
      transition: transform 0.07s ease, box-shadow 0.08s ease, border-color 0.08s, background 0.15s;
    }

    .menu-item:hover {
      border-color: rgba(34,197,94,0.6);
      box-shadow: 0 10px 25px rgba(34,197,94,0.35);
    }

    .menu-item:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.7);
      background: linear-gradient(145deg, rgba(22,163,74,0.18), rgba(15,23,42,0.95));
    }

    .menu-name {
      font-weight: 600;
      font-size: 13px;
    }

    .menu-price {
      font-size: 11px;
      color: var(--text-sub);
    }

    .size-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .size-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 0;
      font-size: 12px;
      cursor: pointer;
      background: #020617;
      color: var(--text-sub);
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      transition: background 0.12s, color 0.12s, box-shadow 0.12s, border-color 0.12s;
    }

    .size-btn.active {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #020617;
      border-color: #4ade80;
      box-shadow: 0 0 0 1px rgba(74,222,128,0.75), 0 10px 26px rgba(34,197,94,0.5);
    }

    .cash-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
    }

    .cash-row label {
      font-size: 12px;
      color: var(--text-sub);
    }

    .cash-row input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 13px;
      outline: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.6) inset;
    }

    .btn-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
      transition: transform 0.07s, box-shadow 0.08s, filter 0.06s;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.7);
      filter: brightness(0.9);
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #020617;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #0ea5e9, #38bdf8);
    }

    .btn-ghost {
      background: rgba(15,23,42,0.8);
      border: 1px solid var(--border);
      color: var(--text-sub);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #f97373);
    }

    .order-list {
      margin-top: 6px;
      padding: 8px;
      border-radius: 12px;
      background: rgba(15,23,42,0.9);
      max-height: 220px;
      overflow-y: auto;
      font-size: 13px;
    }

    .order-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .order-line-name {
      font-size: 12px;
    }

    .order-line-qty {
      color: var(--accent-weak);
      font-size: 11px;
      margin-left: 4px;
    }

    .order-line-price {
      font-size: 12px;
      color: #e5e7eb;
    }

    .summary-block {
      margin-top: 6px;
      font-size: 13px;
    }

    .summary-block strong {
      font-size: 14px;
      color: #f9fafb;
    }

    .summary-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: var(--accent-soft);
      color: var(--accent-weak);
      gap: 4px;
    }

    .pill-danger {
      background: var(--danger-soft);
      color: #fecaca;
    }

    .list-history {
      max-height: 260px;
      overflow-y: auto;
      font-size: 12px;
      margin-top: 4px;
    }

    .history-item {
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,0.9);
      margin-bottom: 6px;
    }

    .history-header-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 3px;
      color: var(--text-sub);
    }

    .history-main-line {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .history-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .history-actions button {
      flex: 1;
      border-radius: 999px;
      padding: 3px 0;
      font-size: 11px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
    }

    .history-actions button:active {
      transform: translateY(1px);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.7);
    }

    .history-actions .btn-delete {
      background: linear-gradient(135deg, #ef4444, #f97373);
      color: #fee2e2;
    }

    .history-actions .btn-print {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
    }

    .history-actions .btn-restore {
      background: linear-gradient(135deg, #0ea5e9, #38bdf8);
      color: #e0f2fe;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .kpi-card {
      border-radius: 12px;
      padding: 8px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.25), #020617 55%);
      border: 1px solid rgba(30,64,175,0.8);
      box-shadow: 0 10px 28px rgba(30,64,175,0.75);
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-sub);
    }

    .kpi-value {
      font-size: 16px;
      font-weight: 600;
      margin-top: 4px;
    }

    .kpi-note {
      font-size: 11px;
      color: rgba(191,219,254,0.9);
      margin-top: 2px;
    }

    .stock-list {
      margin-top: 6px;
      max-height: 230px;
      overflow-y: auto;
      font-size: 12px;
    }

    .stock-item {
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,0.9);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stock-input-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .stock-input-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 12px;
      background: #020617;
      color: var(--text);
      outline: none;
    }

    .stock-input-row button {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #020617;
      box-shadow: 0 6px 16px rgba(16,185,129,0.65);
    }

    .qr-box {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-sub);
      background: rgba(15,23,42,0.9);
      border-radius: 14px;
      border: 1px dashed rgba(148,163,184,0.5);
      padding: 8px;
    }

    .qr-rows {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }

    .qr-row span {
      color: #e5e7eb;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Tea Neko ‚Äì Mini POS</h1>
    <div class="subtitle">Realtime Supabase ¬∑ QR Order 20 b√†n ¬∑ b·∫£n UI B</div>
  </header>

  <!-- TAB BAR -->
  <div class="tab-bar">
    <button class="tab-btn active" data-page="page-pos">
      <span class="icon">üßæ</span> POS
    </button>
    <button class="tab-btn" data-page="page-revenue">
      <span class="icon">üí∞</span> Doanh thu
    </button>
    <button class="tab-btn" data-page="page-history">
      <span class="icon">üìö</span> L·ªãch s·ª≠
    </button>
    <button class="tab-btn" data-page="page-stock">
      <span class="icon">üì¶</span> T·ªìn kho
    </button>
  </div>

  <!-- =========================
       PAGE POS
  ========================== -->
  <div id="page-pos" class="page active">
    <div class="grid-pos">
      <!-- C·ªôt tr√°i: menu -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Menu ƒë·ªì u·ªëng</div>
          <div class="card-sub">Ch·∫°m ƒë·ªÉ th√™m m√≥n ¬∑ SL tƒÉng theo s·ªë l·∫ßn b·∫•m</div>
        </div>

        <div class="size-row">
          <button id="sizeM" class="size-btn active">Size M</button>
          <button id="sizeL" class="size-btn">Size L (+5.000)</button>
        </div>

        <div class="menu-grid" id="menuMain"></div>

        <div class="qr-box">
          <div class="card-title" style="font-size:12px; text-transform:none; letter-spacing:0;">
            QR ƒë·∫∑t m√≥n cho kh√°ch
          </div>
          <div class="card-sub">
            M·ªói b√†n m·ªôt QR: kh√°ch m·ªü <code>order.html?table=n</code> ƒë·ªÉ g·ª≠i ƒë∆°n.
          </div>
          <div class="qr-rows">
            <div>B√†n 1 ‚Üí <span>?table=1</span></div>
            <div>B√†n 2 ‚Üí <span>?table=2</span></div>
            <div>B√†n 3 ‚Üí <span>?table=3</span></div>
            <div>B√†n 4 ‚Üí <span>?table=4</span></div>
            <div>B√†n 5 ‚Üí <span>?table=5</span></div>
            <div>B√†n 6 ‚Üí <span>?table=6</span></div>
            <div>B√†n 7 ‚Üí <span>?table=7</span></div>
            <div>B√†n 8 ‚Üí <span>?table=8</span></div>
            <div>B√†n 9 ‚Üí <span>?table=9</span></div>
            <div>B√†n 10 ‚Üí <span>?table=10</span></div>
            <div>B√†n 11 ‚Üí <span>?table=11</span></div>
            <div>B√†n 12 ‚Üí <span>?table=12</span></div>
            <div>B√†n 13 ‚Üí <span>?table=13</span></div>
            <div>B√†n 14 ‚Üí <span>?table=14</span></div>
            <div>B√†n 15 ‚Üí <span>?table=15</span></div>
            <div>B√†n 16 ‚Üí <span>?table=16</span></div>
            <div>B√†n 17 ‚Üí <span>?table=17</span></div>
            <div>B√†n 18 ‚Üí <span>?table=18</span></div>
            <div>B√†n 19 ‚Üí <span>?table=19</span></div>
            <div>B√†n 20 ‚Üí <span>?table=20</span></div>
          </div>
        </div>
      </div>

      <!-- C·ªôt ph·∫£i: ƒë∆°n hi·ªán t·∫°i & QR web orders -->
      <div class="card-plain">
        <div class="card-header">
          <div class="card-title">ƒê∆°n hi·ªán t·∫°i</div>
          <div class="card-sub" id="orderInfoSub">Ch∆∞a c√≥ m√≥n</div>
        </div>

        <div class="order-list" id="currentList"></div>

        <div class="cash-row">
          <label for="cashInput">Kh√°ch ƒë∆∞a (ngh√¨n):</label>
          <input id="cashInput" type="number" min="0" placeholder="VD: 50 (t·ª©c 50.000)" />
        </div>

        <div class="summary-block">
          <div id="currentSummary"><strong>T·ªïng:</strong> 0 VND</div>
          <div id="cashSummary" class="summary-sub"></div>
        </div>

        <div class="btn-row">
          <button class="btn btn-ghost" id="btnUndo">‚Ü© Ho√†n t√°c 1 l·∫ßn b·∫•m</button>
          <button class="btn btn-danger" id="btnClear">üßπ X√≥a h·∫øt m√≥n</button>
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn btn-secondary" id="btnSave">üíæ L∆∞u ƒë∆°n</button>
          <button class="btn btn-primary" id="btnPrint">üßæ L∆∞u + In bill</button>
        </div>

        <!-- ƒê∆†N KH√ÅCH QR -->
        <div style="margin-top:10px;" class="card-plain">
          <div class="card-header" style="margin-bottom:4px;">
            <div class="card-title" style="font-size:13px;">ƒê∆°n kh√°ch QR (web)</div>
            <button id="btnReloadWebOrders"
                    style="font-size:11px; padding:4px 10px; border-radius:999px; border:none; cursor:pointer;
                           background:rgba(31,41,55,0.9); color:#e5e7eb;">
              ‚Üª T·∫£i ƒë∆°n m·ªõi
            </button>
          </div>
          <div id="webOrdersList"
               style="max-height:200px; overflow-y:auto; font-size:12px; border-radius:10px;
                      background:#020617; padding:6px;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       PAGE REVENUE
  ========================== -->
  <div id="page-revenue" class="page">
    <div class="card-plain">
      <div class="card-header">
        <div class="card-title">T·ªïng doanh thu</div>
        <div class="card-sub">ƒê√£ tr·ª´ c√°c ƒë∆°n b·ªã xo√°</div>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">H√¥m nay</div>
          <div class="kpi-value" id="revToday">0 VND</div>
          <div class="kpi-note">T·ª´ 00:00 ƒë·∫øn hi·ªán t·∫°i</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">7 ng√†y g·∫ßn nh·∫•t</div>
          <div class="kpi-value" id="revWeek">0 VND</div>
          <div class="kpi-note">Bao g·ªìm h√¥m nay</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Th√°ng n√†y</div>
          <div class="kpi-value" id="revMonth">0 VND</div>
          <div class="kpi-note">Theo l·ªãch hi·ªán t·∫°i</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">T·ªïng t·∫•t c·∫£</div>
          <div class="kpi-value" id="revAll">0 VND</div>
          <div class="kpi-note">T·ª´ tr∆∞·ªõc t·ªõi nay</div>
        </div>
      </div>

      <div style="margin-top:10px; font-size:11px; color:var(--text-sub);">
        L∆∞u √Ω: Doanh thu ch·ªâ t√≠nh nh·ªØng ƒë∆°n trong b·∫£ng <code>orders</code> ch∆∞a b·ªã ghi l·∫°i v√†o
        <code>deleted_orders</code>.
      </div>
    </div>
  </div>

  <!-- =========================
       PAGE HISTORY
  ========================== -->
  <div id="page-history" class="page">
    <div class="card-plain">
      <div class="card-header">
        <div class="card-title">L·ªãch s·ª≠ ƒë∆°n</div>
        <div class="card-sub">Xem, in, xo√° ƒë∆°n ¬∑ L·ªãch s·ª≠ xo√° c√≥ th·ªÉ kh√¥i ph·ª•c</div>
      </div>

      <div style="display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap:10px;">
        <!-- L·ªãch s·ª≠ ƒë∆°n -->
        <div>
          <div class="card-title" style="font-size:12px; margin-bottom:2px;">ƒê∆°n ƒë√£ l∆∞u</div>
          <div class="card-sub" style="font-size:11px;">Ngu·ªìn: b·∫£ng <code>orders</code></div>
          <div class="list-history" id="historyList"></div>
        </div>

        <!-- L·ªãch s·ª≠ xo√° -->
        <div>
          <div class="card-title" style="font-size:12px; margin-bottom:2px;">L·ªãch s·ª≠ xo√°</div>
          <div class="card-sub" style="font-size:11px;">
            Kh√¥ng xo√° ƒë∆∞·ª£c ‚Äì ch·ªâ c√≥ th·ªÉ kh√¥i ph·ª•c.
          </div>
          <div class="list-history" id="deletedList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       PAGE STOCK
  ========================== -->
  <div id="page-stock" class="page">
    <div class="card-plain">
      <div class="card-header">
        <div class="card-title">T·ªìn kho nguy√™n li·ªáu</div>
        <div class="card-sub">L∆∞u c·ª•c b·ªô tr√™n thi·∫øt b·ªã ¬∑ Kh√¥ng ƒë·ªìng b·ªô Supabase</div>
      </div>

      <div class="stock-input-row">
        <input id="stockName" placeholder="T√™n nguy√™n li·ªáu (VD: B·ªôt matcha)"/>
        <input id="stockQty" type="number" placeholder="SL hi·ªán t·∫°i"/>
        <button id="btnAddStock">Th√™m</button>
      </div>

      <div class="stock-list" id="stockList"></div>

      <div style="font-size:11px; color:var(--text-sub); margin-top:6px;">
        D·ªØ li·ªáu t·ªìn kho ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát (localStorage). Cu·ªëi bu·ªïi b·∫°n c√≥ th·ªÉ s·ª≠a s·ªë l∆∞·ª£ng th·ª±c t·∫ø.
      </div>
    </div>
  </div>
</div>

<script>
  // ==========================
  // SUPABASE CONFIG
  // ==========================
  const SUPABASE_URL = "https://kcrchwedlrettpkucoct.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw";
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ==========================
  // STATE & MENU
  // ==========================
  const MENU = [
    { name: "Matcha Latte", price: 25000 },
    { name: "Tr√† s·ªØa tr√¢n ch√¢u", price: 30000 },
    { name: "Cacao ƒë√°", price: 22000 },
    { name: "Coffee", price: 25000 },
    { name: "H·ªìng tr√† s·ªØa", price: 28000 },
    { name: "B·∫°c x·ªâu", price: 20000 }
  ];

  let currentSize = "M";
  let currentOrder = [];     // [{name,size,qty,unitPrice,lineTotal}]
  let clickStack = [];       // m·ªói l·∫ßn b·∫•m: {name,size,unitPrice}
  let historyOrders = [];
  let deletedOrders = [];

  // ==========================
  // DOM
  // ==========================
  const tabBtns = document.querySelectorAll(".tab-btn");
  const pages = document.querySelectorAll(".page");

  const menuMain = document.getElementById("menuMain");
  const sizeMBtn = document.getElementById("sizeM");
  const sizeLBtn = document.getElementById("sizeL");
  const currentList = document.getElementById("currentList");
  const currentSummary = document.getElementById("currentSummary");
  const cashSummary = document.getElementById("cashSummary");
  const cashInput = document.getElementById("cashInput");
  const orderInfoSub = document.getElementById("orderInfoSub");
  const btnUndo = document.getElementById("btnUndo");
  const btnClear = document.getElementById("btnClear");
  const btnSave = document.getElementById("btnSave");
  const btnPrint = document.getElementById("btnPrint");

  const webOrdersList = document.getElementById("webOrdersList");
  const btnReloadWebOrders = document.getElementById("btnReloadWebOrders");

  const historyList = document.getElementById("historyList");
  const deletedList = document.getElementById("deletedList");

  const revTodayEl = document.getElementById("revToday");
  const revWeekEl = document.getElementById("revWeek");
  const revMonthEl = document.getElementById("revMonth");
  const revAllEl = document.getElementById("revAll");

  const stockNameInput = document.getElementById("stockName");
  const stockQtyInput = document.getElementById("stockQty");
  const btnAddStock = document.getElementById("btnAddStock");
  const stockList = document.getElementById("stockList");

  // ==========================
  // UTILS
  // ==========================
  function formatVND(x) {
    return (x || 0).toLocaleString("vi-VN") + " VND";
  }

  function setTab(pageId) {
    tabBtns.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.page === pageId);
    });
    pages.forEach(p => {
      p.classList.toggle("active", p.id === pageId);
    });
  }

  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => setTab(btn.dataset.page));
  });

  // ==========================
  // MENU & ORDER
  // ==========================
  function renderMenu() {
    MENU.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "menu-item";
      div.innerHTML = `
        <div class="menu-name">${item.name}</div>
        <div class="menu-price">${item.price.toLocaleString("vi-VN")} VND (Size M)</div>
      `;
      div.addEventListener("click", () => addItemFromMenu(item));
      menuMain.appendChild(div);
    });
  }

  function addItemFromMenu(item) {
    const basePrice = item.price;
    const unitPrice = basePrice + (currentSize === "L" ? 5000 : 0);

    // Ghi l·∫°i m·ªói l·∫ßn b·∫•m
    clickStack.push({
      name: item.name,
      size: currentSize,
      unitPrice
    });

    // T√¨m trong currentOrder xem ƒë√£ c√≥ hay ch∆∞a
    const line = currentOrder.find(
      l => l.name === item.name && l.size === currentSize
    );
    if (line) {
      line.qty += 1;
      line.lineTotal += unitPrice;
    } else {
      currentOrder.push({
        name: item.name,
        size: currentSize,
        qty: 1,
        unitPrice,
        lineTotal: unitPrice
      });
    }
    renderCurrentOrder();
  }

  function renderCurrentOrder() {
    currentList.innerHTML = "";
    if (!currentOrder.length) {
      currentList.innerHTML =
        `<div style="font-size:12px; color:#6b7280;">Ch∆∞a c√≥ m√≥n n√†o trong ƒë∆°n hi·ªán t·∫°i.</div>`;
      orderInfoSub.textContent = "Ch∆∞a c√≥ m√≥n";
    } else {
      let total = 0;
      currentOrder.forEach(line => {
        total += line.lineTotal;
        const row = document.createElement("div");
        row.className = "order-line";
        row.innerHTML = `
          <div>
            <span class="order-line-name">${line.name}</span>
            <span class="order-line-qty">${line.qty}x ¬∑ Size ${line.size}</span>
          </div>
          <div class="order-line-price">${formatVND(line.lineTotal)}</div>
        `;
        currentList.appendChild(row);
      });
      currentSummary.innerHTML = `<strong>T·ªïng:</strong> ${formatVND(total)}`;
      orderInfoSub.textContent = `${currentOrder.length} d√≤ng m√≥n ¬∑ ${clickStack.length} l·∫ßn b·∫•m`;
    }

    // T√≠nh ti·ªÅn kh√°ch ƒë∆∞a
    const cashThousand = parseInt(cashInput.value || "0", 10);
    const cash = cashThousand * 1000;
    const total = currentOrder.reduce((s, l) => s + l.lineTotal, 0);

    if (cash > 0) {
      const diff = cash - total;
      cashSummary.textContent =
        `Kh√°ch ƒë∆∞a: ${formatVND(cash)} ¬∑ Ti·ªÅn tr·∫£ l·∫°i kh√°ch: ${formatVND(Math.max(diff, 0))}`;
    } else {
      cashSummary.textContent = "";
    }
  }

  function clearCurrentOrder() {
    currentOrder = [];
    clickStack = [];
    cashInput.value = "";
    renderCurrentOrder();
  }

  function undoLastClick() {
    if (!clickStack.length) return;
    const last = clickStack.pop();
    const line = currentOrder.find(
      l => l.name === last.name && l.size === last.size
    );
    if (!line) {
      renderCurrentOrder();
      return;
    }
    if (line.qty > 1) {
      line.qty -= 1;
      line.lineTotal -= last.unitPrice;
    } else {
      const idx = currentOrder.indexOf(line);
      if (idx >= 0) currentOrder.splice(idx, 1);
    }
    renderCurrentOrder();
  }

  // ==========================
  // HISTORY & DELETED
  // ==========================
  async function loadHistory() {
    const { data, error } = await supa
      .from("orders")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(200);
    if (error) {
      console.error(error);
      historyList.innerHTML =
        `<div style="color:#fecaca;">L·ªói t·∫£i l·ªãch s·ª≠ ƒë∆°n.</div>`;
      return;
    }
    historyOrders = data || [];
    renderHistory();
    await loadDeletedOrders();
    await loadRevenue();
  }

  async function loadDeletedOrders() {
    const { data, error } = await supa
      .from("deleted_orders")
      .select("*")
      .order("deleted_at", { ascending: false })
      .limit(200);
    if (error) {
      console.error(error);
      deletedList.innerHTML =
        `<div style="color:#fecaca;">L·ªói t·∫£i l·ªãch s·ª≠ xo√°.</div>`;
      return;
    }
    deletedOrders = data || [];
    renderDeleted();
  }

  function renderHistory() {
    historyList.innerHTML = "";
    if (!historyOrders.length) {
      historyList.innerHTML =
        `<div style="color:#9ca3af;">Ch∆∞a c√≥ ƒë∆°n n√†o.</div>`;
      return;
    }
    historyOrders.forEach(order => {
      const div = document.createElement("div");
      div.className = "history-item";

      const timeStr = order.created_at
        ? new Date(order.created_at).toLocaleString("vi-VN")
        : "";

      const itemsText = (order.items || [])
        .map(it => `${it.qty || 1}x ${it.name}${it.size ? " (Size " + it.size + ")" : ""}`)
        .join(", ");

      div.innerHTML = `
        <div class="history-header-line">
          <span>M√£ ƒë∆°n: ${order.id?.slice(0, 8) || "N/A"}</span>
          <span>${timeStr}</span>
        </div>
        <div class="history-main-line">
          <span>${itemsText || "(Kh√¥ng c√≥ m√≥n)"}</span>
          <span>${formatVND(order.total || 0)}</span>
        </div>
        <div class="history-actions">
          <button class="btn-print" onclick="printBillFromHistory('${order.id}')">
            üßæ In ho√° ƒë∆°n
          </button>
          <button class="btn-delete" onclick="deleteOrder('${order.id}')">
            ‚úñ Xo√° ƒë∆°n (ƒê√£ xo√°)
          </button>
        </div>
      `;
      historyList.appendChild(div);
    });
  }

  function renderDeleted() {
    deletedList.innerHTML = "";
    if (!deletedOrders.length) {
      deletedList.innerHTML =
        `<div style="color:#9ca3af;">Ch∆∞a c√≥ ƒë∆°n n√†o b·ªã xo√°.</div>`;
      return;
    }
    deletedOrders.forEach(rec => {
      const div = document.createElement("div");
      div.className = "history-item";

      const timeStr = rec.deleted_at
        ? new Date(rec.deleted_at).toLocaleString("vi-VN")
        : "";
      const itemsText = (rec.items || [])
        .map(it => `${it.qty || 1}x ${it.name}${it.size ? " (Size " + it.size + ")" : ""}`)
        .join(", ");

      div.innerHTML = `
        <div class="history-header-line">
          <span>ƒê√£ xo√°: ${rec.order_id?.slice(0, 8) || "N/A"}</span>
          <span>${timeStr}</span>
        </div>
        <div class="history-main-line">
          <span>${itemsText || "(Kh√¥ng c√≥ m√≥n)"}</span>
          <span>${formatVND(rec.total || 0)}</span>
        </div>
        <div class="history-actions">
          <button class="btn-restore" onclick="restoreOrder('${rec.id}')">
            üîÑ Kh√¥i ph·ª•c ƒë∆°n
          </button>
        </div>
      `;
      deletedList.appendChild(div);
    });
  }

  async function deleteOrder(orderId) {
    const order = historyOrders.find(o => o.id === orderId);
    if (!order) return;
    if (!confirm("Xo√° ƒë∆°n n√†y? ƒê∆°n s·∫Ω chuy·ªÉn sang L·ªãch s·ª≠ xo√° v√† tr·ª´ doanh thu.")) return;

    // Ghi l·∫°i v√†o deleted_orders
    const payload = {
      order_id: order.id,
      items: order.items,
      total: order.total,
      cash_given: order.cash_given,
      change: order.change
    };
    const { error: e1 } = await supa.from("deleted_orders").insert([payload]);
    if (e1) {
      console.error(e1);
      alert("Kh√¥ng th·ªÉ ghi v√†o l·ªãch s·ª≠ xo√°.");
      return;
    }

    // Xo√° kh·ªèi orders
    const { error: e2 } = await supa.from("orders").delete().eq("id", order.id);
    if (e2) {
      console.error(e2);
      alert("Kh√¥ng th·ªÉ xo√° kh·ªèi b·∫£ng orders.");
      return;
    }

    await loadHistory();
  }

  async function restoreOrder(deletedId) {
    const rec = deletedOrders.find(d => d.id === deletedId);
    if (!rec) return;
    if (!confirm("Kh√¥i ph·ª•c ƒë∆°n n√†y v·ªÅ l·∫°i l·ªãch s·ª≠ ƒë∆°n?")) return;

    // Kh√¥i ph·ª•c v√†o orders
    const payload = {
      items: rec.items,
      total: rec.total,
      cash_given: rec.cash_given,
      change: rec.change
    };
    const { data, error: e1 } = await supa
      .from("orders")
      .insert([payload])
      .select()
      .single();
    if (e1) {
      console.error(e1);
      alert("Kh√¥ng th·ªÉ kh√¥i ph·ª•c v√†o orders.");
      return;
    }

    // Kh√¥ng xo√° b·∫£n ghi trong deleted_orders ƒë·ªÉ gi·ªØ log
    await loadHistory();
  }

  // ==========================
  // SAVE + PRINT
  // ==========================
  async function saveOrder(printAfter) {
    if (!currentOrder.length) {
      alert("ƒê∆°n hi·ªán t·∫°i ƒëang tr·ªëng.");
      return;
    }
    const total = currentOrder.reduce((s, l) => s + l.lineTotal, 0);
    const cashThousand = parseInt(cashInput.value || "0", 10);
    const cash = cashThousand * 1000;
    const change = cash > 0 ? cash - total : null;

    const payload = {
      items: currentOrder,
      total,
      cash_given: cash || null,
      change
    };

    const { data, error } = await supa
      .from("orders")
      .insert([payload])
      .select()
      .single();

    if (error) {
      console.error(error);
      alert("L∆∞u ƒë∆°n l√™n Supabase th·∫•t b·∫°i.");
      return;
    }

    if (printAfter) {
      printBill(data);
    }

    clearCurrentOrder();
    await loadHistory();
  }

  function printBill(order) {
    const now = order.created_at ? new Date(order.created_at) : new Date();
    const timeStr = now.toLocaleString("vi-VN");

    let rows = "";
    (order.items || []).forEach(it => {
      rows += `
        <tr>
          <td>${it.name || ""}</td>
          <td style="text-align:center;">${it.size || ""}</td>
          <td style="text-align:center;">${it.qty || 1}</td>
          <td style="text-align:right;">${formatVND(it.lineTotal || 0)}</td>
        </tr>
      `;
    });

    const cashStr = order.cash_given ? formatVND(order.cash_given) : "0 VND";
    const changeStr =
      order.change != null ? formatVND(order.change) : "0 VND";

    const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ho√° ƒë∆°n Tea Neko</title>
<style>
  body { font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif; margin:0; padding:8px; }
  .bill { width:320px; font-size:12px; }
  h2 { text-align:center; margin:4px 0 2px; font-size:16px; }
  .shop-info { text-align:right; font-size:10px; margin-bottom:6px; }
  table { width:100%; border-collapse:collapse; font-size:11px; }
  th,td { padding:2px 0; }
  th { border-bottom:1px solid #000; }
  .total-row td { border-top:1px dashed #000; padding-top:4px; }
</style>
</head>
<body>
<div class="bill">
  <h2>Tea Neko</h2>
  <div class="shop-info">
    ƒê/c: Hai B√† Tr∆∞ng, Ch∆∞ S√™, Gia Lai<br>
    SƒêT: 0123456789
  </div>
  <div style="font-size:11px;margin-bottom:4px;">
    Th·ªùi gian: ${timeStr}<br>
  </div>
  <table>
    <thead>
      <tr>
        <th>M√≥n</th>
        <th style="text-align:center;">Size</th>
        <th style="text-align:center;">SL</th>
        <th style="text-align:right;">Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody>
      ${rows}
    </tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="3"><strong>T·ªïng:</strong></td>
        <td style="text-align:right;"><strong>${formatVND(order.total || 0)}</strong></td>
      </tr>
      <tr>
        <td colspan="3">Kh√°ch ƒë∆∞a:</td>
        <td style="text-align:right;">${cashStr}</td>
      </tr>
      <tr>
        <td colspan="3">Ti·ªÅn tr·∫£ l·∫°i kh√°ch:</td>
        <td style="text-align:right;">${changeStr}</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center;margin-top:6px;font-size:11px;">
    C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko üíú
  </div>
</div>
</body>
</html>`;

    const win = window.open("", "_blank", "width=400,height=600");
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  }

  async function printBillFromHistory(orderId) {
    const order = historyOrders.find(o => o.id === orderId);
    if (!order) return;
    printBill(order);
  }

  // ==========================
  // REVENUE
  // ==========================
  async function loadRevenue() {
    // T√≠nh doanh thu = sum(orders) - sum(deleted_orders theo order_id)
    const orders = historyOrders;
    const deleted = deletedOrders;

    // map deleted_total theo order_id
    const deletedMap = {};
    deleted.forEach(d => {
      const id = d.order_id;
      if (!id) return;
      if (!deletedMap[id]) deletedMap[id] = 0;
      deletedMap[id] += d.total || 0;
    });

    const now = new Date();
    const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const startOfWeek = new Date(startOfToday);
    startOfWeek.setDate(startOfWeek.getDate() - 6); // 7 ng√†y g·∫ßn nh·∫•t
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

    let revToday = 0;
    let revWeek = 0;
    let revMonth = 0;
    let revAll = 0;

    orders.forEach(o => {
      const id = o.id;
      const createdAt = o.created_at ? new Date(o.created_at) : null;
      const total = (o.total || 0) - (deletedMap[id] || 0);

      if (total <= 0) return;

      revAll += total;

      if (createdAt) {
        if (createdAt >= startOfToday) revToday += total;
        if (createdAt >= startOfWeek) revWeek += total;
        if (createdAt >= startOfMonth) revMonth += total;
      }
    });

    revTodayEl.textContent = formatVND(revToday);
    revWeekEl.textContent = formatVND(revWeek);
    revMonthEl.textContent = formatVND(revMonth);
    revAllEl.textContent = formatVND(revAll);
  }

  // ==========================
  // WEB ORDERS (QR)
  // ==========================
  async function loadWebOrders() {
    webOrdersList.innerHTML =
      `<div style="color:#9ca3af;">ƒêang t·∫£i ƒë∆°n t·ª´ web...</div>`;

    const { data, error } = await supa
      .from("web_orders")
      .select("*")
      .eq("status", "pending")
      .order("created_at", { ascending: false })
      .limit(50);

    if (error) {
      console.error(error);
      webOrdersList.innerHTML =
        `<div style="color:#fecaca;">L·ªói t·∫£i ƒë∆°n QR.</div>`;
      return;
    }
    const list = data || [];
    if (!list.length) {
      webOrdersList.innerHTML =
        `<div style="color:#9ca3af;">Ch∆∞a c√≥ ƒë∆°n n√†o t·ª´ QR.</div>`;
      return;
    }

    let html = "";
    list.forEach(order => {
      const timeStr = order.created_at
        ? new Date(order.created_at).toLocaleString("vi-VN")
        : "";
      const tableNo = order.table_no || "N/A";

      const itemsText = (order.items || [])
        .map(it => `${it.qty || 1}x ${it.name || ""}`)
        .join(", ");

      const note = order.note
        ? `<div style="margin-top:2px; font-size:11px; color:#e5e7eb;">Ghi ch√∫: ${order.note}</div>`
        : "";

      html += `
        <div style="
          border-radius:8px;
          border:1px solid #374151;
          padding:6px 8px;
          margin-bottom:6px;
          background:#020617;
          color:#e5e7eb;
        ">
          <div style="font-size:11px; color:#facc15; margin-bottom:3px;">
            [WEB] B√†n ${tableNo} ¬∑ ${timeStr}
          </div>
          <div style="font-size:12px;">
            ${itemsText || "(Kh√¥ng c√≥ m√≥n)"}
          </div>
          ${note}
          <div style="display:flex; gap:6px; margin-top:6px;">
            <button onclick='acceptWebOrder("${order.id}")'
                    style="flex:1; padding:4px 6px; border:none; border-radius:999px;
                           background:#22c55e; color:#022c22; font-size:11px; cursor:pointer;">
              ‚úÖ Nh·∫≠n v√†o POS
            </button>
            <button onclick='cancelWebOrder("${order.id}")'
                    style="flex:1; padding:4px 6px; border:none; border-radius:999px;
                           background:#ef4444; color:#fee2e2; font-size:11px; cursor:pointer;">
              ‚úñ H·ªßy ƒë∆°n
            </button>
          </div>
        </div>
      `;
    });

    webOrdersList.innerHTML = html;
  }

  async function acceptWebOrder(id) {
    const { data, error } = await supa
      .from("web_orders")
      .select("*")
      .eq("id", id)
      .single();
    if (error || !data) {
      console.error(error);
      alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c chi ti·∫øt ƒë∆°n web.");
      return;
    }
    const items = data.items || [];
    if (!items.length) {
      alert("ƒê∆°n web n√†y kh√¥ng c√≥ m√≥n.");
      return;
    }

    // ƒê·ªï v√†o currentOrder POS
    currentOrder = items.map(it => {
      const qty = it.qty || 1;
      const price = it.price || 0;
      return {
        name: it.name || "M√≥n",
        size: "M",
        qty,
        unitPrice: price,
        lineTotal: price * qty
      };
    });
    clickStack = []; // reset stack
    renderCurrentOrder();

    // ƒê√°nh d·∫•u accepted
    await supa
      .from("web_orders")
      .update({
        status: "accepted",
        accepted_at: new Date().toISOString()
      })
      .eq("id", id);

    await loadWebOrders();

    // chuy·ªÉn sang tab POS cho d·ªÖ thao t√°c
    setTab("page-pos");
  }

  async function cancelWebOrder(id) {
    if (!confirm("H·ªßy ƒë∆°n n√†y c·ªßa kh√°ch?")) return;
    const { error } = await supa
      .from("web_orders")
      .update({
        status: "canceled",
        canceled_at: new Date().toISOString()
      })
      .eq("id", id);
    if (error) {
      console.error(error);
      alert("Kh√¥ng th·ªÉ h·ªßy ƒë∆°n.");
      return;
    }
    await loadWebOrders();
  }

  function initWebOrdersRealtime() {
    supa
      .channel("web-orders-realtime")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "web_orders" },
        payload => {
          const newOrder = payload.new;
          if (newOrder.status === "pending") {
            loadWebOrders();
          }
        }
      )
      .subscribe();
  }

  // ==========================
  // STOCK (LOCAL)
  // ==========================
  const STOCK_KEY = "tea_neko_stock";

  function loadStock() {
    let data;
    try {
      data = JSON.parse(localStorage.getItem(STOCK_KEY) || "[]");
    } catch {
      data = [];
    }
    renderStock(data);
  }

  function saveStock(data) {
    localStorage.setItem(STOCK_KEY, JSON.stringify(data));
    renderStock(data);
  }

  function renderStock(data) {
    stockList.innerHTML = "";
    if (!data.length) {
      stockList.innerHTML =
        `<div style="color:#9ca3af;">Ch∆∞a c√≥ nguy√™n li·ªáu n√†o.</div>`;
      return;
    }
    data.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "stock-item";
      div.innerHTML = `
        <div>
          <div style="font-size:12px;">${item.name}</div>
          <div style="font-size:11px; color:#9ca3af;">SL: ${item.qty}</div>
        </div>
        <button style="font-size:11px; border:none; border-radius:999px;
                       padding:4px 8px; cursor:pointer;
                       background:#0ea5e9; color:#e0f2fe;"
                onclick="editStock(${idx})">
          S·ª≠a
        </button>
      `;
      stockList.appendChild(div);
    });
  }

  function getStockData() {
    try {
      return JSON.parse(localStorage.getItem(STOCK_KEY) || "[]");
    } catch {
      return [];
    }
  }

  function addStockItem() {
    const name = stockNameInput.value.trim();
    const qty = parseInt(stockQtyInput.value || "0", 10);
    if (!name) {
      alert("Nh·∫≠p t√™n nguy√™n li·ªáu.");
      return;
    }
    const data = getStockData();
    data.push({ name, qty: isNaN(qty) ? 0 : qty });
    stockNameInput.value = "";
    stockQtyInput.value = "";
    saveStock(data);
  }

  function editStock(idx) {
    const data = getStockData();
    const item = data[idx];
    if (!item) return;
    const newQty = prompt(
      `S·ª≠a s·ªë l∆∞·ª£ng cho "${item.name}"`,
      String(item.qty)
    );
    if (newQty === null) return;
    const q = parseInt(newQty, 10);
    if (isNaN(q)) {
      alert("Gi√° tr·ªã kh√¥ng h·ª£p l·ªá.");
      return;
    }
    item.qty = q;
    saveStock(data);
  }

  window.editStock = editStock;

  // ==========================
  // EVENT BINDINGS
  // ==========================
  sizeMBtn.addEventListener("click", () => {
    currentSize = "M";
    sizeMBtn.classList.add("active");
    sizeLBtn.classList.remove("active");
  });
  sizeLBtn.addEventListener("click", () => {
    currentSize = "L";
    sizeLBtn.classList.add("active");
    sizeMBtn.classList.remove("active");
  });
  cashInput.addEventListener("input", renderCurrentOrder);
  btnUndo.addEventListener("click", undoLastClick);
  btnClear.addEventListener("click", () => {
    if (!currentOrder.length) return;
    if (!confirm("Xo√° to√†n b·ªô m√≥n trong ƒë∆°n hi·ªán t·∫°i?")) return;
    clearCurrentOrder();
  });
  btnSave.addEventListener("click", () => saveOrder(false));
  btnPrint.addEventListener("click", () => saveOrder(true));
  btnReloadWebOrders.addEventListener("click", loadWebOrders);
  btnAddStock.addEventListener("click", addStockItem);

  // expose functions for inline onclick
  window.printBillFromHistory = printBillFromHistory;
  window.deleteOrder = deleteOrder;
  window.restoreOrder = restoreOrder;
  window.acceptWebOrder = acceptWebOrder;
  window.cancelWebOrder = cancelWebOrder;

  // ==========================
  // INIT
  // ==========================
  (async function init() {
    renderMenu();
    renderCurrentOrder();
    loadStock();
    await loadHistory();
    await loadWebOrders();
    initWebOrdersRealtime();
  })();
</script>
</body>
</html>
