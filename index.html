<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Mini POS ‚Äì Tea Neko (Multi-Page)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ===== CSS ===== -->
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: #101018;
      color: #f5f5f5;
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding-bottom: 40px;
    }

    /* ===== TAB BAR ===== */
    .tab-bar {
      display: flex;
      background: #181825;
      padding: 8px 10px 0;
      position: sticky;
      top: 0;
      z-index: 20;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 10px 0 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #a0a0b5;
      position: relative;
      transition: transform .06s ease, background .12s ease, color .12s ease;
      border-radius: 10px 10px 0 0;
    }

    .tab-btn.active {
      color: #ffffff;
      background: #242436;
      transform: translateY(1px);
    }

    .tab-btn:active {
      transform: translateY(2px) scale(0.98);
    }

    .tab-underline {
      height: 3px;
      background: #0a84ff;
      width: 25%; /* 4 tab = 25% */
      transform: translateX(0%);
      transition: transform .18s ease;
    }

    /* ===== PAGE WRAPPER ===== */
    .page {
      display: none;
      padding: 12px;
    }
    .page.active { display: block; }

    .box {
      background: #181825;
      border-radius: 16px;
      border: 1px solid #403b3b;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    h2, h3 {
      margin: 0 0 8px;
      text-align: center;
    }
    h2 { font-size: 18px; }
    h3 { font-size: 15px; }

    .section-title {
      margin-top: 10px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #a0a0c5;
      border-left: 3px solid #0a84ff;
      padding-left: 6px;
    }

    /* ===== MENU ===== */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .menu-item {
      border-radius: 12px;
      padding: 8px;
      background: #222233;
      border: 1px solid #3a3a4a;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.1s ease, background 0.1s ease;
      font-size: 13px;
    }

    .menu-item:hover {
      background: #25253a;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .menu-item:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 1px 3px rgba(0,0,0,0.4) inset;
      background: #313153;
    }

    .menu-item-name {
      font-weight: 600;
    }
    .menu-item-price {
      font-size: 12px;
      color: #b0b0c8;
      margin-top: 2px;
    }

    /* ===== SIZE & CASH ===== */
    .size-row,
    .cash-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
      font-size: 14px;
    }

    .size-row button {
      flex: 1;
      padding: 8px 0;
      border-radius: 999px;
      border: 1px solid #3a3a4a;
      background: #222233;
      color: #f5f5f5;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.06s ease;
    }

    .size-row button.active {
      background: #0a84ff;
      border-color: #0a84ff;
      box-shadow: 0 0 0 1px rgba(10,132,255,0.5);
    }

    .size-row button:active {
      transform: translateY(1px);
    }

    .cash-row span {
      white-space: nowrap;
      font-size: 13px;
    }

    .cash-row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #3a3a4a;
      background: #101018;
      color: #f5f5f5;
      font-size: 14px;
    }

    /* ===== BUTTONS ===== */
    .btn-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      transition: opacity 0.08s ease, transform 0.06s ease, box-shadow 0.12s ease;
    }
    .btn:active {
      opacity: 0.9;
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0,0,0,0.5) inset;
    }
    .btn-undo { background: #7a7a85; }
    .btn-clear { background: #ff3b30; }
    .btn-save { background: #1c60ff; }
    .btn-print { background: #30c759; }

    .list-box {
      margin-top: 12px;
      padding: 10px;
      border-radius: 14px;
      background: #141420;
      border: 1px solid #3a3a4a;
      font-size: 13px;
    }

    ul {
      margin: 6px 0 0;
      padding-left: 18px;
      max-height: 220px;
      overflow-y: auto;
    }

    .summary {
      margin-top: 6px;
      font-size: 13px;
    }
    .summary strong { font-size: 14px; }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .chip-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #3a3a4a;
      background: #242438;
      color: #f5f5f5;
      font-size: 11px;
      cursor: pointer;
    }

    .chip-btn:active {
      transform: translateY(1px);
      background: #333355;
    }

    .history-list {
      max-height: 220px;
      overflow-y: auto;
      margin-top: 4px;
      font-size: 12px;
    }

    .history-item {
      border-bottom: 1px dashed #3a3a4a;
      padding: 4px 0;
      display: flex;
      gap: 6px;
      align-items: flex-start;
      justify-content: space-between;
    }

    .history-main {
      flex: 1;
    }
    .history-code {
      color: #ffd85d;
      font-weight: 600;
    }
    .history-meta {
      color: #c0c0d0;
    }

    .btn-small-red {
      padding: 2px 8px;
      border-radius: 999px;
      border: none;
      background: #ff3b30;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      margin-left: 4px;
    }

    .btn-small-green {
      padding: 2px 8px;
      border-radius: 999px;
      border: none;
      background: #30c759;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      margin-left: 4px;
    }

    .btn-small-blue {
      padding: 2px 8px;
      border-radius: 999px;
      border: none;
      background: #1c60ff;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      margin-left: 4px;
    }

    .footer {
      margin-top: 10px;
      text-align: center;
      font-size: 12px;
      color: #b0b0c8;
    }

    /* ===== REVENUE PAGE ===== */
    .card-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .rev-card {
      background: #1c1c2a;
      border-radius: 12px;
      padding: 8px;
      border: 1px solid #34344a;
      font-size: 11px;
    }

    .rev-label {
      color: #b0b0d0;
      margin-bottom: 4px;
    }

    .rev-value {
      font-weight: 700;
      font-size: 12px;
    }

    .rev-list {
      margin-top: 10px;
      font-size: 12px;
      max-height: 260px;
      overflow-y: auto;
    }

    /* ===== HISTORY PAGE ===== */
    .search-row {
      margin-top: 6px;
    }
    .search-row input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #3a3a4a;
      background: #101018;
      color: #f5f5f5;
      font-size: 13px;
    }

    .history-section-title {
      margin-top: 10px;
      font-size: 13px;
      color: #e5e5ff;
      font-weight: 600;
    }

    .history-note {
      font-size: 11px;
      color: #c0c0d0;
      margin-top: 4px;
    }

    /* ===== STOCK PAGE ===== */
    .stock-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0 8px;
      font-size: 13px;
    }

    .stock-list {
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 12px;
    }

    .stock-item {
      border-bottom: 1px dashed #3a3a4a;
      padding: 5px 0;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
    }

    .stock-main {
      flex: 1;
    }

    .stock-name {
      font-weight: 600;
    }

    .stock-meta {
      color: #c0c0d0;
    }

    .stock-form {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      background: #141420;
      border: 1px dashed #3a3a4a;
      font-size: 12px;
    }

    .stock-form-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .stock-form-row input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #3a3a4a;
      background: #101018;
      color: #f5f5f5;
      font-size: 12px;
    }

    .btn-small {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-small-gray {
      background: #7a7a85;
      color: #fff;
    }

    .btn-small-save {
      background: #30c759;
      color: #fff;
    }

    @media (max-width: 480px) {
      .app { padding-bottom: 24px; }
      .box { border-radius: 12px; }
    }
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
<div class="app">

  <!-- ===== TAB MENU ===== -->
  <div class="tab-bar">
    <div class="tab-btn active" data-page="page-pos">POS</div>
    <div class="tab-btn" data-page="page-revenue">Doanh thu</div>
    <div class="tab-btn" data-page="page-history">L·ªãch s·ª≠</div>
    <div class="tab-btn" data-page="page-stock">T·ªìn kho</div>
  </div>
  <div class="tab-underline" id="tabUnderline"></div>

  <!-- ===== PAGE 1 ‚Äì POS ===== -->
  <div id="page-pos" class="page active">
    <div class="box">

      <h2>Mini POS ‚Äì Tea Neko</h2>

      <div class="section-title">Latte / Coffee / Tr√† s·ªØa</div>
      <div id="menuMain" class="menu-grid"></div>

      <div class="section-title">T√πy ch·ªçn size</div>
      <div class="size-row">
        <button id="sizeM" class="active">Size M</button>
        <button id="sizeL">Size L (+5.000)</button>
      </div>

      <div class="cash-row">
        <span>Kh√°ch ƒë∆∞a (ngh√¨n):</span>
        <input id="cashInput" type="number" min="0" placeholder="VD: 50">
      </div>

      <div class="btn-row">
        <button class="btn btn-undo" id="btnUndo">‚Ü© Ho√†n t√°c</button>
        <button class="btn btn-clear" id="btnClear">X√≥a t·∫•t c·∫£</button>
      </div>
      <div class="btn-row" style="margin-top:6px;">
        <button class="btn btn-save" id="btnSave">üíæ L∆∞u ƒë∆°n</button>
        <button class="btn btn-print" id="btnPrint">üßæ L∆∞u + In bill</button>
      </div>

      <div class="list-box" id="currentBox">
        <div><strong>ƒê∆°n hi·ªán t·∫°i:</strong></div>
        <ul id="currentList"></ul>
        <div class="summary" id="currentSummary">T·ªïng: 0 VND</div>
        <div class="summary" id="cashSummary"></div>
      </div>

      <div class="list-box">
        <div class="history-header">
          <span><strong>L·ªãch s·ª≠ ƒë∆°n (Realtime)</strong></span>
          <button class="chip-btn" id="btnRefreshPosHistory">‚Üª T·∫£i l·∫°i</button>
        </div>
        <div class="history-list" id="posHistoryList"></div>
        <div class="summary" id="posHistoryTotal">T·ªïng doanh thu: 0 VND</div>
      </div>

      <div class="footer">C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko üíú</div>
    </div>
  </div>

  <!-- ===== PAGE 2 ‚Äì REVENUE ===== -->
  <div id="page-revenue" class="page">
    <div class="box">
      <h2>Doanh thu</h2>
      <div class="history-header" style="margin-bottom:6px;">
        <span style="font-size:13px;">T·ªïng thu nh·∫≠p (t·ª´ c√°c ƒë∆°n ch∆∞a xo√°)</span>
        <button class="chip-btn" id="btnRefreshRevenue">‚Üª T·∫£i l·∫°i</button>
      </div>

      <div class="card-row">
        <div class="rev-card">
          <div class="rev-label">H√¥m nay</div>
          <div class="rev-value" id="revToday">0 VND</div>
        </div>
        <div class="rev-card">
          <div class="rev-label">7 ng√†y g·∫ßn nh·∫•t</div>
          <div class="rev-value" id="revWeek">0 VND</div>
        </div>
        <div class="rev-card">
          <div class="rev-label">Th√°ng n√†y</div>
          <div class="rev-value" id="revMonth">0 VND</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:14px;">Chi ti·∫øt theo ng√†y</div>
      <div class="rev-list" id="revByDayList"></div>
    </div>
  </div>

  <!-- ===== PAGE 3 ‚Äì HISTORY ===== -->
  <div id="page-history" class="page">
    <div class="box">
      <h2>L·ªãch s·ª≠ ƒë∆°n</h2>

      <div class="history-header">
        <span style="font-size:13px;">Xem / xo√° / kh√¥i ph·ª•c / in ho√° ƒë∆°n</span>
        <button class="chip-btn" id="btnRefreshHistoryPage">‚Üª T·∫£i l·∫°i</button>
      </div>

      <div class="search-row">
        <input id="searchOrder" placeholder="T√¨m theo m√£ ƒë∆°n (#0001), m√≥n, ...">
      </div>

      <div class="history-section-title">ƒê∆°n ƒëang ho·∫°t ƒë·ªông</div>
      <div class="history-list" id="historyActiveList"></div>

      <div class="history-section-title" style="margin-top:10px;">ƒê∆°n ƒë√£ xo√° (kh√¥ng xo√° ti·∫øp)</div>
      <div class="history-note">B·∫°n ch·ªâ c√≥ th·ªÉ kh√¥i ph·ª•c ƒë∆°n ƒë√£ xo√° sang b·∫£ng ƒë∆°n ƒëang ho·∫°t ƒë·ªông.</div>
      <div class="history-list" id="historyDeletedList"></div>
    </div>
  </div>

  <!-- ===== PAGE 4 ‚Äì STOCK / T·ªíN KHO ===== -->
  <div id="page-stock" class="page">
    <div class="box">
      <h2>T·ªìn kho nguy√™n li·ªáu</h2>

      <div class="stock-actions">
        <span>Cu·ªëi bu·ªïi ki·ªÉm h√†ng r·ªìi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng.</span>
        <button class="chip-btn" id="btnRefreshStock">‚Üª T·∫£i l·∫°i</button>
      </div>

      <button class="btn-small btn-small-gray" id="btnToggleStockForm">‚ûï Th√™m nguy√™n li·ªáu</button>

      <div class="stock-form" id="stockForm" style="display:none;">
        <div class="stock-form-row">
          <input id="stockName" placeholder="T√™n nguy√™n li·ªáu (VD: B·ªôt matcha)">
        </div>
        <div class="stock-form-row">
          <input id="stockQuantity" type="number" step="0.01" placeholder="S·ªë l∆∞·ª£ng hi·ªán c√≥">
          <input id="stockUnit" placeholder="ƒê∆°n v·ªã (VD: kg, g, ml)">
        </div>
        <div style="text-align:right;">
          <button class="btn-small btn-small-gray" id="btnCancelStockAdd">H·ªßy</button>
          <button class="btn-small btn-small-save" id="btnSaveStock">L∆∞u</button>
        </div>
      </div>

      <div class="section-title" style="margin-top:10px;">Danh s√°ch hi·ªán t·∫°i</div>
      <div class="stock-list" id="stockList"></div>
    </div>
  </div>

</div>

<!-- ===== JS ===== -->
<script>
  // ===== SUPABASE CONFIG =====
  const SUPABASE_URL = "https://kcrchwedlrettpkucoct.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw";
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ===== MENU DATA =====
  const MENU = [
    { name: "Matcha Latte",      price: 25000 },
    { name: "Coffee",            price: 25000 },
    { name: "Tr√† s·ªØa tr√¢n ch√¢u", price: 30000 },
    { name: "H·ªìng tr√† s·ªØa",      price: 28000 },
    { name: "Cacao ƒë√°",          price: 22000 },
    { name: "B·∫°c x·ªâu",           price: 20000 }
  ];

  // ===== STATE =====
  let currentSize = "M";
  let currentOrder = [];              // {name,size,qty,unitPrice,lineTotal}
  let activeOrders = [];              // from public.orders
  let deletedOrders = [];             // from public.deleted_orders
  let inventoryItems = [];            // from public.inventory
  let revenueStats = { today:0, week:0, month:0, byDay:[] };

  // ===== DOM SHORTCUTS =====
  const tabBtns = document.querySelectorAll(".tab-btn");
  const pages = document.querySelectorAll(".page");
  const tabUnderline = document.getElementById("tabUnderline");

  const menuMain = document.getElementById("menuMain");
  const sizeMBtn = document.getElementById("sizeM");
  const sizeLBtn = document.getElementById("sizeL");
  const cashInput = document.getElementById("cashInput");
  const btnUndo = document.getElementById("btnUndo");
  const btnClear = document.getElementById("btnClear");
  const btnSave = document.getElementById("btnSave");
  const btnPrint = document.getElementById("btnPrint");
  const currentList = document.getElementById("currentList");
  const currentSummary = document.getElementById("currentSummary");
  const cashSummary = document.getElementById("cashSummary");

  const posHistoryList = document.getElementById("posHistoryList");
  const posHistoryTotal = document.getElementById("posHistoryTotal");
  const btnRefreshPosHistory = document.getElementById("btnRefreshPosHistory");

  const revToday = document.getElementById("revToday");
  const revWeek = document.getElementById("revWeek");
  const revMonth = document.getElementById("revMonth");
  const revByDayList = document.getElementById("revByDayList");
  const btnRefreshRevenue = document.getElementById("btnRefreshRevenue");

  const historyActiveList = document.getElementById("historyActiveList");
  const historyDeletedList = document.getElementById("historyDeletedList");
  const btnRefreshHistoryPage = document.getElementById("btnRefreshHistoryPage");
  const searchOrderInput = document.getElementById("searchOrder");

  const btnRefreshStock = document.getElementById("btnRefreshStock");
  const btnToggleStockForm = document.getElementById("btnToggleStockForm");
  const stockForm = document.getElementById("stockForm");
  const stockNameInput = document.getElementById("stockName");
  const stockQuantityInput = document.getElementById("stockQuantity");
  const stockUnitInput = document.getElementById("stockUnit");
  const btnCancelStockAdd = document.getElementById("btnCancelStockAdd");
  const btnSaveStock = document.getElementById("btnSaveStock");
  const stockList = document.getElementById("stockList");

  // ===== UTILS =====
  function formatVND(x) {
    return (x || 0).toLocaleString("vi-VN") + " VND";
  }

  function formatDateTime(str) {
    if (!str) return "";
    const d = new Date(str);
    return d.toLocaleString("vi-VN");
  }

  function formatDate(str) {
    if (!str) return "";
    const d = new Date(str);
    return d.toLocaleDateString("vi-VN");
  }

  // L·∫•y m√£ ƒë∆°n m·ªõi: #0001, #0002, ... d·ª±a tr√™n max c·ªßa orders + deleted_orders
  async function getNextOrderCode() {
    let maxNum = 0;

    const { data: dataA } = await supa.from("orders").select("order_code");
    const { data: dataB } = await supa.from("deleted_orders").select("order_code");

    [...(dataA || []), ...(dataB || [])].forEach(row => {
      if (!row.order_code) return;
      const m = /#(\d+)/.exec(row.order_code);
      if (!m) return;
      const num = parseInt(m[1], 10);
      if (!isNaN(num) && num > maxNum) maxNum = num;
    });

    const next = maxNum + 1;
    return "#" + String(next).padStart(4, "0");
  }

  // ===== RENDER MENU & ORDER =====
  function renderMenu() {
    MENU.forEach(item => {
      const div = document.createElement("div");
      div.className = "menu-item";
      div.innerHTML = `
        <div class="menu-item-name">${item.name}</div>
        <div class="menu-item-price">${item.price.toLocaleString("vi-VN")} VND (Size M)</div>
      `;
      div.addEventListener("click", () => addItem(item));
      menuMain.appendChild(div);
    });
  }

  function addItem(item) {
    const isL = currentSize === "L";
    const unitPrice = item.price + (isL ? 5000 : 0);

    const existing = currentOrder.find(
      line => line.name === item.name && line.size === currentSize
    );

    if (existing) {
      existing.qty += 1;
      existing.lineTotal = existing.qty * existing.unitPrice;
    } else {
      currentOrder.push({
        name: item.name,
        size: currentSize,
        qty: 1,
        unitPrice,
        lineTotal: unitPrice
      });
    }

    renderCurrentOrder();
  }

  function renderCurrentOrder() {
    currentList.innerHTML = "";
    let total = 0;

    currentOrder.forEach(line => {
      total += line.lineTotal;
      const li = document.createElement("li");
      li.textContent = `${line.qty} x ${line.name} (Size ${line.size}) ‚Äì ${formatVND(line.lineTotal)}`;
      currentList.appendChild(li);
    });

    currentSummary.innerHTML = `<strong>T·ªïng:</strong> ${formatVND(total)}`;

    const cashThousand = parseInt(cashInput.value || "0", 10);
    const cash = cashThousand * 1000;
    if (cash > 0) {
      const diff = cash - total;
      cashSummary.textContent =
        `Kh√°ch ƒë∆∞a: ${formatVND(cash)} ‚Äì ` +
        `Ti·ªÅn tr·∫£ l·∫°i kh√°ch: ${formatVND(Math.max(diff, 0))}`;
    } else {
      cashSummary.textContent = "";
    }
  }

  function clearCurrentOrder() {
    currentOrder = [];
    cashInput.value = "";
    renderCurrentOrder();
  }

  // ===== LOAD DATA FROM SERVER =====
  async function loadAllData() {
    const [{ data: active, error: e1 }, { data: deleted, error: e2 }, { data: inv, error: e3 }] =
      await Promise.all([
        supa.from("orders").select("*").order("created_at", { ascending: false }),
        supa.from("deleted_orders").select("*").order("deleted_at", { ascending: false }),
        supa.from("inventory").select("*").order("updated_at", { ascending: false })
      ]);

    if (e1 || e2 || e3) {
      console.error(e1 || e2 || e3);
      alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Supabase.");
      return;
    }

    activeOrders = active || [];
    deletedOrders = deleted || [];
    inventoryItems = inv || [];

    renderPosHistory();
    recomputeRevenue();
    renderRevenuePage();
    renderHistoryPage();
    renderStock();
  }

  function renderPosHistory() {
    posHistoryList.innerHTML = "";
    let total = 0;

    activeOrders.forEach(order => {
      total += order.total || 0;
      const div = document.createElement("div");
      div.className = "history-item";
      const itemsText = (order.items || [])
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ");

      div.innerHTML = `
        <div class="history-main">
          <div>
            <span class="history-code">${order.order_code || ""}</span>
            <span class="history-meta">[${formatDateTime(order.created_at)}]</span>
          </div>
          <div>${itemsText}</div>
          <div><strong>${formatVND(order.total || 0)}</strong></div>
        </div>
        <div>
          <button class="btn-small-blue">In</button>
          <button class="btn-small-red">X√≥a</button>
        </div>
      `;
      const btnPrintMini = div.querySelector(".btn-small-blue");
      const btnDeleteMini = div.querySelector(".btn-small-red");
      btnPrintMini.addEventListener("click", () => printOrderFromActive(order.id));
      btnDeleteMini.addEventListener("click", () => onDeleteOrder(order.id));
      posHistoryList.appendChild(div);
    });

    posHistoryTotal.textContent = `T·ªïng doanh thu: ${formatVND(total)}`;
  }

  // ===== DOANH THU =====
  function recomputeRevenue() {
    const now = new Date();
    const todayStr = now.toISOString().slice(0,10);

    let today = 0, week = 0, month = 0;
    const byDayMap = new Map();

    activeOrders.forEach(order => {
      const t = order.created_at ? new Date(order.created_at) : now;
      const dateStr = t.toISOString().slice(0,10);
      const total = order.total || 0;

      if (dateStr === todayStr) today += total;

      const diffDays = (now - t) / (1000*60*60*24);
      if (diffDays <= 7) week += total;

      if (t.getFullYear() === now.getFullYear() &&
          t.getMonth() === now.getMonth()) {
        month += total;
      }

      byDayMap.set(dateStr, (byDayMap.get(dateStr) || 0) + total);
    });

    const byDay = Array.from(byDayMap.entries())
      .sort((a,b) => a[0] < b[0] ? 1 : -1)
      .map(([date,total]) => ({date,total}));

    revenueStats = { today, week, month, byDay };
  }

  function renderRevenuePage() {
    revToday.textContent = formatVND(revenueStats.today);
    revWeek.textContent = formatVND(revenueStats.week);
    revMonth.textContent = formatVND(revenueStats.month);

    revByDayList.innerHTML = "";
    if (!revenueStats.byDay.length) {
      revByDayList.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
      return;
    }

    revenueStats.byDay.forEach(row => {
      const div = document.createElement("div");
      div.style.marginBottom = "4px";
      div.textContent = `${formatDate(row.date)} ‚Äì ${formatVND(row.total)}`;
      revByDayList.appendChild(div);
    });
  }

  // ===== HISTORY PAGE RENDER =====
  function renderHistoryPage() {
    const keyword = (searchOrderInput.value || "").toLowerCase();

    function matchOrder(order) {
      if (!keyword) return true;
      const code = (order.order_code || "").toLowerCase();
      const itemsText = (order.items || [])
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ")
        .toLowerCase();
      return code.includes(keyword) || itemsText.includes(keyword);
    }

    // Active orders
    historyActiveList.innerHTML = "";
    activeOrders.filter(matchOrder).forEach(order => {
      const div = document.createElement("div");
      div.className = "history-item";

      const itemsText = (order.items || [])
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ");

      div.innerHTML = `
        <div class="history-main">
          <div>
            <span class="history-code">${order.order_code || ""}</span>
            <span class="history-meta">[${formatDateTime(order.created_at)}]</span>
          </div>
          <div>${itemsText}</div>
          <div><strong>${formatVND(order.total || 0)}</strong></div>
        </div>
        <div>
          <button class="btn-small-blue">In</button>
          <button class="btn-small-red">X√≥a ƒë∆°n</button>
        </div>
      `;
      const btnPrint = div.querySelector(".btn-small-blue");
      const btnDelete = div.querySelector(".btn-small-red");
      btnPrint.addEventListener("click", () => printOrderFromActive(order.id));
      btnDelete.addEventListener("click", () => onDeleteOrder(order.id));
      historyActiveList.appendChild(div);
    });

    // Deleted orders
    historyDeletedList.innerHTML = "";
    deletedOrders.filter(matchOrder).forEach(order => {
      const div = document.createElement("div");
      div.className = "history-item";
      const itemsText = (order.items || [])
        .map(it => `${it.qty}x ${it.name} (${it.size})`)
        .join(", ");

      div.innerHTML = `
        <div class="history-main">
          <div>
            <span class="history-code">${order.order_code || ""}</span>
            <span class="history-meta">ƒê√£ xo√° l√∫c ${formatDateTime(order.deleted_at)}</span>
          </div>
          <div>${itemsText}</div>
          <div><strong>${formatVND(order.total || 0)}</strong></div>
        </div>
        <button class="btn-small-green">Kh√¥i ph·ª•c</button>
      `;
      div.querySelector("button").addEventListener("click", () => onRestoreOrder(order.id));
      historyDeletedList.appendChild(div);
    });
  }

  // ===== STOCK / T·ªíN KHO =====
  function renderStock() {
    stockList.innerHTML = "";
    if (!inventoryItems.length) {
      stockList.textContent = "Ch∆∞a c√≥ nguy√™n li·ªáu n√†o. B·∫•m 'Th√™m nguy√™n li·ªáu' ƒë·ªÉ b·∫Øt ƒë·∫ßu.";
      return;
    }

    inventoryItems.forEach(item => {
      const div = document.createElement("div");
      div.className = "stock-item";

      const main = document.createElement("div");
      main.className = "stock-main";
      main.innerHTML = `
        <div class="stock-name">${item.name}</div>
        <div class="stock-meta">
          S·ªë l∆∞·ª£ng: <strong>${item.quantity}</strong> ${item.unit} 
          ‚Ä¢ C·∫≠p nh·∫≠t: ${formatDateTime(item.updated_at)}
        </div>
      `;

      const actions = document.createElement("div");
      const editBtn = document.createElement("button");
      editBtn.className = "btn-small btn-small-gray";
      editBtn.textContent = "S·ª≠a SL";
      editBtn.addEventListener("click", () => openEditStock(item));

      actions.appendChild(editBtn);

      div.appendChild(main);
      div.appendChild(actions);
      stockList.appendChild(div);
    });
  }

  function openEditStock(item) {
    const newQty = prompt(
      `Nh·∫≠p l·∫°i s·ªë l∆∞·ª£ng cho "${item.name}" (${item.unit})`,
      item.quantity
    );
    if (newQty === null) return;
    const val = parseFloat(newQty);
    if (isNaN(val)) {
      alert("Gi√° tr·ªã kh√¥ng h·ª£p l·ªá.");
      return;
    }
    updateStockQuantity(item.id, val);
  }

  async function updateStockQuantity(id, quantity) {
    const { data, error } = await supa
      .from("inventory")
      .update({ quantity, updated_at: new Date().toISOString() })
      .eq("id", id)
      .select()
      .single();

    if (error) {
      console.error(error);
      alert("C·∫≠p nh·∫≠t t·ªìn kho th·∫•t b·∫°i.");
      return;
    }

    const idx = inventoryItems.findIndex(i => i.id === id);
    if (idx >= 0) inventoryItems[idx] = data;
    renderStock();
  }

  async function addStockItem() {
    const name = stockNameInput.value.trim();
    const quantity = parseFloat(stockQuantityInput.value || "0");
    const unit = (stockUnitInput.value || "").trim() || "ƒë∆°n v·ªã";

    if (!name) {
      alert("Vui l√≤ng nh·∫≠p t√™n nguy√™n li·ªáu.");
      return;
    }

    const { data, error } = await supa
      .from("inventory")
      .insert([{ name, quantity: isNaN(quantity) ? 0 : quantity, unit }])
      .select()
      .single();

    if (error) {
      console.error(error);
      alert("Th√™m nguy√™n li·ªáu th·∫•t b·∫°i.");
      return;
    }

    inventoryItems.unshift(data);
    stockNameInput.value = "";
    stockQuantityInput.value = "";
    stockUnitInput.value = "";
    stockForm.style.display = "none";
    renderStock();
  }

  // ===== DELETE / RESTORE =====
  async function onDeleteOrder(orderId) {
    const order = activeOrders.find(o => o.id === orderId);
    if (!order) return;

    if (!confirm("Xo√° ƒë∆°n n√†y? ƒê∆°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang m·ª•c 'ƒê∆°n ƒë√£ xo√°' v√† tr·ª´ kh·ªèi doanh thu.")) return;

    const payload = {
      original_id: order.id,
      order_code: order.order_code,
      device: order.device,
      items: order.items,
      total: order.total,
      cash_given: order.cash_given,
      change: order.change
    };

    const { data: inserted, error: err1 } = await supa
      .from("deleted_orders")
      .insert([payload])
      .select()
      .single();

    if (err1) {
      console.error(err1);
      alert("Kh√¥ng th·ªÉ ch√©p sang b·∫£ng deleted_orders.");
      return;
    }

    const { error: err2 } = await supa
      .from("orders")
      .delete()
      .eq("id", order.id);

    if (err2) {
      console.error(err2);
      alert("Xo√° kh·ªèi b·∫£ng orders th·∫•t b·∫°i.");
      return;
    }

    activeOrders = activeOrders.filter(o => o.id !== order.id);
    deletedOrders.unshift(inserted);

    renderPosHistory();
    recomputeRevenue();
    renderRevenuePage();
    renderHistoryPage();
  }

  async function onRestoreOrder(deletedId) {
    const deleted = deletedOrders.find(o => o.id === deletedId);
    if (!deleted) return;

    if (!confirm("Kh√¥i ph·ª•c ƒë∆°n n√†y tr·ªü l·∫°i danh s√°ch ƒë∆°n ƒëang ho·∫°t ƒë·ªông?")) return;

    const payload = {
      order_code: deleted.order_code,
      device: deleted.device,
      items: deleted.items,
      total: deleted.total,
      cash_given: deleted.cash_given,
      change: deleted.change
    };

    const { data: inserted, error: err1 } = await supa
      .from("orders")
      .insert([payload])
      .select()
      .single();

    if (err1) {
      console.error(err1);
      alert("Kh√¥ng th·ªÉ kh√¥i ph·ª•c v·ªÅ b·∫£ng orders.");
      return;
    }

    const { error: err2 } = await supa
      .from("deleted_orders")
      .delete()
      .eq("id", deleted.id);

    if (err2) {
      console.error(err2);
      alert("Xo√° kh·ªèi b·∫£ng deleted_orders th·∫•t b·∫°i.");
      return;
    }

    activeOrders.unshift(inserted);
    deletedOrders = deletedOrders.filter(o => o.id !== deleted.id);

    renderPosHistory();
    recomputeRevenue();
    renderRevenuePage();
    renderHistoryPage();
  }

  // ===== SAVE ORDER =====
  async function saveOrder(printAfter) {
    if (!currentOrder.length) {
      alert("ƒê∆°n hi·ªán t·∫°i ƒëang tr·ªëng.");
      return;
    }

    const total = currentOrder.reduce((s, l) => s + l.lineTotal, 0);
    const cashThousand = parseInt(cashInput.value || "0", 10);
    const cash = cashThousand * 1000;
    const change = cash > 0 ? cash - total : null;

    const order_code = await getNextOrderCode();

    const payload = {
      order_code,
      device: "Kh√¥ng ƒë·∫∑t t√™n",
      items: currentOrder,
      total,
      cash_given: cash || null,
      change
    };

    const { data, error } = await supa
      .from("orders")
      .insert([payload])
      .select()
      .single();

    if (error) {
      console.error(error);
      alert("L∆∞u ƒë∆°n l√™n Supabase th·∫•t b·∫°i.");
      return;
    }

    activeOrders.unshift(data);
    renderPosHistory();
    recomputeRevenue();
    renderRevenuePage();
    renderHistoryPage();

    if (printAfter) {
      printBill(data);
    }

    clearCurrentOrder();
  }

  // ===== PRINT BILL =====
  function printBill(order) {
    const now = order.created_at ? new Date(order.created_at) : new Date();
    const timeStr = now.toLocaleString("vi-VN");

    let rows = "";
    (order.items || []).forEach(it => {
      rows += `
        <tr>
          <td>${it.name}</td>
          <td style="text-align:center;">${it.size}</td>
          <td style="text-align:center;">${it.qty}</td>
          <td style="text-align:right;">${formatVND(it.lineTotal)}</td>
        </tr>`;
    });

    const cashStr = order.cash_given ? formatVND(order.cash_given) : "0 VND";
    const changeStr = order.change != null ? formatVND(order.change) : "0 VND";

    const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ho√° ƒë∆°n Tea Neko</title>
<style>
  body { font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif; margin:0; padding:8px; }
  .bill { width:320px; font-size:12px; }
  h2 { text-align:center; margin:4px 0 2px; font-size:16px; }
  .shop-info { text-align:right; font-size:10px; margin-bottom:6px; }
  table { width:100%; border-collapse:collapse; font-size:11px; }
  th,td { padding:2px 0; }
  th { border-bottom:1px solid #000; }
  .total-row td { border-top:1px dashed #000; padding-top:4px; }
</style>
</head>
<body>
<div class="bill">
  <h2>Tea Neko</h2>
  <div class="shop-info">
    ƒê/c: Hai B√† Tr∆∞ng, Ch∆∞ S√™, Gia Lai<br>
    SƒêT: 0123456789
  </div>
  <div style="font-size:11px;margin-bottom:4px;">
    M√£ ƒë∆°n: ${order.order_code || ""}<br>
    Th·ªùi gian: ${timeStr}
  </div>
  <table>
    <thead>
      <tr>
        <th>M√≥n</th>
        <th style="text-align:center;">Size</th>
        <th style="text-align:center;">SL</th>
        <th style="text-align:right;">Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody>
      ${rows}
    </tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="3"><strong>T·ªïng:</strong></td>
        <td style="text-align:right;"><strong>${formatVND(order.total || 0)}</strong></td>
      </tr>
      <tr>
        <td colspan="3">Kh√°ch ƒë∆∞a:</td>
        <td style="text-align:right;">${cashStr}</td>
      </tr>
      <tr>
        <td colspan="3">Ti·ªÅn tr·∫£ l·∫°i kh√°ch:</td>
        <td style="text-align:right;">${changeStr}</td>
      </tr>
    </tfoot>
  </table>
  <div style="text-align:center;margin-top:6px;font-size:11px;">
    C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ gh√© Tea Neko üíú
  </div>
</div>
</body>
</html>`;

    const win = window.open("", "_blank", "width=400,height=600");
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  }

  function printOrderFromActive(id) {
    const order = activeOrders.find(o => o.id === id);
    if (!order) {
      alert("Kh√¥ng t√¨m th·∫•y ƒë∆°n ƒë·ªÉ in.");
      return;
    }
    printBill(order);
  }

  // ===== REALTIME =====
  function initRealtime() {
    supa
      .channel("pos-all")
      .on("postgres_changes",
        { event: "INSERT", schema: "public", table: "orders" },
        payload => {
          const row = payload.new;
          if (!activeOrders.find(o => o.id === row.id)) {
            activeOrders.unshift(row);
            renderPosHistory();
            recomputeRevenue();
            renderRevenuePage();
            renderHistoryPage();
          }
        }
      )
      .on("postgres_changes",
        { event: "DELETE", schema: "public", table: "orders" },
        payload => {
          const old = payload.old;
          activeOrders = activeOrders.filter(o => o.id !== old.id);
          renderPosHistory();
          recomputeRevenue();
          renderRevenuePage();
          renderHistoryPage();
        }
      )
      .on("postgres_changes",
        { event: "INSERT", schema: "public", table: "deleted_orders" },
        payload => {
          const row = payload.new;
          if (!deletedOrders.find(o => o.id === row.id)) {
            deletedOrders.unshift(row);
            renderHistoryPage();
          }
        }
      )
      .on("postgres_changes",
        { event: "DELETE", schema: "public", table: "deleted_orders" },
        payload => {
          const old = payload.old;
          deletedOrders = deletedOrders.filter(o => o.id !== old.id);
          renderHistoryPage();
        }
      )
      .on("postgres_changes",
        { event: "INSERT", schema: "public", table: "inventory" },
        payload => {
          const row = payload.new;
          if (!inventoryItems.find(i => i.id === row.id)) {
            inventoryItems.unshift(row);
            renderStock();
          }
        }
      )
      .on("postgres_changes",
        { event: "UPDATE", schema: "public", table: "inventory" },
        payload => {
          const row = payload.new;
          const idx = inventoryItems.findIndex(i => i.id === row.id);
          if (idx >= 0) {
            inventoryItems[idx] = row;
            renderStock();
          }
        }
      )
      .subscribe();
  }

  // ===== TAB HANDLERS =====
  tabBtns.forEach((btn, index) => {
    btn.addEventListener("click", () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      pages.forEach(p => p.classList.remove("active"));
      const pageId = btn.getAttribute("data-page");
      document.getElementById(pageId).classList.add("active");

      tabUnderline.style.transform = `translateX(${index * 100}%)`;
    });
  });

  // ===== EVENT BINDINGS =====
  sizeMBtn.addEventListener("click", () => {
    currentSize = "M";
    sizeMBtn.classList.add("active");
    sizeLBtn.classList.remove("active");
  });

  sizeLBtn.addEventListener("click", () => {
    currentSize = "L";
    sizeLBtn.classList.add("active");
    sizeMBtn.classList.remove("active");
  });

  cashInput.addEventListener("input", renderCurrentOrder);

  btnUndo.addEventListener("click", () => {
    if (!currentOrder.length) return;
    const last = currentOrder[currentOrder.length - 1];
    if (last.qty > 1) {
      last.qty -= 1;
      last.lineTotal = last.qty * last.unitPrice;
    } else {
      currentOrder.pop();
    }
    renderCurrentOrder();
  });

  btnClear.addEventListener("click", () => {
    if (!currentOrder.length) return;
    if (!confirm("Xo√° to√†n b·ªô m√≥n trong ƒë∆°n hi·ªán t·∫°i?")) return;
    clearCurrentOrder();
  });

  btnSave.addEventListener("click", () => saveOrder(false));
  btnPrint.addEventListener("click", () => saveOrder(true));

  btnRefreshPosHistory.addEventListener("click", loadAllData);
  btnRefreshRevenue.addEventListener("click", loadAllData);
  btnRefreshHistoryPage.addEventListener("click", loadAllData);

  searchOrderInput.addEventListener("input", renderHistoryPage);

  btnRefreshStock.addEventListener("click", loadAllData);

  btnToggleStockForm.addEventListener("click", () => {
    stockForm.style.display = stockForm.style.display === "none" ? "block" : "none";
  });

  btnCancelStockAdd.addEventListener("click", () => {
    stockForm.style.display = "none";
  });

  btnSaveStock.addEventListener("click", addStockItem);

  // ===== INIT =====
  renderMenu();
  renderCurrentOrder();
  loadAllData();
  initRealtime();
</script>
</body>
</html>
