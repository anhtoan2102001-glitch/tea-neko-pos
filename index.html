<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini POS â€“ Tea Neko</title>

<style>
body {
    background: #0a0f24;
    font-family: system-ui, sans-serif;
    color: white;
    margin: 0;
}
.nav {
    display: flex;
    gap: 8px;
    background: #060a18;
    padding: 10px;
}
.nav button {
    background: #1a2b6d;
    border: none;
    padding: 8px 16px;
    color: white;
    border-radius: 6px;
    font-size: 16px;
}
.nav button.active {
    background: #3b5bff;
}
.box {
    margin: 10px;
    padding: 15px;
    background: #11172f;
    border: 1px solid #394b74;
    border-radius: 8px;
}
.item-btn {
    display: inline-block;
    background: #1c2a49;
    padding: 10px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid #3e4f78;
}
.red-btn {
    background: #d32f2f;
    padding: 12px;
    color: white;
    text-align: center;
    border-radius: 6px;
    margin-top: 6px;
}
.blue-btn {
    background: #004adb;
    padding: 12px;
    color: white;
    text-align: center;
    border-radius: 6px;
    margin-top: 6px;
}
.green-btn {
    background: #20c067;
    padding: 12px;
    color: white;
    text-align: center;
    border-radius: 6px;
    margin-top: 6px;
}
input, select, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: none;
}
.history-delete {
    background: #c62828;
    padding: 6px 10px;
    border-radius: 4px;
    color: white;
    cursor: pointer;
}
.history-print {
    background: #1e8f3a;
    padding: 6px 10px;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    margin-left: 6px;
}
</style>
</head>

<body>

<div class="nav">
    <button class="active" onclick="showTab('pos')">POS</button>
    <button onclick="showTab('qr')">QR Order</button>
    <button onclick="showTab('menu')">Menu</button>
    <button onclick="showTab('inventory')">Tá»“n kho</button>
    <button onclick="showTab('history')">Lá»‹ch sá»­</button>
    <button onclick="showTab('deleted')">ÄÃ£ xoÃ¡</button>
</div>

<!-- POS -->
<div id="pos" class="box">

<h2>POS â€“ Tea Neko</h2>

<div id="menuList"></div>

<h3>ÄÆ¡n hiá»‡n táº¡i:</h3>
<div id="currentOrder"></div>
<div id="total">Tá»•ng: 0Ä‘</div>

<label>KhÃ¡ch Ä‘Æ°a (nghÃ¬n):</label>
<input id="cashInput" type="number">

<label>Ghi chÃº:</label>
<textarea id="note"></textarea>

<div class="blue-btn" onclick="undoLast()">â†© HoÃ n tÃ¡c</div>
<div class="red-btn" onclick="clearOrder()">XoÃ¡ táº¥t cáº£</div>
<div class="blue-btn" onclick="saveOrder()">ğŸ’¾ LÆ°u Ä‘Æ¡n</div>
<div class="green-btn" onclick="saveAndPrint()">ğŸ§¾ LÆ°u + In bill</div>

</div>

<!-- QR ORDER -->
<div id="qr" class="box" style="display:none">
    <h2>QR Order â€“ Danh sÃ¡ch bÃ n</h2>
    <div id="qrTables"></div>
    <div id="qrContent"></div>
</div>

<!-- MENU -->
<div id="menu" class="box" style="display:none">
    <h2>Quáº£n lÃ½ Menu</h2>
    <div id="menuItems"></div>

    <h3>ThÃªm mÃ³n má»›i</h3>
    <input id="newItemName" placeholder="TÃªn mÃ³n">
    <input id="newItemPrice" placeholder="GiÃ¡" type="number">
    <select id="newItemSize">
        <option value="M">M</option>
        <option value="L">L</option>
    </select>
    <div class="green-btn" onclick="addMenuItem()">ThÃªm mÃ³n</div>
</div>

<!-- Tá»’N KHO -->
<div id="inventory" class="box" style="display:none">
    <h2>Tá»“n kho nguyÃªn liá»‡u</h2>
    <div id="inventoryList"></div>

    <h3>ThÃªm nguyÃªn liá»‡u</h3>
    <input id="invName" placeholder="TÃªn nguyÃªn liá»‡u">
    <input id="invQty" placeholder="Sá»‘ lÆ°á»£ng" type="number">
    <input id="invUnit" placeholder="ÄÆ¡n vá»‹ (gr, ml...)">
    <div class="green-btn" onclick="addInventory()">ThÃªm nguyÃªn liá»‡u</div>
</div>

<!-- HISTORY -->
<div id="history" class="box" style="display:none">
    <h2>Lá»‹ch sá»­ Ä‘Æ¡n</h2>
    <div id="historyList"></div>
</div>

<!-- DELETED -->
<div id="deleted" class="box" style="display:none">
    <h2>ÄÆ¡n Ä‘Ã£ xoÃ¡</h2>
    <div id="deletedList"></div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* ============================================
   TAB HIá»‚N THá»Š
============================================ */
window.showTab = function(tab) {
    ["pos","qr","menu","inventory","history","deleted"].forEach(t=>{
        document.getElementById(t).style.display = (t===tab)?"block":"none";
    });
    document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
    event.target.classList.add("active");
};

/* ============================================
   Dá»® LIá»†U MENU (theo menu báº¡n gá»­i)
============================================ */
const MENU = [
    {cat:"Espresso", items:[
        {name:"Phin Ä‘en", price:20},
        {name:"Phin sá»¯a", price:22},
        {name:"Americano", price:25}
    ]},
    {cat:"Latte", items:[
        {name:"Matcha Latte", price:30},
        {name:"Cacao Latte", price:28}
    ]},
    {cat:"TrÃ  sá»¯a", items:[
        {name:"Há»“ng trÃ  sá»¯a", price:28},
        {name:"TrÃ  sá»¯a trÃ¢n chÃ¢u", price:30}
    ]}
];

/* ============================================
   LOAD MENU VÃ€O POS
============================================ */
function loadPOSMenu(){
    let html="";
    MENU.forEach(c=>{
        html += `<h3>${c.cat}</h3>`;
        c.items.forEach(it=>{
            html += `<div class="item-btn" onclick='addItem("${it.name}",${it.price})'>${it.name}<br>${it.price}.000Ä‘</div>`;
        });
    });
    document.getElementById("menuList").innerHTML = html;
}
loadPOSMenu();

/* ============================================
   POS â€“ ÄÆ N HÃ€NG
============================================ */
let order = [];
window.addItem = function(name, price){
    order.push({name, price});
    renderOrder();
};
window.undoLast = function(){
    order.pop();
    renderOrder();
};
window.clearOrder = function(){
    order = [];
    renderOrder();
};
function renderOrder() {
    let html="";
    let total=0;
    order.forEach(o=>{
        html += `â€¢ ${o.name} â€” ${o.price}.000Ä‘<br>`;
        total += o.price;
    });
    document.getElementById("currentOrder").innerHTML = html;
    document.getElementById("total").innerText = "Tá»•ng: " + total + ".000Ä‘";
}

/* ============================================
   LÆ¯U ÄÆ N & IN
============================================ */
window.saveOrder = async function(){
    if(order.length==0) return alert("ChÆ°a cÃ³ mÃ³n!");

    let {error} = await supabase.from("orders").insert({
        items: order,
        total: order.reduce((a,b)=>a+b.price,0),
        note: document.getElementById("note").value
    });

    if(error) return alert("LÆ°u tháº¥t báº¡i!");

    order=[];
    renderOrder();
};
window.saveAndPrint = function(){
    saveOrder();
    window.print();
};

/* ============================================
   Lá»ŠCH Sá»¬ ÄÆ N (CÃ“ NÃšT XOÃ + IN)
============================================ */
async function loadHistory(){
    let {data} = await supabase.from("orders").select("*").order("created_at",{ascending:false});
    let html="";
    data.forEach(o=>{
        html += `
        <div class="box">
            #${o.id} â€” ${o.created_at}<br>
            Tá»•ng: ${o.total}.000Ä‘<br>
            <span class="history-print" onclick='printOrder(${JSON.stringify(o)})'>In</span>
            <span class="history-delete" onclick='deleteOrder(${o.id})'>XoÃ¡</span>
        </div>`;
    });
    document.getElementById("historyList").innerHTML = html;
}
window.printOrder = function(o){
    let w = window.open();
    w.document.write("<h2>HÃ“A ÄÆ N</h2>");
    o.items.forEach(i=> w.document.write(i.name+" â€” "+i.price+".000Ä‘<br>"));
    w.document.write("<br>Tá»•ng: "+o.total+".000Ä‘");
    w.print();
};

/* ============================================
   XOÃ ÄÆ N (CHUYá»‚N SANG deleted_orders)
============================================ */
window.deleteOrder = async function(id){
    let {data} = await supabase.from("orders").select("*").eq("id",id).single();
    if(!data) return;

    await supabase.from("deleted_orders").insert(data);
    await supabase.from("orders").delete().eq("id",id);

    loadHistory();
    loadDeleted();
};

/* ============================================
   LOAD ÄÆ N ÄÃƒ XOÃ
============================================ */
async function loadDeleted(){
    let {data} = await supabase.from("deleted_orders").select("*").order("created_at",{ascending:false});
    let html="";
    data.forEach(o=>{
        html+= `<div class='box'>#${o.id} â€” ${o.total}.000Ä‘</div>`;
    });
    document.getElementById("deletedList").innerHTML = html;
}

/* ============================================
   Tá»’N KHO
============================================ */
async function loadInventory(){
    let {data} = await supabase.from("inventory").select("*");
    let html="";
    data.forEach(i=>{
        html+= `${i.name}: ${i.qty} ${i.unit}<br>`;
    });
    document.getElementById("inventoryList").innerHTML = html;
}
window.addInventory = async function(){
    let name = invName.value;
    let qty = invQty.value;
    let unit = invUnit.value;

    await supabase.from("inventory").insert({name, qty, unit});
    loadInventory();
};

/* ============================================
   MENU â€“ THÃŠM MÃ“N
============================================ */
async function loadMenu(){
    let {data} = await supabase.from("menu").select("*");
    let html="";
    data.forEach(m=>{
        html+= `${m.name} â€” ${m.price}.000Ä‘ (${m.size})<br>`;
    });
    document.getElementById("menuItems").innerHTML = html;
}
window.addMenuItem = async function(){
    await supabase.from("menu").insert({
        name:newItemName.value,
        price:newItemPrice.value,
        size:newItemSize.value
    });
    loadMenu();
};

/* ============================================
   Tá»° Äá»˜NG LOAD
============================================ */
loadHistory();
loadDeleted();
loadInventory();
loadMenu();

</script>

</body>
</html>
