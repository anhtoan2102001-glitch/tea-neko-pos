<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Mini POS ‚Äì Tea Neko</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: #f9fafb;
    }

    .app-shell {
      max-width: 520px;
      margin: 0 auto;
      padding: 12px 10px 20px;
    }

    /* ==== TOP TAB BAR (5 tab) ==== */
    .top-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .top-tab {
      flex: 1;
      text-align: center;
      padding: 7px 4px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      cursor: pointer;
      background: #020617;
      color: #bfdbfe;
      text-decoration: none;
    }
    .top-tab.active {
      background: #1d4ed8;
      color: #ffffff;
      box-shadow: 0 0 0 1px #1d4ed855, 0 10px 25px #1d4ed850;
    }

    /* ==== BOX CHUNG ==== */
    .box {
      background: #020617ee;
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 12px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.9);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 700;
    }

    .sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    /* ==== MENU DRINKS ==== */
    .menu-section-title {
      margin: 6px 0 4px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #a5b4fc;
    }

    .drinks-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .drink-btn {
      padding: 8px 6px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      cursor: pointer;
      text-align: left;
      transition: 0.15s;
    }
    .drink-btn:hover {
      border-color: #1d4ed8;
      box-shadow: 0 0 0 1px #1d4ed860;
    }
    .drink-name {
      font-size: 13px;
      font-weight: 600;
    }
    .drink-price {
      font-size: 11px;
      color: #9ca3af;
    }

    /* ==== SIZE / INPUT / BUTTONS ==== */
    .size-row {
      display: flex;
      gap: 8px;
      margin: 6px 0;
    }
    .size-btn {
      flex: 1;
      border-radius: 999px;
      padding: 7px 4px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: 0.15s;
    }
    .size-btn.active {
      background: #1d4ed8;
      border-color: #2563eb;
      color: #fff;
      box-shadow: 0 0 0 1px #1d4ed855;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }

    .pill-input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }

    .qty-box {
      flex: 0 0 140px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      padding: 3px 4px;
      font-size: 13px;
    }
    .qty-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #e5e7eb;
      font-size: 16px;
      cursor: pointer;
    }
    .qty-value {
      min-width: 26px;
      text-align: center;
      font-weight: 600;
    }

    .btn-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-gray {
      background: #4b5563;
      color: #e5e7eb;
    }
    .btn-red {
      background: #ef4444;
      color: #fee2e2;
    }
    .btn-blue {
      background: #2563eb;
      color: #dbeafe;
    }
    .btn-green {
      background: #16a34a;
      color: #dcfce7;
    }

    .btn:active {
      transform: translateY(1px);
      filter: brightness(0.95);
    }

    /* ==== CURRENT ORDER ==== */
    .order-lines {
      font-size: 13px;
      margin-top: 4px;
    }
    .order-lines div {
      margin-bottom: 2px;
    }
    .order-total {
      margin-top: 6px;
      font-weight: 700;
    }
    .note-line {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* ==== HISTORY ==== */
    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .history-list {
      max-height: 260px;
      overflow-y: auto;
      font-size: 12px;
    }
    .history-item {
      border-bottom: 1px dashed #1f2937;
      padding: 4px 0 6px;
    }
    .history-line-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }
    .order-code {
      font-weight: 600;
      color: #e5e7eb;
    }
    .order-meta {
      font-size: 11px;
      color: #9ca3af;
    }
    .history-delete {
      border-radius: 999px;
      border: none;
      padding: 3px 8px;
      font-size: 11px;
      background: #b91c1c;
      color: #fee2e2;
      cursor: pointer;
    }
    .history-summary {
      white-space: pre-line;
    }

    .history-footer {
      margin-top: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #facc15;
    }

    /* ==== DELETED ORDERS ==== */
    .deleted-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .deleted-list {
      max-height: 180px;
      overflow-y: auto;
      font-size: 12px;
    }
    .deleted-item {
      border-bottom: 1px dashed #1f2937;
      padding: 3px 0 5px;
    }
    .deleted-meta {
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
<div class="app-shell">

  <!-- ====== TAB MENU (5 TAB) ====== -->
  <div class="top-tabs">
    <button class="top-tab active">POS</button>
    <a class="top-tab" href="order.html">QR Order</a>
    <a class="top-tab" href="menu.html">Menu</a>
    <a class="top-tab" href="inventory.html">T·ªìn kho</a>
    <button class="top-tab" onclick="document.getElementById('deletedBox').scrollIntoView({behavior:'smooth'});">
      ƒê√£ xo√°
    </button>
  </div>

  <!-- ====== POS BOX ====== -->
  <div class="box">
    <h2>POS ‚Äì Tea Neko</h2>
    <div class="sub">Ch·ªçn m√≥n ph√≠a d∆∞·ªõi, h·ªá th·ªëng t·ª± c·ªông v√†o ‚Äúƒê∆°n hi·ªán t·∫°i‚Äù.</div>

    <!-- MENU DRINKS (KH√îNG H√åNH) -->
    <div class="menu-section-title">LATTE / COFFEE / TR√Ä S·ªÆA</div>
    <div class="drinks-grid" id="menuGrid">
      <!-- render b·∫±ng JS -->
    </div>

    <!-- SIZE CH·ªåN -->
    <div class="menu-section-title" style="margin-top:10px;">Tu·ª≥ ch·ªçn size</div>
    <div class="size-row">
      <button class="size-btn active" data-size="M" id="sizeM">Size M</button>
      <button class="size-btn" data-size="L" id="sizeL">Size L (+5.000)</button>
    </div>

    <!-- QTY + CASH -->
    <div class="row">
      <div class="qty-box">
        <button class="qty-btn" id="btnQtyMinus">-</button>
        <div class="qty-value" id="qtyValue">1</div>
        <button class="qty-btn" id="btnQtyPlus">+</button>
      </div>
      <input type="number" id="inputCash" class="pill-input"
             placeholder="Kh√°ch ƒë∆∞a (ngh√¨n)" />
    </div>

    <!-- NOTE -->
    <input id="inputNote" class="pill-input"
           placeholder="Ghi ch√∫ cho ƒë∆°n (tu·ª≥ ch·ªçn ‚Äì √≠t ƒë√°, √≠t ng·ªçt...)" />

    <!-- BUTTONS -->
    <div class="btn-row">
      <button class="btn btn-gray" id="btnUndo">‚Ü© Ho√†n t√°c</button>
      <button class="btn btn-red" id="btnClear">Xo√° t·∫•t c·∫£</button>
      <button class="btn btn-blue" id="btnSave">üíæ L∆∞u ƒë∆°n</button>
      <button class="btn btn-green" id="btnSavePrint">üßæ L∆∞u + In bill</button>
    </div>

    <!-- CURRENT ORDER -->
    <div class="menu-section-title" style="margin-top:10px;">ƒê∆°n hi·ªán t·∫°i</div>
    <div class="order-lines" id="currentOrderLines">Ch∆∞a c√≥ m√≥n n√†o.</div>
    <div class="order-total" id="currentOrderTotal">T·ªïng: 0ƒë</div>
    <div class="note-line" id="changeInfo">Ti·ªÅn tr·∫£ l·∫°i kh√°ch: 0ƒë</div>

  </div>

  <!-- ====== HISTORY BOX ====== -->
  <div class="box">
    <div class="history-header">
      <div><b>L·ªãch s·ª≠ ƒë∆°n (Realtime)</b></div>
      <button class="history-delete" id="btnReloadHistory">‚Üª T·∫£i l·∫°i</button>
    </div>
    <div class="history-list" id="historyList">
      ƒêang t·∫£i d·ªØ li·ªáu...
    </div>
    <div class="history-footer" id="totalRevenueLine">
      T·ªïng doanh thu: 0ƒë
    </div>
  </div>

  <!-- ====== DELETED ORDERS BOX ====== -->
  <div class="box" id="deletedBox">
    <div class="deleted-title">ƒê∆°n ƒë√£ xo√° (ch·ªâ xem, kh√¥ng xo√° ti·∫øp)</div>
    <div class="deleted-list" id="deletedList">
      ƒêang t·∫£i d·ªØ li·ªáu...
    </div>
  </div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* ====== MENU G·ªêC ‚Äì KH√îNG H√åNH ====== */
const baseMenu = [
  { id: "matcha",   name: "Matcha Latte",      priceM: 25000, priceL: 30000 },
  { id: "coffee",   name: "Coffee",            priceM: 25000, priceL: 30000 },
  { id: "hongtra",  name: "H·ªìng tr√† s·ªØa",      priceM: 28000, priceL: 33000 },
  { id: "bacxiu",   name: "B·∫°c x·ªâu",           priceM: 20000, priceL: 25000 },
  { id: "trasuacc", name: "Tr√† s·ªØa tr√¢n ch√¢u", priceM: 30000, priceL: 35000 },
  { id: "cacao",    name: "Cacao ƒë√°",         priceM: 22000, priceL: 27000 }
];

/* ====== STATE ====== */
let size = "M";
let qty  = 1;
let currentItems = []; // {name, size, qty, unitPrice, lineTotal}
let undoStack = [];

/* ====== RENDER MENU ====== */
function renderMenu() {
  const grid = document.getElementById("menuGrid");
  grid.innerHTML = "";
  baseMenu.forEach((item) => {
    const btn = document.createElement("button");
    btn.className = "drink-btn";
    btn.innerHTML = `
      <div class="drink-name">${item.name}</div>
      <div class="drink-price">${
        size === "M"
          ? item.priceM.toLocaleString("vi-VN") + "ƒë (Size M)"
          : item.priceL.toLocaleString("vi-VN") + "ƒë (Size L)"
      }</div>`;
    btn.onclick = () => addItem(item);
    grid.appendChild(btn);
  });
}

/* ====== SIZE ====== */
function setSize(newSize) {
  size = newSize;
  document.getElementById("sizeM").classList.toggle("active", size === "M");
  document.getElementById("sizeL").classList.toggle("active", size === "L");
  renderMenu(); // ƒë·ªÉ c·∫≠p nh·∫≠t gi√° hi·ªÉn th·ªã
}

/* ====== QTY ====== */
function setQty(newQty) {
  qty = Math.max(1, newQty);
  document.getElementById("qtyValue").textContent = qty;
}

function addItem(menuItem) {
  const unitPrice = size === "M" ? menuItem.priceM : menuItem.priceL;
  const lineTotal = unitPrice * qty;

  const existing = currentItems.find(
    (it) => it.name === menuItem.name && it.size === size
  );
  if (existing) {
    existing.qty += qty;
    existing.lineTotal += lineTotal;
  } else {
    currentItems.push({
      name: menuItem.name,
      size,
      qty,
      unitPrice,
      lineTotal
    });
  }

  undoStack.push({
    type: "add",
    itemName: menuItem.name,
    size,
    qty
  });

  renderCurrentOrder();
}

function renderCurrentOrder() {
  const box = document.getElementById("currentOrderLines");
  const totalEl = document.getElementById("currentOrderTotal");
  const changeEl = document.getElementById("changeInfo");

  if (!currentItems.length) {
    box.textContent = "Ch∆∞a c√≥ m√≥n n√†o.";
    totalEl.textContent = "T·ªïng: 0ƒë";
    changeEl.textContent = "Ti·ªÅn tr·∫£ l·∫°i kh√°ch: 0ƒë";
    return;
  }

  box.innerHTML = "";
  let total = 0;
  currentItems.forEach((it) => {
    total += it.lineTotal;
    const div = document.createElement("div");
    div.textContent = `${it.qty}x ${it.name} (Size ${it.size}) ‚Äì ${it.lineTotal.toLocaleString("vi-VN")}ƒë`;
    box.appendChild(div);
  });
  totalEl.textContent = "T·ªïng: " + total.toLocaleString("vi-VN") + "ƒë";

  const cashK = Number(document.getElementById("inputCash").value || "0");
  const cash = cashK * 1000;
  const change = Math.max(0, cash - total);
  changeEl.textContent =
    "Ti·ªÅn tr·∫£ l·∫°i kh√°ch: " + change.toLocaleString("vi-VN") + "ƒë";
}

/* ====== HO√ÄN T√ÅC / XO√Å ====== */
function undoLast() {
  const last = undoStack.pop();
  if (!last) return;

  const idx = currentItems.findIndex(
    (it) => it.name === last.itemName && it.size === last.size
  );
  if (idx === -1) return;
  const it = currentItems[idx];
  it.qty -= last.qty;
  it.lineTotal -= it.unitPrice * last.qty;
  if (it.qty <= 0 || it.lineTotal <= 0) {
    currentItems.splice(idx, 1);
  }
  renderCurrentOrder();
}

function clearOrder() {
  if (!currentItems.length) return;
  if (!confirm("Xo√° to√†n b·ªô m√≥n trong ƒë∆°n hi·ªán t·∫°i?")) return;
  currentItems = [];
  undoStack = [];
  renderCurrentOrder();
}

/* ====== SAVE ORDER TO SUPABASE ====== */
async function saveOrder(printAfter) {
  if (!currentItems.length) {
    alert("Ch∆∞a c√≥ m√≥n n√†o trong ƒë∆°n.");
    return;
  }

  let total = 0;
  currentItems.forEach((it) => (total += it.lineTotal));

  const cashK = Number(document.getElementById("inputCash").value || "0");
  const cash = cashK * 1000;
  const change = Math.max(0, cash - total);
  const note = document.getElementById("inputNote").value.trim();

  const { data: last, error: lastErr } = await supabase
    .from("orders")
    .select("order_code")
    .order("created_at", { ascending: false })
    .limit(1)
    .maybeSingle();

  let nextNumber = 1;
  if (!lastErr && last && last.order_code) {
    const m = last.order_code.match(/#(\d+)/);
    if (m) nextNumber = Number(m[1]) + 1;
  }
  const orderCode = "#" + String(nextNumber).padStart(4, "0");

  const payload = {
    order_code: orderCode,
    items: currentItems,
    total,
    cash_given: cash,
    change,
    note
  };

  const { error } = await supabase.from("orders").insert([payload]);
  if (error) {
    console.error(error);
    alert("L∆∞u ƒë∆°n th·∫•t b·∫°i.");
    return;
  }

  currentItems = [];
  undoStack = [];
  document.getElementById("inputCash").value = "";
  document.getElementById("inputNote").value = "";
  renderCurrentOrder();
  await loadHistory();

  if (printAfter) {
    window.print(); // in ƒë∆°n t·∫°m th·ªùi (chrome / c·ªëc c·ªëc)
  } else {
    alert("ƒê√£ l∆∞u ƒë∆°n " + orderCode);
  }
}

/* ====== HISTORY + DELETED ====== */
async function loadHistory() {
  const listEl = document.getElementById("historyList");
  listEl.textContent = "ƒêang t·∫£i d·ªØ li·ªáu...";

  const { data, error } = await supabase
    .from("orders")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    listEl.textContent = "L·ªói t·∫£i l·ªãch s·ª≠ ƒë∆°n.";
    return;
  }

  if (!data.length) {
    listEl.textContent = "Ch∆∞a c√≥ ƒë∆°n n√†o.";
    document.getElementById("totalRevenueLine").textContent =
      "T·ªïng doanh thu: 0ƒë";
    return;
  }

  listEl.innerHTML = "";
  let totalRev = 0;

  data.forEach((row) => {
    totalRev += row.total || 0;
    const div = document.createElement("div");
    div.className = "history-item";

    const itemsSummary = (row.items || [])
      .map(
        (it) =>
          `${it.qty}x ${it.name} (Size ${it.size}) ‚Äì ${it.lineTotal.toLocaleString(
            "vi-VN"
          )}ƒë`
      )
      .join("\n");

    div.innerHTML = `
      <div class="history-line-top">
        <div>
          <div class="order-code">${row.order_code || "N/A"}</div>
          <div class="order-meta">
            ${new Date(row.created_at).toLocaleString("vi-VN")}
          </div>
        </div>
        <button class="history-delete" data-id="${row.id}">Xo√° ƒë∆°n</button>
      </div>
      <div class="history-summary">${itemsSummary}</div>
      <div class="order-meta">
        T·ªïng: ${(row.total || 0).toLocaleString("vi-VN")}ƒë
        ${
          row.cash_given
            ? " | Kh√°ch ƒë∆∞a: " +
              row.cash_given.toLocaleString("vi-VN") +
              "ƒë ‚Äì Tr·∫£ l·∫°i kh√°ch: " +
              (row.change || 0).toLocaleString("vi-VN") +
              "ƒë"
            : ""
        }
        ${row.note ? "<br>Ghi ch√∫: " + row.note : ""}
      </div>
    `;
    listEl.appendChild(div);
  });

  document.getElementById("totalRevenueLine").textContent =
    "T·ªïng doanh thu: " + totalRev.toLocaleString("vi-VN") + "ƒë";

  listEl.querySelectorAll(".history-delete").forEach((btn) => {
    btn.onclick = () => deleteOrder(btn.dataset.id);
  });

  await loadDeleted();
}

async function deleteOrder(id) {
  if (!confirm("Xo√° ƒë∆°n n√†y v√† chuy·ªÉn v√†o m·ª•c ƒê√£ xo√°?")) return;

  const { data, error } = await supabase
    .from("orders")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    console.error(error);
    alert("Kh√¥ng t√¨m th·∫•y ƒë∆°n ƒë·ªÉ xo√°.");
    return;
  }

  const payload = {
    ...data,
    deleted_at: new Date().toISOString()
  };

  const { error: insErr } = await supabase
    .from("deleted_orders")
    .insert([payload]);

  if (insErr) {
    console.error(insErr);
    alert("Kh√¥ng th·ªÉ ch√©p sang b·∫£ng deleted_orders.");
    return;
  }

  const { error: delErr } = await supabase
    .from("orders")
    .delete()
    .eq("id", id);

  if (delErr) {
    console.error(delErr);
    alert("Xo√° ƒë∆°n tr√™n b·∫£ng orders th·∫•t b·∫°i.");
    return;
  }

  await loadHistory();
}

async function loadDeleted() {
  const listEl = document.getElementById("deletedList");
  const { data, error } = await supabase
    .from("deleted_orders")
    .select("*")
    .order("deleted_at", { ascending: false })
    .limit(50);

  if (error) {
    console.error(error);
    listEl.textContent = "L·ªói t·∫£i ƒë∆°n ƒë√£ xo√°.";
    return;
  }

  if (!data.length) {
    listEl.textContent = "Ch∆∞a c√≥ ƒë∆°n n√†o b·ªã xo√°.";
    return;
  }

  listEl.innerHTML = "";
  data.forEach((row) => {
    const div = document.createElement("div");
    div.className = "deleted-item";

    const itemsSummary = (row.items || [])
      .map((it) => `${it.qty}x ${it.name} (Size ${it.size})`)
      .join(", ");

    div.innerHTML = `
      <div><b>${row.order_code || "N/A"}</b> ‚Äì ${
      (row.total || 0).toLocaleString("vi-VN") + "ƒë"
    }</div>
      <div class="deleted-meta">
        Xo√° l√∫c: ${
          row.deleted_at
            ? new Date(row.deleted_at).toLocaleString("vi-VN")
            : "kh√¥ng r√µ"
        }
      </div>
      <div class="deleted-meta">${itemsSummary}</div>
      ${row.note ? '<div class="deleted-meta">Ghi ch√∫: ' + row.note + "</div>" : ""}
    `;
    listEl.appendChild(div);
  });
}

/* ====== EVENT BINDING ====== */
document.getElementById("sizeM").onclick = () => setSize("M");
document.getElementById("sizeL").onclick = () => setSize("L");

document.getElementById("btnQtyMinus").onclick = () => setQty(qty - 1);
document.getElementById("btnQtyPlus").onclick = () => setQty(qty + 1);

document.getElementById("inputCash").addEventListener("input", () =>
  renderCurrentOrder()
);

document.getElementById("btnUndo").onclick = undoLast;
document.getElementById("btnClear").onclick = clearOrder;
document.getElementById("btnSave").onclick = () => saveOrder(false);
document.getElementById("btnSavePrint").onclick = () => saveOrder(true);
document.getElementById("btnReloadHistory").onclick = loadHistory;

/* ====== INIT ====== */
renderMenu();
renderCurrentOrder();
loadHistory();
</script>
</body>
</html>
