<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tea Neko – Đặt món</title>

<style>
    body {
        margin: 0;
        background: #0b1220;
        font-family: system-ui, sans-serif;
        color: #fff;
    }

    h2 {
        padding: 16px;
        text-align: center;
        font-size: 26px;
        font-weight: 700;
    }

    .item-box {
        background: #111a30;
        margin: 14px;
        padding: 14px;
        border-radius: 14px;
        box-shadow: 0 0 6px #0006;
    }
    .item-box img {
        width: 100%;
        border-radius: 10px;
    }

    .title {
        font-size: 20px;
        margin-top: 10px;
        font-weight: 600;
    }

    .price {
        opacity: 0.8;
        margin-bottom: 8px;
    }

    .qty-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
    }
    .qty-btn {
        background: #222;
        padding: 6px 14px;
        border-radius: 8px;
        user-select: none;
        cursor: pointer;
        font-size: 20px;
    }

    #cart-box {
        background: #111a30;
        margin: 14px;
        padding: 14px;
        border-radius: 14px;
        box-shadow: 0 0 6px #0006;
    }

    #send-btn {
        margin-top: 14px;
        background: #00ff90;
        width: 100%;
        padding: 16px;
        text-align: center;
        border-radius: 12px;
        color: #003300;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
    }

    #error {
        margin-top: 14px;
        color: #ff8080;
        text-align: center;
        font-weight: 500;
    }
</style>
</head>

<body>
<h2>Menu gọi món</h2>

<div id="menu"></div>

<div id="cart-box">
    <div style="font-size:20px; font-weight:700;">Đơn của bạn</div>
    <div id="cart-list" style="margin-top:10px;"></div>
    <div id="total" style="margin-top:10px; font-size:20px; font-weight:700;"></div>

    <textarea id="note" placeholder="Ghi chú..." style="width:100%; margin-top:10px; padding:10px; border-radius:8px; border:none;"></textarea>

    <div id="send-btn">Gửi order đến Tea Neko</div>
    <div id="error"></div>
</div>

<script type="module">

// =============== SUPABASE ===============
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
    "https://kcrchwedlrettpkucoct.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw"
);

// =============== MENU ===============
const menuData = [
    {
        name: "Matcha Latte",
        price: 25000,
        img: "https://i.imgur.com/yLaQf2x.jpeg"
    },
    {
        name: "Hồng trà sữa",
        price: 28000,
        img: "https://i.imgur.com/8pSx3o7.jpeg"
    },
    {
        name: "Bạc xỉu",
        price: 20000,
        img: "https://i.imgur.com/Y8fU6pF.jpeg"
    }
];

let cart = {};

function renderMenu() {
    let html = "";
    menuData.forEach((item, index) => {
        html += `
        <div class="item-box">
            <img src="${item.img}" />
            <div class="title">${item.name}</div>
            <div class="price">${item.price.toLocaleString()}đ</div>
            <div class="qty-box">
                <div class="qty-btn" onclick="updateQty(${index}, -1)">−</div>
                <div>${cart[index]?.qty ?? 0}</div>
                <div class="qty-btn" onclick="updateQty(${index}, 1)">+</div>
            </div>
        </div>
        `;
    });
    document.getElementById("menu").innerHTML = html;
}

window.updateQty = (index, delta) => {
    if (!cart[index]) cart[index] = { ...menuData[index], qty: 0 };
    cart[index].qty += delta;
    if (cart[index].qty <= 0) delete cart[index];
    renderMenu();
    renderCart();
};

function renderCart() {
    let html = "";
    let total = 0;
    Object.values(cart).forEach(item => {
        html += `
            <div>${item.qty}x ${item.name} — ${(item.qty * item.price).toLocaleString()}đ</div>
        `;
        total += item.qty * item.price;
    });

    document.getElementById("cart-list").innerHTML = html || "Chưa có món nào.";
    document.getElementById("total").innerHTML = "Tổng: " + total.toLocaleString() + "đ";
}

renderMenu();
renderCart();

// =============== GỬI ORDER ===============
document.getElementById("send-btn").addEventListener("click", async () => {
    if (Object.keys(cart).length === 0) {
        document.getElementById("error").innerText = "Bạn chưa chọn món!";
        return;
    }

    const table = new URLSearchParams(location.search).get("table") || "N/A";

    const { error } = await supabase.from("web_orders").insert([
        {
            table_id: table,
            items: Object.values(cart),
            note: document.getElementById("note").value,
            status: "pending"
        }
    ]);

    if (error) {
        document.getElementById("error").innerText = "Gửi order thất bại!";
    } else {
        document.getElementById("error").innerText = "";
        alert("Đã gửi order thành công!");
        cart = {};
        renderMenu();
        renderCart();
    }
});

</script>

</body>
</html>
