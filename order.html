<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tea Neko ‚Äì ƒê·∫∑t m√≥n</title>

  <style>
    :root {
      --bg: #020617;
      --card: #05091a;
      --card-soft: #0b1220;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.18);
      --danger: #ef4444;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .page {
      max-width: 640px;
      margin: 0 auto;
      padding: 16px 14px 24px;
    }

    header {
      text-align: center;
      padding-bottom: 10px;
    }

    header h1 {
      font-size: 22px;
      margin: 4px 0 2px;
      font-weight: 700;
    }

    header .subtitle {
      font-size: 13px;
      color: var(--muted);
    }

    .table-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 13px;
    }

    .table-pill span.badge {
      padding: 3px 9px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 700;
      font-size: 12px;
    }

    .menu-section-title {
      margin: 14px 4px 8px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--muted);
    }

    .menu-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .item-card {
      background: linear-gradient(135deg, #020617, #020617);
      border-radius: 14px;
      padding: 10px 12px 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.75);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .item-name {
      font-size: 15px;
      font-weight: 600;
    }

    .item-category {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--muted);
      align-self: flex-start;
    }

    .item-prices {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .size-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 7px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(30, 64, 175, 0.5);
      margin-top: 3px;
    }

    .size-label {
      font-size: 12px;
      font-weight: 500;
    }

    .size-price {
      font-size: 12px;
      color: #e5e7eb;
      margin-left: 4px;
    }

    .qty-controls {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .qty-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      cursor: pointer;
      font-size: 18px;
      line-height: 0;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.4);
    }

    .qty-btn:active {
      transform: scale(0.96);
      background: rgba(30, 64, 175, 0.9);
    }

    .qty-value {
      min-width: 20px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }

    /* Cart summary */

    .cart-card {
      margin-top: 16px;
      padding: 12px 12px 14px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.85);
    }

    .cart-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .cart-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .cart-items {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .cart-items p {
      margin: 2px 0;
    }

    .cart-empty {
      font-size: 13px;
      color: var(--muted);
      font-style: italic;
    }

    .cart-total-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0 2px;
      font-size: 14px;
      font-weight: 600;
    }

    .cart-total-row span:last-child {
      font-size: 15px;
    }

    .note-input {
      width: 100%;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: #020617;
      color: var(--text);
      font-size: 13px;
      padding: 8px 10px;
      resize: vertical;
      min-height: 48px;
    }

    .note-input::placeholder {
      color: #6b7280;
    }

    .btn-submit {
      margin-top: 10px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 11px 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      color: #022c22;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
    }

    .btn-submit:active {
      transform: translateY(1px);
      box-shadow: 0 4px 18px rgba(34, 197, 94, 0.4);
    }

    .status-msg {
      margin-top: 8px;
      font-size: 13px;
    }

    .status-ok {
      color: #a7f3d0;
    }

    .status-error {
      color: #fecaca;
    }

    footer {
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      padding-top: 6px;
      padding-bottom: 4px;
    }

    @media (min-width: 700px) {
      .page {
        padding-top: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div style="font-size:13px;color:var(--muted);">Tea Neko ‚Ä¢ QR Order</div>
      <h1>Menu g·ªçi m√≥n</h1>
      <div class="subtitle">Ch·ªçn m√≥n, ki·ªÉm tra l·∫°i r·ªìi b·∫•m g·ª≠i cho qu√°n.</div>
      <div class="table-pill" id="tableInfo">
        <span>B√†n</span>
        <span class="badge" id="tableBadge">?</span>
      </div>
    </header>

    <div id="menuRoot">
      <div class="menu-section-title">ƒêang t·∫£i menu‚Ä¶</div>
    </div>

    <div class="cart-card">
      <div class="cart-title">ƒê∆°n c·ªßa b·∫°n</div>
      <div class="cart-sub">Ki·ªÉm tra l·∫°i tr∆∞·ªõc khi g·ª≠i ƒë·∫øn Tea Neko.</div>
      <div id="cartItems" class="cart-items cart-empty">
        Ch∆∞a c√≥ m√≥n n√†o.
      </div>
      <div class="cart-total-row">
        <span>T·ªïng:</span>
        <span id="cartTotal">0ƒë</span>
      </div>
      <textarea
        id="noteInput"
        class="note-input"
        placeholder="Ghi ch√∫ cho qu√°n (√≠t ƒë√°, √≠t ng·ªçt, kh√¥ng tr√¢n ch√¢u‚Ä¶)"
      ></textarea>
      <button id="btnSubmit" class="btn-submit">
        G·ª≠i order ƒë·∫øn Tea Neko
      </button>
      <div id="statusMsg" class="status-msg"></div>
    </div>

    <footer>
      N·∫øu c·∫ßn s·ª≠a order sau khi g·ª≠i, h√£y b√°o l·∫°i nh√¢n vi√™n Tea Neko nh√© üíú
    </footer>
  </div>

  <script type="module">
    import { supabase } from "./js/supabase.js";

    const menuRoot = document.getElementById("menuRoot");
    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");
    const noteInput = document.getElementById("noteInput");
    const btnSubmit = document.getElementById("btnSubmit");
    const statusMsg = document.getElementById("statusMsg");
    const tableBadge = document.getElementById("tableBadge");
    const tableInfo = document.getElementById("tableInfo");

    // ===== L·∫§Y S·ªê B√ÄN T·ª™ URL =====
    const params = new URLSearchParams(window.location.search);
    const tableNo = Number(params.get("table")) || 0;

    if (tableNo > 0) {
      tableBadge.textContent = tableNo.toString();
    } else {
      tableBadge.textContent = "Mang ƒëi";
      tableInfo.firstElementChild.textContent = "H√¨nh th·ª©c";
    }

    // ===== CART TRONG RAM =====
    // key = `${id}_M` ho·∫∑c `${id}_L`
    const cart = new Map();
    let menuCache = [];

    function formatPrice(vnd) {
      if (!vnd || vnd <= 0) return "0ƒë";
      return vnd.toLocaleString("vi-VN") + "ƒë";
    }

    function renderCart() {
      if (cart.size === 0) {
        cartItemsEl.classList.add("cart-empty");
        cartItemsEl.innerHTML = "Ch∆∞a c√≥ m√≥n n√†o.";
        cartTotalEl.textContent = "0ƒë";
        return;
      }

      cartItemsEl.classList.remove("cart-empty");
      let html = "";
      let total = 0;

      for (const [, item] of cart) {
        const lineTotal = item.qty * item.price;
        total += lineTotal;
        html += `<p>${item.qty}x ${item.name} <span style="color:#9ca3af;">(Size ${item.size})</span> ‚Äî ${formatPrice(lineTotal)}</p>`;
      }

      cartItemsEl.innerHTML = html;
      cartTotalEl.textContent = formatPrice(total);
    }

    function changeQty(key, delta) {
      const existing = cart.get(key);
      if (!existing) return;

      const newQty = existing.qty + delta;
      if (newQty <= 0) {
        cart.delete(key);
      } else {
        existing.qty = newQty;
        cart.set(key, existing);
      }
      renderCart();
    }

    function addLine(item, size) {
      const price =
        size === "L" && item.price_l ? item.price_l : item.price_m || 0;
      if (!price) return;

      const key = `${item.id}_${size}`;
      const existing = cart.get(key);
      if (existing) {
        existing.qty += 1;
        cart.set(key, existing);
      } else {
        cart.set(key, {
          key,
          id: item.id,
          name: item.name,
          size,
          qty: 1,
          price,
        });
      }
      renderCart();
    }

    function buildMenuUI(items) {
      if (!items || !items.length) {
        menuRoot.innerHTML =
          '<div class="menu-section-title">Menu t·∫°m th·ªùi ch∆∞a c√≥ m√≥n ü•≤</div>';
        return;
      }

      // Nh√≥m theo category
      const grouped = {};
      for (const it of items) {
        const cat = it.category || "Kh√°c";
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(it);
      }

      let html = "";
      for (const [cat, list] of Object.entries(grouped)) {
        html += `<div class="menu-section-title">${cat}</div>
                 <div class="menu-grid">`;

        list.forEach((item) => {
          html += `
            <div class="item-card" data-id="${item.id}">
              <div class="item-header">
                <div class="item-name">${item.name}</div>
                <div class="item-category">${cat}</div>
              </div>
              <div class="item-prices">
                ${
                  item.price_m
                    ? `<span>Size M: <strong>${formatPrice(
                        item.price_m
                      )}</strong></span>`
                    : ""
                }
                ${
                  item.price_l
                    ? `<span>Size L: <strong>${formatPrice(
                        item.price_l
                      )}</strong></span>`
                    : ""
                }
              </div>

              ${
                item.price_m
                  ? `
              <div class="size-row" data-size="M">
                <div>
                  <span class="size-label">Size M</span>
                  <span class="size-price">${formatPrice(item.price_m)}</span>
                </div>
                <div class="qty-controls">
                  <button class="qty-btn" data-action="dec">‚àí</button>
                  <span class="qty-value" data-qty="M">0</span>
                  <button class="qty-btn" data-action="inc">+</button>
                </div>
              </div>`
                  : ""
              }

              ${
                item.price_l
                  ? `
              <div class="size-row" data-size="L" style="margin-top:6px;">
                <div>
                  <span class="size-label">Size L</span>
                  <span class="size-price">${formatPrice(item.price_l)}</span>
                </div>
                <div class="qty-controls">
                  <button class="qty-btn" data-action="dec">‚àí</button>
                  <span class="qty-value" data-qty="L">0</span>
                  <button class="qty-btn" data-action="inc">+</button>
                </div>
              </div>`
                  : ""
              }
            </div>
          `;
        });

        html += `</div>`;
      }

      menuRoot.innerHTML = html;

      // G·∫Øn event
      document.querySelectorAll(".item-card").forEach((card) => {
        const id = card.getAttribute("data-id");
        const item = items.find((x) => x.id === id);
        if (!item) return;

        card.querySelectorAll(".size-row").forEach((row) => {
          const size = row.getAttribute("data-size");
          const qtySpan = row.querySelector("[data-qty]");
          row.querySelectorAll(".qty-btn").forEach((btn) => {
            const action = btn.getAttribute("data-action");
            btn.addEventListener("click", () => {
              const key = `${item.id}_${size}`;
              if (action === "inc") {
                addLine(item, size);
              } else {
                // dec
                if (!cart.has(key)) return;
                changeQty(key, -1);
              }
              const inCart = cart.get(key);
              qtySpan.textContent = inCart ? inCart.qty : "0";
            });
          });
        });
      });
    }

    async function loadMenu() {
      try {
        const { data, error } = await supabase
          .from("menu_items")
          .select("*")
          .order("category", { ascending: true })
          .order("name", { ascending: true });

        if (error) throw error;
        menuCache = data || [];
        buildMenuUI(menuCache);
      } catch (err) {
        console.error(err);
        menuRoot.innerHTML =
          '<div class="menu-section-title">Kh√¥ng t·∫£i ƒë∆∞·ª£c menu. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
      }
    }

    async function sendOrder() {
      statusMsg.textContent = "";
      statusMsg.className = "status-msg";

      if (cart.size === 0) {
        statusMsg.textContent = "B·∫°n ch∆∞a ch·ªçn m√≥n n√†o.";
        statusMsg.classList.add("status-error");
        return;
      }

      btnSubmit.disabled = true;
      btnSubmit.textContent = "ƒêang g·ª≠i order‚Ä¶";

      const itemsPayload = [];
      let total = 0;
      for (const [, line] of cart) {
        const lineTotal = line.qty * line.price;
        total += lineTotal;
        itemsPayload.push({
          name: line.name,
          size: line.size,
          qty: line.qty,
          price: line.price,
          line_total: lineTotal,
        });
      }

      const payload = {
        table_no: tableNo || null,
        items: itemsPayload,
        total,
        note: noteInput.value.trim() || null,
        status: "pending",
      };

      try {
        const { error } = await supabase.from("web_orders").insert(payload);
        if (error) throw error;

        statusMsg.textContent =
          "G·ª≠i order th√†nh c√¥ng. Tea Neko ƒëang chu·∫©n b·ªã m√≥n cho b·∫°n üíú";
        statusMsg.classList.add("status-ok");

        cart.clear();
        renderCart();
        noteInput.value = "";

        // Reset s·ªë l∆∞·ª£ng hi·ªÉn th·ªã tr√™n t·ª´ng m√≥n
        document
          .querySelectorAll(".qty-value")
          .forEach((el) => (el.textContent = "0"));
      } catch (err) {
        console.error(err);
        statusMsg.textContent = "G·ª≠i order th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.";
        statusMsg.classList.add("status-error");
      } finally {
        btnSubmit.disabled = false;
        btnSubmit.textContent = "G·ª≠i order ƒë·∫øn Tea Neko";
      }
    }

    btnSubmit.addEventListener("click", sendOrder);

    // INIT
    loadMenu();
  </script>
</body>
</html>
