<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Order – Tea Neko</title>

<style>
body {
  margin: 0;
  background: #0b1122;
  color: white;
  font-family: Arial, sans-serif;
}
.container {
  max-width: 600px;
  margin: auto;
  padding: 20px;
}
.itemBox {
  background: #111a33;
  border-radius: 14px;
  border: 1px solid #334155;
  margin-bottom: 18px;
  overflow: hidden;
}
.itemBox img {
  width: 100%;
  height: 220px;
  object-fit: cover;
}
.name {
  font-size: 20px;
  font-weight: 600;
  margin: 10px;
}
.price {
  margin: 0 10px 10px 10px;
  opacity: 0.8;
}
.qtyBox {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 10px;
}
.qtyBox button {
  width: 34px;
  height: 34px;
  background: #334155;
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 20px;
}
.qty {
  font-size: 22px;
  margin: 0 15px;
}
.orderBox {
  background: #111a33;
  border-radius: 14px;
  border: 1px solid #334155;
  padding: 16px;
  margin-top: 30px;
}
.greenBtn {
  margin-top: 14px;
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  background: #22c55e;
  color: #052e16;
  border: none;
  font-size: 20px;
  font-weight: 600;
}
</style>
</head>

<body>
<div class="container">

<h2>Đặt món – Bàn <span id="tableNo"></span></h2>

<div id="menuArea"></div>

<div class="orderBox">
  <h3>Đơn của bạn</h3>
  <div id="cartList">Chưa chọn món.</div>
  <div><b>Tổng:</b> <span id="total">0</span>đ</div>

  <textarea id="note" placeholder="Ghi chú..." 
  style="width:100%;margin-top:10px;border-radius:10px;padding:10px;"></textarea>

  <button id="sendOrderBtn" class="greenBtn">Gửi order đến Tea Neko</button>

  <p id="status" style="margin-top:10px;color:#fb7185;"></p>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

// ===========================
// 1. SUPABASE CONFIG
// ===========================
const SUPABASE_URL = "https://kcrchwedlrettpkucoct.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===========================
// 2. Lấy số bàn từ URL
// ===========================
const url = new URLSearchParams(window.location.search);
const tableNo = url.get("table") || "N/A";
document.getElementById("tableNo").innerText = tableNo;

// ===========================
// 3. MENU (ảnh bạn có thể đổi link bất kỳ)
// ===========================
const MENU = [
  {
    id: 1,
    name: "Matcha Latte",
    price: 25000,
    img: "https://i.imgur.com/4ZQZ4aB.jpeg"
  },
  {
    id: 2,
    name: "Trà sữa trân châu",
    price: 30000,
    img: "https://i.imgur.com/qsjQX0m.jpeg"
  },
  {
    id: 3,
    name: "Hồng trà sữa",
    price: 28000,
    img: "https://i.imgur.com/lq1mE0n.jpeg"
  },
  {
    id: 4,
    name: "Bạc xỉu",
    price: 20000,
    img: "https://i.imgur.com/LZttrCS.jpeg"
  }
];

// giỏ hàng
let cart = {};

// render menu
function renderMenu() {
  let html = "";

  MENU.forEach(m => {
    cart[m.id] = 0;

    html += `
      <div class="itemBox">
        <img src="${m.img}">
        <div class="name">${m.name}</div>
        <div class="price">${m.price.toLocaleString()}đ</div>

        <div class="qtyBox">
          <button onclick="changeQty(${m.id}, -1)">-</button>
          <div class="qty" id="qty_${m.id}">0</div>
          <button onclick="changeQty(${m.id}, +1)">+</button>
        </div>
      </div>
    `;
  });

  document.getElementById("menuArea").innerHTML = html;
}

renderMenu();

// ===========================
// 4. Thay đổi số lượng món
// ===========================
function changeQty(id, delta) {
  cart[id] += delta;
  if (cart[id] < 0) cart[id] = 0;

  document.getElementById("qty_" + id).innerText = cart[id];
  updateCart();
}

// ===========================
// 5. Render đơn khách
// ===========================
function updateCart() {
  let html = "";
  let sum = 0;

  MENU.forEach(m => {
    if (cart[m.id] > 0) {
      html += `${cart[m.id]}x ${m.name} — ${(m.price * cart[m.id]).toLocaleString()}đ<br>`;
      sum += m.price * cart[m.id];
    }
  });

  document.getElementById("cartList").innerHTML = html || "Chưa chọn món.";
  document.getElementById("total").innerText = sum.toLocaleString();
}

// ===========================
// 6. Gửi order
// ===========================
document.getElementById("sendOrderBtn").onclick = async () => {

  let items = [];
  MENU.forEach(m => {
    if (cart[m.id] > 0) {
      items.push({
        name: m.name,
        qty: cart[m.id],
        price: m.price
      });
    }
  });

  if (items.length === 0) {
    document.getElementById("status").innerText = "Bạn chưa chọn món.";
    return;
  }

  let total = Number(document.getElementById("total").innerText.replace(/\./g, ""));
  let note  = document.getElementById("note").value || null;

  const { error } = await db.from("web_orders").insert({
    table_no: tableNo,
    items: items,
    total: total,
    note: note,
    status: "pending"
  });

  if (error) {
    document.getElementById("status").innerText = "Gửi thất bại: " + error.message;
  } else {
    document.getElementById("status").style.color = "#4ade80";
    document.getElementById("status").innerText = "Order đã gửi thành công!";
    cart = {};
    renderMenu();
    updateCart();
  }
};

</script>

</body>
</html>
