<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Order Online – Tea Neko</title>

<!-- FONT + STYLE -->
<style>
body {
    margin: 0;
    background: #0d1224;
    font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
    color: white;
}
.box {
    max-width: 480px;
    margin: auto;
    padding: 14px;
}
.item {
    background: #111a33;
    border-radius: 14px;
    margin-bottom: 18px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.item img {
    width: 100%;
    height: 220px;
    object-fit: cover;
}
.item-name {
    font-size: 20px;
    font-weight: 600;
    padding: 10px 14px 0 14px;
}
.item-price {
    opacity: .8;
    padding: 0 14px 8px 14px;
}
.qty-row {
    padding: 10px 14px 14px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.qty button {
    width: 34px;
    height: 34px;
    border-radius: 34px;
    border: none;
    font-size: 20px;
}
.order-box {
    background: #111a33;
    border-radius: 16px;
    padding: 16px;
    margin-top: 20px;
}
.btn-send {
    margin-top: 10px;
    width: 100%;
    padding: 16px;
    font-size: 18px;
    background: #00ff88;
    border: none;
    border-radius: 14px;
    font-weight: 600;
}
</style>
</head>
<body>

<div class="box">
    <h2>Menu gọi món</h2>
    <div id="menuList"></div>

    <div id="orderBox" class="order-box" style="display:none;">
        <h3>Đơn của bạn</h3>
        <div id="orderItems"></div>
        <h3 id="orderTotal"></h3>

        <textarea id="note" placeholder="Ghi chú..." 
        style="width:100%; padding:12px; border-radius:10px; margin-top:10px;"></textarea>

        <button class="btn-send" onclick="sendOrder()">Gửi order đến Tea Neko</button>

        <p id="statusText" style="color:#ff8080; margin-top:10px;"></p>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

// ============================
// 1. SUPABASE CONFIG
// ============================
const supabaseUrl = "https://kcrchwdelrettpkucoct.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw";

const db = supabase.createClient(supabaseUrl, supabaseKey);

// Lấy số bàn từ URL
const urlParams = new URLSearchParams(window.location.search);
const tableNumber = urlParams.get("table") || "0";


// ============================
// 2. MENU – bạn có thể đổi ảnh & giá tùy ý
// ============================
const MENU = [
    {
        id: 1,
        name: "Matcha Latte",
        priceM: 25000,
        priceL: 30000,
        img: "https://i.imgur.com/4ZQZ4aB.jpeg"
    },
    {
        id: 2,
        name: "Trà sữa trân châu",
        priceM: 30000,
        priceL: 35000,
        img: "https://i.imgur.com/qsjQX0m.jpeg"
    },
    {
        id: 3,
        name: "Hồng trà sữa",
        priceM: 28000,
        priceL: 33000,
        img: "https://i.imgur.com/lq1mE0n.jpeg"
    },
    {
        id: 4,
        name: "Bạc xỉu",
        priceM: 20000,
        priceL: 25000,
        img: "https://i.imgur.com/LZttrCS.jpeg"
    }
];

// Giỏ hàng khách
let cart = [];


// ============================
// 3. RENDER MENU
// ============================
function renderMenu() {
    let html = "";

    MENU.forEach(item => {
        html += `
        <div class="item">
            <img src="${item.img}">
            <div class="item-name">${item.name}</div>
            <div class="item-price">${item.priceM.toLocaleString()}đ (Size M)</div>

            <div class="qty-row">
                <span onclick="changeQty(${item.id}, -1)" style="font-size:22px;">➖</span>
                <span id="qty_${item.id}">0</span>
                <span onclick="changeQty(${item.id}, 1)" style="font-size:22px;">➕</span>
            </div>
        </div>
        `;
    });

    document.getElementById("menuList").innerHTML = html;
}
renderMenu();


// ============================
// 4. THÊM / GIẢM SỐ LƯỢNG
// ============================
function changeQty(id, delta) {
    let item = cart.find(x => x.id === id);

    if (!item) {
        if (delta > 0) {
            const product = MENU.find(x => x.id === id);
            cart.push({
                id: id,
                name: product.name,
                qty: 1,
                size: "M",
                price: product.priceM
            });
        }
    } else {
        item.qty += delta;
        if (item.qty <= 0) {
            cart = cart.filter(x => x.id !== id);
        }
    }

    updateUI();
}


// ============================
// 5. UPDATE UI
// ============================
function updateUI() {
    cart.forEach(c => {
        const q = document.getElementById("qty_" + c.id);
        if (q) q.innerText = c.qty;
    });

    if (cart.length === 0) {
        document.getElementById("orderBox").style.display = "none";
        return;
    }

    document.getElementById("orderBox").style.display = "block";

    let html = "";
    let total = 0;

    cart.forEach(c => {
        html += `<div>${c.qty}x ${c.name} (Size ${c.size}) — ${(c.price * c.qty).toLocaleString()}đ</div>`;
        total += c.price * c.qty;
    });

    document.getElementById("orderItems").innerHTML = html;
    document.getElementById("orderTotal").innerHTML = `Tổng: ${total.toLocaleString()}đ`;
}


// ============================
// 6. GỬI ORDER
// ============================
async function sendOrder() {

    if (cart.length === 0) return;

    const { error } = await db.from("web_orders").insert({
        table: tableNumber,
        items: cart,
        note: document.getElementById("note").value,
        status: "pending"
    });

    if (error) {
        document.getElementById("statusText").innerText = "Gửi order thất bại. Vui lòng thử lại.";
    } else {
        document.getElementById("statusText").innerText = "Đã gửi order thành công!";
        cart = [];
        updateUI();
    }
}

</script>
</body>
</html>
