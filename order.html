<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>QR Order – Tea Neko</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: radial-gradient(circle at top, #111827, #020617);
      color: #e5e7eb;
      padding: 16px;
    }
    .page {
      max-width: 480px;
      margin: 0 auto 40px auto;
    }
    .title {
      text-align: center;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 20px;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 12px;
    }
    .table-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #22c55e;
      color: #22c55e;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .menu-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 20px;
    }
    .item-box {
      background: #020617;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #111827;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }
    .item-img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
    }
    .item-body {
      padding: 10px 14px 12px 14px;
    }
    .item-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .item-price {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .size-note {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .qty-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 4px;
    }
    .qty-controls {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid #1f2937;
      overflow: hidden;
    }
    .qty-controls button {
      width: 36px;
      height: 32px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 18px;
      cursor: pointer;
    }
    .qty-controls span {
      width: 40px;
      text-align: center;
      font-size: 15px;
    }
    .size-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .size-btn {
      flex: 1;
      border-radius: 999px;
      padding: 6px 0;
      border: 1px solid #1f2937;
      font-size: 13px;
      text-align: center;
      cursor: pointer;
      background: #020617;
      color: #e5e7eb;
      transition: 0.15s;
    }
    .size-btn.active {
      background: #2563eb;
      border-color: #2563eb;
    }

    .card {
      background: #020617;
      border-radius: 18px;
      padding: 14px;
      border: 1px solid #111827;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      margin-bottom: 16px;
    }
    .card-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 16px;
    }
    .card-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    #order-summary div {
      font-size: 14px;
      margin-bottom: 4px;
    }
    .total-row {
      margin-top: 8px;
      font-weight: 600;
    }

    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 10px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }

    .btn-main {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 12px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
      cursor: pointer;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      color: #022c22;
      box-shadow: 0 15px 40px rgba(22,163,74,.4);
    }

    #status {
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
      color: #f97373;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="title">Tea Neko – Đặt món</div>
    <div class="subtitle">Chọn món rồi bấm gửi order, nhân viên sẽ xác nhận tại quầy.</div>
    <div id="tableInfo" class="table-pill"></div>

    <!-- Chọn size chung cho đơn -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="card-title">Chọn size mặc định</div>
      <div class="card-sub">Có thể mix size: chọn size rồi bấm + ở từng món.</div>
      <div class="size-row">
        <button id="btn-size-m" class="size-btn active">Size M</button>
        <button id="btn-size-l" class="size-btn">Size L (+5.000đ)</button>
      </div>
    </div>

    <!-- Danh sách món -->
    <div class="menu-list" id="menu-list"></div>

    <!-- Đơn của bạn -->
    <div id="cart-box" class="card" style="display:none;">
      <div class="card-title">Đơn của bạn</div>
      <div class="card-sub">Kiểm tra lại trước khi gửi đến quầy.</div>
      <div id="order-summary"></div>
      <div class="total-row">Tổng: <span id="order-total">0đ</span></div>
    </div>

    <!-- Ghi chú + gửi -->
    <div class="card">
      <div class="card-title">Ghi chú</div>
      <div class="card-sub">Ví dụ: ít đá, ít ngọt, không trân châu...</div>
      <textarea id="note" placeholder="Ghi chú cho quán..."></textarea>
      <button class="btn-main" onclick="sendOrder()">Gửi order đến Tea Neko</button>
      <div id="status"></div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://kcrchwedlrettpkucoct.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZi6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw"
    );

    // ===== MENU =====
    const MENU = [
      {
        id: 1,
        name: "Matcha Latte",
        priceM: 25000,
        priceL: 30000,
        img: "https://i.imgur.com/rkzQyDi.jpeg"
      },
      {
        id: 2,
        name: "Hồng trà sữa",
        priceM: 28000,
        priceL: 33000,
        img: "https://i.imgur.com/yFDRqVJ.jpeg"
      },
      {
        id: 3,
        name: "Bạc xỉu",
        priceM: 20000,
        priceL: 25000,
        img: "https://i.imgur.com/KdX1Q4W.jpeg"
      }
    ];

    // ===== STATE =====
    let orderItems = {};      // key: `${id}_${size}`
    let currentSize = "M";

    const menuListEl   = document.getElementById("menu-list");
    const cartBoxEl    = document.getElementById("cart-box");
    const orderSummary = document.getElementById("order-summary");
    const orderTotalEl = document.getElementById("order-total");
    const noteEl       = document.getElementById("note");
    const statusEl     = document.getElementById("status");
    const btnSizeM     = document.getElementById("btn-size-m");
    const btnSizeL     = document.getElementById("btn-size-l");
    const tableInfoEl  = document.getElementById("tableInfo");

    // Hiển thị số bàn từ URL
    const params = new URLSearchParams(window.location.search);
    const tableId = params.get("table") || "N/A";
    tableInfoEl.textContent = "Bàn " + tableId;

    // ===== RENDER MENU =====
    function loadMenuUI() {
      let html = "";
      MENU.forEach(item => {
        html += `
          <div class="item-box">
            <img src="${item.img}" class="item-img">
            <div class="item-body">
              <div class="item-name">${item.name}</div>
              <div class="item-price">${item.priceM.toLocaleString()}đ (Size M)</div>
              <div class="size-note">Theo size đang chọn</div>
              <div class="qty-row">
                <span style="font-size:13px;color:#9ca3af;">Số lượng</span>
                <div class="qty-controls">
                  <button onclick="changeQty(${item.id}, -1)">−</button>
                  <span id="qty-${item.id}">0</span>
                  <button onclick="changeQty(${item.id}, 1)">+</button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      menuListEl.innerHTML = html;
    }
    loadMenuUI();

    // ===== CHỌN SIZE =====
    btnSizeM.addEventListener("click", () => {
      currentSize = "M";
      btnSizeM.classList.add("active");
      btnSizeL.classList.remove("active");
      renderOrder();
    });

    btnSizeL.addEventListener("click", () => {
      currentSize = "L";
      btnSizeL.classList.add("active");
      btnSizeM.classList.remove("active");
      renderOrder();
    });

    // ===== THAY ĐỔI SỐ LƯỢNG =====
    function changeQty(id, delta) {
      const item = MENU.find(m => m.id === id);
      if (!item) return;

      const key = \`\${id}_\${currentSize}\`;

      if (!orderItems[key]) {
        orderItems[key] = { ...item, qty: 0, size: currentSize };
      }

      orderItems[key].qty += delta;
      if (orderItems[key].qty <= 0) {
        delete orderItems[key];
      }

      // Tổng qty của món này (cả M+L)
      const totalQtyForThisId = Object.values(orderItems)
        .filter(i => i.id === id)
        .reduce((s, i) => s + i.qty, 0);

      const span = document.getElementById("qty-" + id);
      if (span) span.textContent = totalQtyForThisId;

      renderOrder();
    }

    // ===== RENDER ĐƠN =====
    function renderOrder() {
      const items = Object.values(orderItems);
      if (items.length === 0) {
        cartBoxEl.style.display = "none";
        orderSummary.innerHTML = "";
        orderTotalEl.textContent = "0đ";
        return;
      }
      cartBoxEl.style.display = "block";

      let html = "";
      let total = 0;

      items.forEach(i => {
        const price = i.size === "M" ? i.priceM : i.priceL;
        const line  = price * i.qty;
        total += line;
        html += \`<div>\${i.qty}x \${i.name} (Size \${i.size}) — \${line.toLocaleString()}đ</div>\`;
      });

      orderSummary.innerHTML = html;
      orderTotalEl.textContent = total.toLocaleString() + "đ";
    }

    // ===== GỬI ORDER LÊN SUPABASE =====
    async function sendOrder() {
      const items = Object.values(orderItems).filter(i => i.qty > 0);
      if (items.length === 0) {
        alert("Bạn chưa chọn món nào.");
        return;
      }

      statusEl.style.color = "#f97373";
      statusEl.textContent = "Đang gửi order...";

      const total = items.reduce((s, i) => {
        const price = i.size === "M" ? i.priceM : i.priceL;
        return s + price * i.qty;
      }, 0);

      const note = noteEl.value.trim() || null;

      const payload = {
        table_id: tableId,
        items: items.map(i => ({
          id: i.id,
          name: i.name,
          size: i.size,
          qty: i.qty,
          priceM: i.priceM,
          priceL: i.priceL
        })),
        note,
        total,
        status: "pending"
      };

      const { error } = await supabase.from("web_orders").insert([payload]);

      if (error) {
        console.error(error);
        statusEl.style.color = "#f97373";
        statusEl.textContent = "Gửi order thất bại. Vui lòng thử lại.";
        return;
      }

      statusEl.style.color = "#4ade80";
      statusEl.textContent = "Đã gửi order thành công!";

      orderItems = {};
      MENU.forEach(i => {
        const span = document.getElementById("qty-" + i.id);
        if (span) span.textContent = "0";
      });
      noteEl.value = "";
      renderOrder();
    }

    // Gán cho window để dùng onclick trong HTML
    window.changeQty = changeQty;
    window.sendOrder = sendOrder;
  </script>
</body>
</html>
