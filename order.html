<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Menu đặt món • Tea Neko</title>

<style>
    body {
        margin: 0;
        background: #0b1220;
        font-family: system-ui, sans-serif;
        color: #fff;
    }
    .item {
        background: #101a30;
        border-radius: 14px;
        margin: 14px;
        padding: 14px;
    }
    .img {
        width: 100%;
        height: 220px;
        border-radius: 12px;
        object-fit: cover;
    }
    .btn {
        padding: 14px;
        text-align: center;
        border-radius: 14px;
        margin: 16px;
        font-weight: bold;
        font-size: 18px;
        background: #18ef72;
        color: #000;
    }
    .qty-box {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 8px;
        gap: 16px;
        font-size: 20px;
    }
    .qty-btn {
        width: 38px;
        height: 38px;
        background: #223;
        border-radius: 10px;
        font-size: 22px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #cart {
        background: #101a30;
        padding: 18px;
        border-radius: 14px;
        margin: 14px;
        margin-top: 28px;
    }
</style>

</head>
<body>

<h2 style="padding:16px;">Menu • Tea Neko</h2>

<div id="menu"></div>

<div id="cart" style="display:none;">
    <h3>Đơn của bạn</h3>
    <div id="cart-list"></div>
    <p><b>Tổng:</b> <span id="total">0</span>đ</p>
    <textarea id="note" placeholder="Ghi chú..." 
        style="width:100%;height:70px;border-radius:10px;padding:10px;background:#162038;color:#fff;"></textarea>

    <div class="btn" onclick="sendOrder()">Gửi order đến Tea Neko</div>
    <p id="status" style="color:#ff7b7b;"></p>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
    "https://kcrchwedlrettpkucoct.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjcmNod2VkbHJldHRwa3Vjb2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODQ0MjgsImV4cCI6MjA3OTQ2MDQyOH0.g4WA9tci2zm4MIa6EvOe6tH_EhaoicdrdiP6swgjRgw"
);

// -------------------- MENU --------------------
const MENU = [
    {
      id: "matcha",
      name: "Matcha Latte",
      price: 25000,
      img: "https://i.imgur.com/rkzQyDi.jpeg"
    },
    {
      id: "hongtra",
      name: "Hồng trà sữa",
      price: 28000,
      img: "https://i.imgur.com/yFDRqVJ.jpeg"
    },
    {
      id: "bacxiu",
      name: "Bạc xỉu",
      price: 20000,
      img: "https://i.imgur.com/KdX1Q4W.jpeg"
    }
];

// -------------------- CART --------------------
let cart = {};

function renderMenu() {
    let html = "";
    MENU.forEach(m => {
        html += `
        <div class="item">
            <img src="${m.img}" class="img">
            <h3>${m.name}</h3>
            <p>${m.price.toLocaleString()}đ (Size M)</p>
            <div class="qty-box">
                <div class="qty-btn" onclick="addQty('${m.id}', -1)">−</div>
                <div id="q_${m.id}">0</div>
                <div class="qty-btn" onclick="addQty('${m.id}', 1)">+</div>
            </div>
        </div>`;
    });
    document.getElementById("menu").innerHTML = html;
}
renderMenu();

function addQty(id, delta) {
    if (!cart[id]) cart[id] = { ...MENU.find(m => m.id === id), qty: 0 };

    cart[id].qty += delta;
    if (cart[id].qty < 0) cart[id].qty = 0;

    document.getElementById("q_" + id).textContent = cart[id].qty;
    renderCart();
}

function renderCart() {
    let list = "";
    let total = 0;
    let show = false;

    Object.values(cart).forEach(i => {
        if (i.qty > 0) {
            show = true;
            total += i.qty * i.price;
            list += `<p>${i.qty}x ${i.name} — ${(i.qty * i.price).toLocaleString()}đ</p>`;
        }
    });

    if (!show) {
        document.getElementById("cart").style.display = "none";
        return;
    }

    document.getElementById("cart-list").innerHTML = list;
    document.getElementById("total").textContent = total.toLocaleString();
    document.getElementById("cart").style.display = "block";
}

// -------------------- SEND ORDER --------------------
async function sendOrder() {
    const items = Object.values(cart).filter(i => i.qty > 0);
    if (items.length === 0) {
        alert("Bạn chưa chọn món nào!");
        return;
    }

    const table = new URLSearchParams(location.search).get("table") || "N/A";
    const note = document.getElementById("note").value;

    const total = items.reduce((s, i) => s + i.qty * i.price, 0);

    const { error } = await supabase.from("web_orders").insert([{
        table_id: table,
        items: items,
        note: note,
        total: total,
        status: "pending"
    }]);

    if (error) {
        document.getElementById("status").innerText = "Gửi order thất bại. Vui lòng thử lại.";
    } else {
        document.getElementById("status").style.color = "#00ff9c";
        document.getElementById("status").innerText = "Đã gửi order thành công!";
        cart = {};
        renderCart();
    }
}

window.addQty = addQty;
window.sendOrder = sendOrder;
</script>

</body>
</html>
